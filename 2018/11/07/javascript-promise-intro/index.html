<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>深入理解Javascript之Promise - 大俊的博客</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="darjun" />
  <meta name="description" content="1.概述 相信大家都听过Node中著名的回调地狱（callback hell)。因为Node中的操作默认都是异步执行的，所以需要调用者传入一个回" />

  <meta name="keywords" content="大俊, 大俊的博客, go, golang, gopher" />






<meta name="generator" content="Hugo 0.102.0-DEV" />


<link rel="canonical" href="https://darjun.github.io/2018/11/07/javascript-promise-intro/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.fa3d941d1d0e0ddc985804227feabffea55c89883eb0af34e0532a7ae9135151.css" integrity="sha256-&#43;j2UHR0ODdyYWAQif&#43;q//qVciYg&#43;sK804FMqeukTUVE=" media="screen" crossorigin="anonymous">




<link rel="stylesheet" href="/css/custom.css">


<meta property="og:title" content="深入理解Javascript之Promise" />
<meta property="og:description" content="1.概述 相信大家都听过Node中著名的回调地狱（callback hell)。因为Node中的操作默认都是异步执行的，所以需要调用者传入一个回" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://darjun.github.io/2018/11/07/javascript-promise-intro/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2018-11-08T23:44:00+00:00" />
<meta property="article:modified_time" content="2018-11-08T23:44:00+00:00" />

<meta itemprop="name" content="深入理解Javascript之Promise">
<meta itemprop="description" content="1.概述 相信大家都听过Node中著名的回调地狱（callback hell)。因为Node中的操作默认都是异步执行的，所以需要调用者传入一个回"><meta itemprop="datePublished" content="2018-11-08T23:44:00+00:00" />
<meta itemprop="dateModified" content="2018-11-08T23:44:00+00:00" />
<meta itemprop="wordCount" content="4356">
<meta itemprop="keywords" content="深入理解JavaScript," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="深入理解Javascript之Promise"/>
<meta name="twitter:description" content="1.概述 相信大家都听过Node中著名的回调地狱（callback hell)。因为Node中的操作默认都是异步执行的，所以需要调用者传入一个回"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-42862533-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">大俊</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/">首页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/post/">归档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/about/">关于我</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/darjun" rel="noopener" target="_blank">
              Github
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      大俊
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/">首页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/post/">归档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/about/">关于我</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/darjun" rel="noopener" target="_blank">
              Github
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">深入理解Javascript之Promise</h1>
      
      <div class="post-meta">
        <time datetime="2018-11-08" class="post-time">
          2018-11-08
        </time>
        <div class="post-category">
            <a href="https://darjun.github.io/categories/javascript/"> JavaScript </a>
            
          </div>
        <span class="more-meta"> 约 4356 字 </span>
          <span class="more-meta"> 预计阅读 9 分钟 </span>

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#span-id概述1概述span"><!-- raw HTML omitted -->1.概述<!-- raw HTML omitted --></a></li>
    <li><a href="#span-id基本用法2基本用法span"><!-- raw HTML omitted -->2.基本用法<!-- raw HTML omitted --></a>
      <ul>
        <li><a href="#span-id创建promise21-创建promise-span"><!-- raw HTML omitted -->2.1 创建<code>Promise</code> <!-- raw HTML omitted --></a></li>
        <li><a href="#span-idthen方法22-then方法span"><!-- raw HTML omitted -->2.2 <code>then</code>方法<!-- raw HTML omitted --></a></li>
        <li><a href="#span-idcatch方法23-catch方法span"><!-- raw HTML omitted -->2.3 <code>catch</code>方法<!-- raw HTML omitted --></a></li>
        <li><a href="#span-id其他创建promise的方式24-其他创建promise对象的方式span"><!-- raw HTML omitted -->2.4 其他创建<code>Promise</code>对象的方式<!-- raw HTML omitted --></a></li>
      </ul>
    </li>
    <li><a href="#span-id高级用法3高级用法span"><!-- raw HTML omitted -->3.高级用法<!-- raw HTML omitted --></a>
      <ul>
        <li><a href="#span-idflatten_promise31-flatten-promisespan"><!-- raw HTML omitted -->3.1 Flatten Promise<!-- raw HTML omitted --></a></li>
        <li><a href="#span-idpromise_all32-promiseall-方法span"><!-- raw HTML omitted -->3.2 Promise.all 方法<!-- raw HTML omitted --></a></li>
        <li><a href="#span-idpromiserace33-promiserace-方法span"><!-- raw HTML omitted -->3.3 Promise.race 方法<!-- raw HTML omitted --></a></li>
      </ul>
    </li>
    <li><a href="#span-id使用案例4使用案例span"><!-- raw HTML omitted -->4.使用案例<!-- raw HTML omitted --></a></li>
    <li><a href="#span-id总结5总结span"><!-- raw HTML omitted -->5.总结<!-- raw HTML omitted --></a></li>
    <li><a href="#span-id参考链接6参考链接span"><!-- raw HTML omitted -->6.参考链接<!-- raw HTML omitted --></a></li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <h2 id="span-id概述1概述span"><!-- raw HTML omitted -->1.概述<!-- raw HTML omitted --></h2>
<p>相信大家都听过Node中著名的回调地狱（callback hell)。因为Node中的操作默认都是异步执行的，所以需要调用者传入一个回调函数以便在操作结束时进行相应的处理。当回调的层次变多，代码就变得越来越难以编写、理解和阅读。</p>
<p><code>Promise</code>是ES6中新增的一种异步编程的方式，用于解决回调的方式的各种问题，提供了更多的可能性。其实早在ES6之前，社区就已经有多种<code>Promise</code>的实现方式了：</p>
<ul>
<li><a href="https://github.com/kriskowal/q">Q</a></li>
<li><a href="https://github.com/petkaantonov/bluebird">bludbird</a></li>
<li><a href="https://github.com/tildeio/rsvp.js/">RSVP</a></li>
</ul>
<p>以上几种<code>Promise</code>库都遵循<a href="https://promisesaplus.com/">Promise/A+</a>规范。ES6也采用了该规范，所以这些实现的API都是类似的，可以相互对照学习。</p>
<p><code>Promise</code>表示的是一个计算结果或网络请求的占位符。由于当前计算或网络请求尚未完成，所以结果暂时无法取得。</p>
<p><code>Promise</code>对象一共有3中状态，<code>pending</code>，<code>fullfilled</code>（又称为<code>resolved</code>）和<code>rejected</code>：</p>
<ul>
<li><code>pending</code>——任务仍在进行中。</li>
<li><code>resolved</code>——任务已完成。</li>
<li><code>reject</code>——任务出错。</li>
</ul>
<p><code>Promise</code>对象初始时处于<code>pending</code>状态，其生命周期内只可能发生以下一种状态转换：</p>
<ul>
<li>任务完成，状态由<code>pending</code>转换为<code>resolved</code>。</li>
<li>任务出错返回，状态由<code>pending</code>转换为<code>rejected</code>。</li>
</ul>
<p><code>Promise</code>对象的状态转换一旦发生，就不可再次更改。这或许就是<code>Promise</code>之“承诺”的含义吧。</p>
<h2 id="span-id基本用法2基本用法span"><!-- raw HTML omitted -->2.基本用法<!-- raw HTML omitted --></h2>
<h3 id="span-id创建promise21-创建promise-span"><!-- raw HTML omitted -->2.1 创建<code>Promise</code> <!-- raw HTML omitted --></h3>
<p><code>Javascript</code>提供了<code>Promise</code>构造函数用于创建<code>Promise</code>对象。格式如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">let p = new Promise(executor(resolve, reject));
</span></span></code></pre></td></tr></table>
</div>
</div><p>代码中<code>executor</code>是用户自定义的函数，用于实现具体异步操作流程。该函数有两个参数<code>resolve</code>和<code>reject</code>，它们是Javascript引擎提供的函数，不需要用户实现。在<code>executor</code>函数中，如果异步操作成功，则调用<code>resolve</code>将<code>Promise</code>的状态转换为<code>resolved</code>，<code>resolve</code>函数以结果数据作为参数。如果异步操作失败，则调用<code>reject</code>将<code>Promise</code>的状态转换为<code>rejected</code>，<code>reject</code>函数以具体错误对象作为参数。</p>
<h3 id="span-idthen方法22-then方法span"><!-- raw HTML omitted -->2.2 <code>then</code>方法<!-- raw HTML omitted --></h3>
<p><code>Promise</code>对象创建完成之后，我们需要调用<code>then(succ_handler, fail_handler)</code>方法指定成功和/或失败的回调处理。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">let p = new Promise(function(resolve, reject) {
</span></span><span class="line"><span class="cl">    resolve(&#34;finished&#34;);
</span></span><span class="line"><span class="cl">});
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">p.then(function (data) {
</span></span><span class="line"><span class="cl">    console.log(data); // 输出finished
</span></span><span class="line"><span class="cl">}, function (err) {
</span></span><span class="line"><span class="cl">    console.log(&#34;oh no, &#34;, err.message);
</span></span><span class="line"><span class="cl">});
</span></span></code></pre></td></tr></table>
</div>
</div><p>在上面的代码中，我们创建了一个<code>Promise</code>对象，在<code>executor</code>函数中调用<code>resolve</code>将该对象状态转换为<code>resolved</code>。</p>
<p>进而<code>then</code>指定的成功回调函数被调用，输出<code>finished</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">let p = new Promise(function(resolve, reject) {
</span></span><span class="line"><span class="cl">    reject(new Error(&#34;something be wrong&#34;));
</span></span><span class="line"><span class="cl">});
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">p.then(function (data) {
</span></span><span class="line"><span class="cl">    console.log(data);
</span></span><span class="line"><span class="cl">}, function (err) {
</span></span><span class="line"><span class="cl">    console.log(&#34;oh no, &#34;, err); // 输出oh no,  something be wrong
</span></span><span class="line"><span class="cl">});
</span></span></code></pre></td></tr></table>
</div>
</div><p>以上代码中，在<code>executor</code>函数中调用<code>reject</code>将<code>Promise</code>对象状态转换为<code>rejected</code>。</p>
<p>进而<code>then</code>指定的失败回调函数被调用，输出<code>oh no, something be wrong</code>。</p>
<p>这就是最基本的使用<code>Promise</code>编写异步处理的方式了。但是，有几点需要注意：</p>
<p>（1） <code>then</code>方法可以只传入成功或失败回调。</p>
<p>（2）<code>executor</code>函数是立即执行的，而成功或失败的回调函数会到当前<code>EventLoop</code>的最后再执行。下面的代码可以验证这一点：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">let p = new Promise(function(resolve, reject) {
</span></span><span class="line"><span class="cl">    console.log(&#34;promise constructor&#34;);
</span></span><span class="line"><span class="cl">    resolve(&#34;finished&#34;);
</span></span><span class="line"><span class="cl">});
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">p.then(function (data) {
</span></span><span class="line"><span class="cl">    console.log(data);
</span></span><span class="line"><span class="cl">});
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">console.log(&#34;end&#34;);
</span></span></code></pre></td></tr></table>
</div>
</div><p>输出结果为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">promise constructor
</span></span><span class="line"><span class="cl">end
</span></span><span class="line"><span class="cl">finished
</span></span></code></pre></td></tr></table>
</div>
</div><p>（3） <code>then</code>方法返回的是一个新的<code>Promise</code>对象，所以可以链式调用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">let p = new Promise(function(resolve) {
</span></span><span class="line"><span class="cl">    resolve(5);
</span></span><span class="line"><span class="cl">});
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">p.then(function (data) {
</span></span><span class="line"><span class="cl">    return data * 2;
</span></span><span class="line"><span class="cl">})
</span></span><span class="line"><span class="cl"> .then(function (data) {
</span></span><span class="line"><span class="cl">    console.log(data); // 输出10
</span></span><span class="line"><span class="cl">});
</span></span></code></pre></td></tr></table>
</div>
</div><p>（4）<code>Promise</code>对象的<code>then</code>方法可以被调用多次，而且可以被重复调用（不同于事件，同一个事件的回调只会被调用一次。）。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">let p = new Promise(function(resolve) {
</span></span><span class="line"><span class="cl">    resolve(&#34;repeat&#34;);
</span></span><span class="line"><span class="cl">});
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">p.then(function (data) {
</span></span><span class="line"><span class="cl">    console.log(data);
</span></span><span class="line"><span class="cl">});
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">p.then(function (data) {
</span></span><span class="line"><span class="cl">    console.log(data);
</span></span><span class="line"><span class="cl">});
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">p.then(function (data) {
</span></span><span class="line"><span class="cl">    console.log(data);
</span></span><span class="line"><span class="cl">});
</span></span></code></pre></td></tr></table>
</div>
</div><p>输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">repeat
</span></span><span class="line"><span class="cl">repeat
</span></span><span class="line"><span class="cl">repeat
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="span-idcatch方法23-catch方法span"><!-- raw HTML omitted -->2.3 <code>catch</code>方法<!-- raw HTML omitted --></h3>
<p>由前面的介绍，我们知道，可以由<code>then</code>方法指定错误处理。但是ES6提供了一个更好用的方法<code>catch</code>。直观上理解可以认为<code>catch(handler)</code>等同于<code>then(null, handler)</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">let p = new Promise(function(resolve, reject) {
</span></span><span class="line"><span class="cl">    reject(new Error(&#34;something be wrong&#34;));
</span></span><span class="line"><span class="cl">});
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">p.catch(function (err) {
</span></span><span class="line"><span class="cl">    console.log(&#34;oh no, &#34;, err.message); // 输出oh no, something be wrong
</span></span><span class="line"><span class="cl">});
</span></span></code></pre></td></tr></table>
</div>
</div><p>通常不建议在<code>then</code>方法中指定错误处理，而是在调用链的最后增加一个<code>catch</code>方法用于处理前面的步骤中出现的错误。</p>
<p>使用时注意一下几点：</p>
<ul>
<li>
<p><code>then</code>方法指定两个处理函数，<strong>调用成功处理函数抛出异常时，失败处理函数不会被调用</strong>。</p>
</li>
<li>
<p><code>Promise</code>中未被处理的异常不会终止当前的执行流程，也就是说<code>Promise</code>会**“吞掉异常”**。</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">let p = new Promise(function (resolve, reject) {
</span></span><span class="line"><span class="cl">    throw new Error(&#34;something be wrong&#34;);
</span></span><span class="line"><span class="cl">});
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">p.then(function (data) {
</span></span><span class="line"><span class="cl">    console.log(data);
</span></span><span class="line"><span class="cl">});
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">console.log(&#34;end&#34;);
</span></span><span class="line"><span class="cl">// 程序正常结束，输出end
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="span-id其他创建promise的方式24-其他创建promise对象的方式span"><!-- raw HTML omitted -->2.4 其他创建<code>Promise</code>对象的方式<!-- raw HTML omitted --></h3>
<p>除了<code>Promise</code>构造函数，ES6还提供了两个简单易用的创建<code>Promise</code>对象的方式，即<code>Promise.resolve</code>和<code>Promise.reject</code>。</p>
<h4 id="promiseresolve"><code>Promise.resolve</code></h4>
<p>顾名思义，<code>Promise.resolve</code>创建一个<code>resolved</code>状态的<code>Promise</code>对象：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">let p = Promise.resolve(&#34;hello&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">p.then(function (data) {
</span></span><span class="line"><span class="cl">    console.log(data); // 输出hello
</span></span><span class="line"><span class="cl">});
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>Promise.resolve</code>的参数分为以下几种类型：</p>
<p>（1）参数是一个<code>Promise</code>对象，那么直接返回该对象。</p>
<p>（2） 参数是一个<code>thenable</code>对象，即拥有<code>then</code>函数的对象。这时<code>Promise.resolve</code>会将该对象转换为一个<code>Promise</code>对象，并且立即执行其<code>then</code>函数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">let thenable = {
</span></span><span class="line"><span class="cl">    then: function (resolve, reject) {
</span></span><span class="line"><span class="cl">        resolve(25);
</span></span><span class="line"><span class="cl">    };
</span></span><span class="line"><span class="cl">};
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">let p = Promise.resolve(thenable);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">p.then(function (data) {
</span></span><span class="line"><span class="cl">    console.log(data); // 输出25
</span></span><span class="line"><span class="cl">});
</span></span></code></pre></td></tr></table>
</div>
</div><p>（3）其他参数（无参数相当于有一个undefined参数），创建一个状态为<code>resolved</code>的<code>Promise</code>对象，参数作为操作结果会传递给后续回调处理。</p>
<h4 id="promisereject"><code>Promise.reject</code></h4>
<p><code>Promise.reject</code>不管参数为何种类型，都是创建一个状态为<code>rejected</code>的<code>Promise</code>对象。</p>
<h2 id="span-id高级用法3高级用法span"><!-- raw HTML omitted -->3.高级用法<!-- raw HTML omitted --></h2>
<h3 id="span-idflatten_promise31-flatten-promisespan"><!-- raw HTML omitted -->3.1 Flatten Promise<!-- raw HTML omitted --></h3>
<p><code>then</code>方法的成功回调函数可以返回一个新的<code>Promise</code>对象，这时旧的<code>Promise</code>对象将会被冻结，其状态取决于新<code>Promise</code>对象的状态。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">let p1 = new Promise(function (resolve) {
</span></span><span class="line"><span class="cl">    setTimeout(function () {
</span></span><span class="line"><span class="cl">        resolve(&#34;promise1&#34;);
</span></span><span class="line"><span class="cl">    }, 3000);
</span></span><span class="line"><span class="cl">});
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">let p2 = new Promise(function (resolve) {
</span></span><span class="line"><span class="cl">    resolve(&#34;promise2&#34;);
</span></span><span class="line"><span class="cl">});
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">p2.then(function (data) {
</span></span><span class="line"><span class="cl">    return p1;  // (A)
</span></span><span class="line"><span class="cl">})
</span></span><span class="line"><span class="cl">  .then(function (data) { // (B)
</span></span><span class="line"><span class="cl">    console.log(data); // 输出promise2
</span></span><span class="line"><span class="cl">});
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们在(A)行直接返回了另一个<code>Promise</code>对象。后面的<code>then</code>方法执行取决于该对象的状态，所以在3s后输出<code>promise1</code>，不会输出<code>promise2</code>。</p>
<h3 id="span-idpromise_all32-promiseall-方法span"><!-- raw HTML omitted -->3.2 Promise.all 方法<!-- raw HTML omitted --></h3>
<p>很多时候，我们想要等待多个异步操作完成后再进行一些处理。如果使用回调的方式，会出现前面提到过的回调地狱。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">let fs = require(&#34;fs&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">fs.readFile(&#34;file1&#34;, &#34;utf8&#34;, function (data1, err1) {
</span></span><span class="line"><span class="cl">    if (err1 != nil) {
</span></span><span class="line"><span class="cl">        console.log(err1);
</span></span><span class="line"><span class="cl">        return;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    fs.readFile(&#34;file2&#34;, &#34;utf8&#34;, function (data2, err2) {
</span></span><span class="line"><span class="cl">        if (err2 != nil) {
</span></span><span class="line"><span class="cl">            console.log(err2);
</span></span><span class="line"><span class="cl">            return;
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        fs.readFile(&#34;file3&#34;, &#34;utf8&#34;, function (data3, err3) {
</span></span><span class="line"><span class="cl">            if (err3 != nil) {
</span></span><span class="line"><span class="cl">                console.log(err3);
</span></span><span class="line"><span class="cl">                return;
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            console.log(data1);
</span></span><span class="line"><span class="cl">            console.log(data2);
</span></span><span class="line"><span class="cl">            console.log(data3);
</span></span><span class="line"><span class="cl">        });
</span></span><span class="line"><span class="cl">    });
</span></span><span class="line"><span class="cl">});
</span></span></code></pre></td></tr></table>
</div>
</div><p>假设文件<code>file1</code>，<code>file2</code>，<code>file3</code>中的内容分别是&quot;in file1&quot;，&ldquo;in file2&rdquo;，&ldquo;in file3&rdquo;。那么输出如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">in file1
</span></span><span class="line"><span class="cl">in file2
</span></span><span class="line"><span class="cl">in file3
</span></span></code></pre></td></tr></table>
</div>
</div><p>这种情况下，<code>Promise.all</code>就派上大用场了。<code>Promise.all</code>接受一个可迭代对象（即ES6中的Iterable对象），每个元素通过调用<code>Promise.resolve</code>转换为<code>Promise</code>对象。<code>Promise.all</code>方法返回一个新的<code>Promise</code>对象。该对象在所有<code>Promise</code>对象状态变为<code>resolved</code>时，其状态才会转换为<code>resolved</code>，参数为各个<code>Promise</code>的结果组成的数组。只要有一个对象的状态变为<code>rejected</code>，新对象的状态就会转换为<code>rejected</code>。使用<code>Promise.all</code>我们可以很优雅的实现上面的功能：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">let fs = require(&#34;fs&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">let promise1 = new Promise(function (resolve, reject) {
</span></span><span class="line"><span class="cl">    fs.readFile(&#34;file1&#34;, &#34;utf8&#34;, function (err, data) {
</span></span><span class="line"><span class="cl">        if (err != null) {
</span></span><span class="line"><span class="cl">            reject(err);
</span></span><span class="line"><span class="cl">        } else {
</span></span><span class="line"><span class="cl">            resolve(data);
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">    });
</span></span><span class="line"><span class="cl">});
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">let promise2 = new Promise(function (resolve, reject) {
</span></span><span class="line"><span class="cl">    fs.readFile(&#34;file2&#34;, &#34;utf8&#34;, function (err, data) {
</span></span><span class="line"><span class="cl">        if (err != null) {
</span></span><span class="line"><span class="cl">            reject(err);
</span></span><span class="line"><span class="cl">        } else {
</span></span><span class="line"><span class="cl">            resolve(data);
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">    });
</span></span><span class="line"><span class="cl">});
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">let promise3 = new Promise(function (resolve, reject) {
</span></span><span class="line"><span class="cl">    fs.readFile(&#34;file3&#34;, &#34;utf8&#34;, function (err, data) {
</span></span><span class="line"><span class="cl">        if (err != null) {
</span></span><span class="line"><span class="cl">            reject(err);
</span></span><span class="line"><span class="cl">        } else {
</span></span><span class="line"><span class="cl">            resolve(data);
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">    });
</span></span><span class="line"><span class="cl">});
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">let p = Promise.all([promise1, promise2, promise3]);
</span></span><span class="line"><span class="cl">p.then(function (datas) {
</span></span><span class="line"><span class="cl">    console.log(datas);
</span></span><span class="line"><span class="cl">})
</span></span><span class="line"><span class="cl"> .catch(function (err) {
</span></span><span class="line"><span class="cl">    console.log(err);
</span></span><span class="line"><span class="cl">});
</span></span></code></pre></td></tr></table>
</div>
</div><p>输出如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[&#39;in file1&#39;, &#39;in file2&#39;, &#39;in file3&#39;]
</span></span></code></pre></td></tr></table>
</div>
</div><p>第二段代码我们可以进一步简化为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">let fs = require(&#34;fs&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">let myReadFile = function (filename) {
</span></span><span class="line"><span class="cl">    return new Promise(function (resolve, reject) {
</span></span><span class="line"><span class="cl">        fs.readFile(filename, &#34;utf8&#34;, function (err, data) {
</span></span><span class="line"><span class="cl">            if (err != null) {
</span></span><span class="line"><span class="cl">                reject(err);
</span></span><span class="line"><span class="cl">            } else {
</span></span><span class="line"><span class="cl">                resolve(data);
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">        });
</span></span><span class="line"><span class="cl">    });
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">let promise1 = myReadFile(&#34;file1&#34;);
</span></span><span class="line"><span class="cl">let promise2 = myReadFile(&#34;file2&#34;);
</span></span><span class="line"><span class="cl">let promise3 = myReadFile(&#34;file3&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">let p = Promise.all([promise1, promise2, promise3]);
</span></span><span class="line"><span class="cl">p.then(function (datas) {
</span></span><span class="line"><span class="cl">    console.log(datas);
</span></span><span class="line"><span class="cl">})
</span></span><span class="line"><span class="cl"> .catch(function (err) {
</span></span><span class="line"><span class="cl">    console.log(err);
</span></span><span class="line"><span class="cl">});
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="span-idpromiserace33-promiserace-方法span"><!-- raw HTML omitted -->3.3 Promise.race 方法<!-- raw HTML omitted --></h3>
<p><code>Promise.race</code>与<code>Promise.all</code>一样，接受一个可迭代对象作为参数，返回一个新的<code>Promise</code>对象。不同的是，只要参数中有一个<code>Promise</code>对象状态发生变化，新对象的状态就会变化。也就是说哪个操作快，就用哪个结果（或出错）。利用这种特性，我们可以实现超时处理：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">let p1 = new Promise(function (resolve, reject) {
</span></span><span class="line"><span class="cl">    setTimeout(function () {
</span></span><span class="line"><span class="cl">        reject(new Error(&#34;time out&#34;));
</span></span><span class="line"><span class="cl">    }, 1000);
</span></span><span class="line"><span class="cl">});
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">let p2 = new Promise(function (resolve, reject) {
</span></span><span class="line"><span class="cl">    // 模拟耗时操作
</span></span><span class="line"><span class="cl">    setTimeout(function () {
</span></span><span class="line"><span class="cl">        resolve(&#34;get result&#34;);
</span></span><span class="line"><span class="cl">    }, 2000);
</span></span><span class="line"><span class="cl">});
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">let p = Promise.race([p1, p2]);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">p.then(function (data) {
</span></span><span class="line"><span class="cl">    console.log(data);
</span></span><span class="line"><span class="cl">})
</span></span><span class="line"><span class="cl"> .catch(function (err) {
</span></span><span class="line"><span class="cl">    console.log(err);
</span></span><span class="line"><span class="cl">});
</span></span></code></pre></td></tr></table>
</div>
</div><p>对象<code>p1</code>在1s之后状态转换为<code>rejected</code>，<code>p2</code>在2s后转换为<code>resolved</code>。所以1s后，<code>p1</code>状态转换时，<code>p</code>的状态紧接着就转为<code>rejected</code>了。从而，输出为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">time out
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果将对象<code>p2</code>的延迟改为0.5s，那么在0.5s后<code>p2</code>状态改变时，<code>p</code>紧随其后状态转换为<code>resolved</code>。从而输出为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">get result
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="span-id使用案例4使用案例span"><!-- raw HTML omitted -->4.使用案例<!-- raw HTML omitted --></h2>
<p>前面我们提到过，<code>then</code>方法会返回一个新的<code>Promise</code>对象。所以<code>then</code>方法可以链式调用，前一个成功回调的返回值会作为下一个成功回调的参数。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">let p = new Promise(function (resolve, reject) {
</span></span><span class="line"><span class="cl">    resolve(25);
</span></span><span class="line"><span class="cl">});
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">p.then(function (num) { // (A)
</span></span><span class="line"><span class="cl">    return num + 1;
</span></span><span class="line"><span class="cl">})
</span></span><span class="line"><span class="cl"> .then(function (num) { // (B)
</span></span><span class="line"><span class="cl">    return num * 2;
</span></span><span class="line"><span class="cl">})
</span></span><span class="line"><span class="cl"> .then(function (num) { // (C)
</span></span><span class="line"><span class="cl">    console.log(num);
</span></span><span class="line"><span class="cl">});
</span></span></code></pre></td></tr></table>
</div>
</div><p>对象<code>p</code>状态变为<code>resolved</code>时，结果为<code>25</code>。行(A)处函数最先被调用，参数<code>num</code>的值为<code>25</code>，返回值为<code>26</code>。<code>26</code>又作为行(B)处函数的参数，函数返回<code>62</code>。<code>62</code>作为行(C)处函数的参数，被输出。</p>
<p>下面给出结合AJAX的一个案例。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">let getJSON = function (url) {
</span></span><span class="line"><span class="cl">    return new Promise(function (resolve, reject) {
</span></span><span class="line"><span class="cl">        let xhr = new XMLHttpRequest();
</span></span><span class="line"><span class="cl">        xhr.open(&#39;GET&#39;, url);
</span></span><span class="line"><span class="cl">        xhr.onreadystatechange = function () {
</span></span><span class="line"><span class="cl">            if (xhr.readyState !== 4) {
</span></span><span class="line"><span class="cl">                return;
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            if (xhr.status === 200) {
</span></span><span class="line"><span class="cl">                resolve(xhr.response);
</span></span><span class="line"><span class="cl">            } else {
</span></span><span class="line"><span class="cl">                reject(new Error(xhr.statusText));
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">        xhr.send();
</span></span><span class="line"><span class="cl">    });
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">getJSON(&#34;http://api.icndb.com/jokes/random&#34;)
</span></span><span class="line"><span class="cl"> .then(function (responseText) {
</span></span><span class="line"><span class="cl">    return JSON.parse(responseText);
</span></span><span class="line"><span class="cl">})
</span></span><span class="line"><span class="cl"> .then(function (obj) {
</span></span><span class="line"><span class="cl">    console.log(obj.value.joke);
</span></span><span class="line"><span class="cl">})
</span></span><span class="line"><span class="cl"> .catch(function (err) {
</span></span><span class="line"><span class="cl">    console.log(err.message);
</span></span><span class="line"><span class="cl">});
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>getJSON</code>函数接受一个<code>url</code>地址，请求json数据。但是请求到的数据是文本格式，所以在第一个<code>then</code>方法的回调中使用<code>JSON.parse</code>将其转为对象，第二个<code>then</code>方法回调再进行具体处理。</p>
<p><code>http://api.icndb.com/jokes/random</code>是一个随机笑话的api，大家可以试试 😄。</p>
<h2 id="span-id总结5总结span"><!-- raw HTML omitted -->5.总结<!-- raw HTML omitted --></h2>
<p><code>Promise</code>是ES6新增的一种异步编程的解决方案，使用它可以编写更优雅，更易读，更易维护的程序。<code>Promise</code>已经应用在各个角落了，个人认为掌握它是一个合格的Javascript开发者的基本功。</p>
<h2 id="span-id参考链接6参考链接span"><!-- raw HTML omitted -->6.参考链接<!-- raw HTML omitted --></h2>
<p><a href="https://developers.google.com/web/fundamentals/primers/promises">JavaScript Promise：简介</a></p>
<p><a href="https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/">Tasks, microtasks, queues and schedules</a></p>
<p><a href="https://medium.com/@pyrolistical/how-to-get-out-of-promise-hell-8c20e0ab0513#.2an1he6vf">How to escape Promise Hell</a></p>
<p><a href="https://www.sitepoint.com/overview-javascript-promises/">An Overview of JavaScript Promise</a></p>
<p><a href="https://www.datchley.name/es6-promises/">ES6 Promise</a>：Promise语法介绍</p>
<p><a href="http://es6.ruanyifeng.com/#docs/promise">Promise 对象</a>：阮一峰老师Promise对象详解</p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">darjun</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
      2018-11-08
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://darjun.github.io/tags/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3javascript/">深入理解JavaScript</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/2018/11/23/javascript-callstack-eventloop/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">深入理解Javascript之CallStack&amp;EventLoop</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/2018/05/24/redis-skiplist/">
            <span class="next-text nav-default">Redis源码阅读-skiplist</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "darjun/blog-comments"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  

    

  

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:leedarjun@gmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/darjun" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>


<a href="https://darjun.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
  
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2018 -
    2022
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        大俊
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.dee43230127a73d039a734510fa896c89c3c7ce0cf0be0c7a7433f8fd69b76dc.js" integrity="sha256-3uQyMBJ6c9A5pzRRD6iWyJw8fODPC&#43;DHp0M/j9abdtw=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>














</body>
</html>
