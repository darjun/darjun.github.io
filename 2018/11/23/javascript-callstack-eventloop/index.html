<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>深入理解Javascript之CallStack&amp;EventLoop - 大俊的博客</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="darjun" />
  <meta name="description" content="1.概述 众所周知，Javascript是一个单线程的语言。这意味着，在Javascript中，同一时间只能做一件事情。 这样的设计有一些优点，" />

  <meta name="keywords" content="大俊, 大俊的博客, go, golang, gopher" />






<meta name="generator" content="Hugo 0.102.0-DEV" />


<link rel="canonical" href="https://darjun.github.io/2018/11/23/javascript-callstack-eventloop/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.fa3d941d1d0e0ddc985804227feabffea55c89883eb0af34e0532a7ae9135151.css" integrity="sha256-&#43;j2UHR0ODdyYWAQif&#43;q//qVciYg&#43;sK804FMqeukTUVE=" media="screen" crossorigin="anonymous">




<link rel="stylesheet" href="/css/custom.css">


<meta property="og:title" content="深入理解Javascript之CallStack&amp;EventLoop" />
<meta property="og:description" content="1.概述 众所周知，Javascript是一个单线程的语言。这意味着，在Javascript中，同一时间只能做一件事情。 这样的设计有一些优点，" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://darjun.github.io/2018/11/23/javascript-callstack-eventloop/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2018-11-23T20:57:00+00:00" />
<meta property="article:modified_time" content="2018-11-23T20:57:00+00:00" />

<meta itemprop="name" content="深入理解Javascript之CallStack&amp;EventLoop">
<meta itemprop="description" content="1.概述 众所周知，Javascript是一个单线程的语言。这意味着，在Javascript中，同一时间只能做一件事情。 这样的设计有一些优点，"><meta itemprop="datePublished" content="2018-11-23T20:57:00+00:00" />
<meta itemprop="dateModified" content="2018-11-23T20:57:00+00:00" />
<meta itemprop="wordCount" content="8228">
<meta itemprop="keywords" content="深入理解JavaScript," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="深入理解Javascript之CallStack&amp;EventLoop"/>
<meta name="twitter:description" content="1.概述 众所周知，Javascript是一个单线程的语言。这意味着，在Javascript中，同一时间只能做一件事情。 这样的设计有一些优点，"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-42862533-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">大俊</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/">首页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/post/">归档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/about/">关于我</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/darjun" rel="noopener" target="_blank">
              Github
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      大俊
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/">首页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/post/">归档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/about/">关于我</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/darjun" rel="noopener" target="_blank">
              Github
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">深入理解Javascript之CallStack&amp;EventLoop</h1>
      
      <div class="post-meta">
        <time datetime="2018-11-23" class="post-time">
          2018-11-23
        </time>
        <div class="post-category">
            <a href="https://darjun.github.io/categories/javascript/"> JavaScript </a>
            
          </div>
        <span class="more-meta"> 约 8228 字 </span>
          <span class="more-meta"> 预计阅读 17 分钟 </span>

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#span-id概述1概述span"><!-- raw HTML omitted -->1.概述<!-- raw HTML omitted --></a></li>
    <li><a href="#span-idcallstack2调用栈span"><!-- raw HTML omitted -->2.调用栈<!-- raw HTML omitted --></a></li>
    <li><a href="#span-ideventloop3事件循环span"><!-- raw HTML omitted -->3.事件循环<!-- raw HTML omitted --></a></li>
    <li><a href="#span-idmicrotaskqueue4微任务队列span"><!-- raw HTML omitted -->4.微任务队列<!-- raw HTML omitted --></a></li>
    <li><a href="#span-id总结5总结span"><!-- raw HTML omitted -->5.总结<!-- raw HTML omitted --></a></li>
    <li><a href="#span-id参考链接6参考链接span"><!-- raw HTML omitted -->6.参考链接<!-- raw HTML omitted --></a></li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <h2 id="span-id概述1概述span"><!-- raw HTML omitted -->1.概述<!-- raw HTML omitted --></h2>
<p>众所周知，Javascript是一个单线程的语言。这意味着，在Javascript中，同一时间只能做一件事情。</p>
<p>这样的设计有一些优点，例如简单，避免了多线程中复杂的状态同步，写程序时不用考虑并发访问。但同时也带来了一些其他问题，其中比较突出的一个问题是：代码逻辑不直观。由于Javascript是单线程的，其中只有一个执行序列。所以，在执行异步操作（例如定时，网络请求这些不能立即完成的操作）时，Javascript运行时不可能在那里等着操作完成。否则整个运行时都被阻塞在那里了，导致其他所有的操作都无法进行，例如网页渲染，用户点击、滚动页面等操作。这样的用户体验是非常糟糕的。</p>
<p>正因为如此，Javascript使用回调函数处理异步操作结果。进行异步操作时传入一个回调，操作完成之后由Javascript引擎执行这个回调，将结果传入。慢慢地，Javascript中充斥着大量的回调。过多的使用回调让一段完整的逻辑被拆分成了很多片段，非常不利于阅读与维护。回调过多的问题在NodeJS中更为突出，故而出现了<code>Promise</code>（见我的前一篇<a href="https://darjun.github.io/2018/11/08/javascript-promise-intro">博客</a>）和<code>async/await</code>。</p>
<p>那么异步操作完成时，Javascript运行时是怎样感知到并调用对应的回调函数的呢？</p>
<p>答案是EventLoop（事件循环）。</p>
<p>要了解EventLoop是怎样运作的，我们首先需要了解Javascript是怎样处理一个个任务，调用一个个函数的。这就是CallStack（调用栈）所做的事。</p>
<h2 id="span-idcallstack2调用栈span"><!-- raw HTML omitted -->2.调用栈<!-- raw HTML omitted --></h2>
<p>相信有过其他语言编程经验的读者都听说过CallStack的概念。Javascript中的CallStack类似。</p>
<p>CallStack是一个栈结构，栈的特点是LIFO（后入先出），出栈入栈只会在一端（也就是栈顶）进行。</p>
<p>CallStack是用来处理函数调用与返回的。每次调用一个函数，Javascript运行时会生成一个新的调用结构压入CallStack。而函数调用结束返回时，JavaScript运行时会将栈顶的调用结构弹出。由于栈的LIFO特性，每次弹出的必然是最新调用的那个函数的结构。</p>
<p>Javascript启动时，从文件或标准输入加载程序。加载完成时，Javascript运行时会生成一个匿名的函数，函数体就是输入的代码。这个函数就有点类似于C/C++中的<code>main()</code>函数，是我们的入口函数。我们姑且称之为<code>&lt;main&gt;</code>函数。Javascript启动时，首先调用就是<code>&lt;main&gt;</code>函数。看下面代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">function func1() {
</span></span><span class="line"><span class="cl">    console.log(&#39;in function1&#39;);
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">function func2() {
</span></span><span class="line"><span class="cl">    func1();
</span></span><span class="line"><span class="cl">    console.log(&#39;in function2&#39;);
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">function func3() {
</span></span><span class="line"><span class="cl">    func2();
</span></span><span class="line"><span class="cl">    console.log(&#39;in function3&#39;);
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">func3();
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面代码很好理解，我们来看看Javascript是如何运行这段代码的。</p>
<p>Javascript首先加载代码，创建一个匿名<code>&lt;main&gt;</code>包裹这段代码并调用该函数。<code>&lt;main&gt;</code>函数执行，依次定义函数<code>func1</code>、<code>func2</code>、<code>func3</code>，然后调用函数<code>func3</code>。为<code>func3</code>创建调用结构并压栈。函数<code>func3</code>中调用<code>func2</code>，为<code>func2</code>创建调用结构并压栈。函数<code>func2</code>中调用<code>func1</code>，为<code>func1</code>创建调用结构并压栈。这个过程中，CallStack的变化如下。</p>
<p><img src="/img/in-post/callstack-eventloop/callstack-push.png" alt="Call Stack Push"></p>
<p>然后，函数<code>func1</code>执行完成，从栈顶弹出调用结构。然后<code>func2</code>继续执行，<code>func2</code>执行完成后从栈顶弹出其调用结构。然后<code>func3</code>继续执行，<code>func3</code>执行完成后从栈顶弹出其调用结构。这个过程中，CallStack的变化如下。</p>
<p><img src="/img/in-post/callstack-eventloop/callstack-pop.png" alt="Call Stack Pop"></p>
<p>当然，我这里有一个地方不太严谨。不知道读者有没有注意到，<code>console.log</code>也是函数函数哦。所以在<code>func1</code>中调用<code>console.log</code>时，CallStack上也会有对应的调用堆栈。<code>func2</code>，<code>func3</code>中的<code>console.log</code>调用同样如此。有兴趣的话，可以自己画一画完整的调用流程，这样可以加深理解😀。</p>
<p>这里我推荐大家使用Google Chrome的开发者工具来帮助我们理解CallStack。下图是上面代码在开发者工具中的一步步执行的结果：</p>
<p><img src="/img/in-post/callstack-eventloop/callstack-demo.gif" alt="Call Stack Demo"></p>
<ul>
<li>
<p>Chrome中<code>&lt;main&gt;</code>称为<code>&lt;anonymous&gt;</code>。</p>
</li>
<li>
<p>单步执行时，重点观察右侧工具栏中<strong>Call Stack</strong>一栏的变化。</p>
</li>
</ul>
<p>在CallStack中执行的函数，我们称之为一个task（任务）。</p>
<p>接下来，我们来思考这样一个问题：<code>setTimeout</code>、<code>setInterval</code>、<code>AJAX</code>请求这些功能是怎么实现的？</p>
<p>一位牛人<a href="https://twitter.com/philip_roberts">Philip Roberts</a>曾经将V8引擎（Chrome内置的Javascript引擎）源码下载下来，然后用<code>grep</code>查找，发现源码中并没有实现这些函数的代码😂。</p>
<p>那么这些函数到底是如何实现的，又是如何与Javascript引擎交互的呢？</p>
<p>答案是：宿主（网页中指的是浏览器，Node中指的是Node引擎）提供实现，并在操作完成时将结果（异步的，会有延迟）放入Javascript引擎的task队列，由Javascript引擎处理。</p>
<h2 id="span-ideventloop3事件循环span"><!-- raw HTML omitted -->3.事件循环<!-- raw HTML omitted --></h2>
<p>EventLoop顾名思义，其实就是Javascript引擎中的一个循环，它就是一个不停地从任务队列（task queue）中取出任务执行的过程。</p>
<p>我们前面详细了解了CallStack以及Javascript启动时是如何处理的。但是<code>&lt;main&gt;</code>退出后，Javascript引擎就没事做了吗？当然不是，有很多任务会不定时的触发需要Javascript引擎去处理。例如，用户点击按钮，定时器，页面渲染等。</p>
<p>其实，Javascript引擎中维护着一个任务队列。当CallStack中没有任务在执行时，引擎会从任务队列中取出任务压入CallStack处理。我们通过代码来具体看看（引用<a href="https://gist.github.com/jesstelford/9a35d20a2aa044df8bf241e00d7bc2d0">jesstelford</a>）：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">setTimeout(() =&gt; {
</span></span><span class="line"><span class="cl">    console.log(&#39;hi&#39;);
</span></span><span class="line"><span class="cl">}, 1000);
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们的Js代码，call stack，task queue和Web APIs（浏览器中实现）关系如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        [code]        |   [call stack]    | [task queue] | |    [Web APIs] |
</span></span><span class="line"><span class="cl">  --------------------|-------------------|--------------| |---------------|
</span></span><span class="line"><span class="cl">  setTimeout(() =&gt; {  |                   |              | |               |
</span></span><span class="line"><span class="cl">    console.log(&#39;hi&#39;) |                   |              | |               |
</span></span><span class="line"><span class="cl">  }, 1000)            |                   |              | |               |
</span></span><span class="line"><span class="cl">                      |                   |              | |               |
</span></span></code></pre></td></tr></table>
</div>
</div><p>开始时，代码未执行，所有都是空的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        [code]        |   [call stack]    | [task queue] | |   [Web APIs]  |
</span></span><span class="line"><span class="cl">  --------------------|-------------------|--------------| |---------------|
</span></span><span class="line"><span class="cl">  setTimeout(() =&gt; {  | &lt;main&gt;            |              | |               |
</span></span><span class="line"><span class="cl">    console.log(&#39;hi&#39;) |                   |              | |               |
</span></span><span class="line"><span class="cl">  }, 1000)            |                   |              | |               |
</span></span><span class="line"><span class="cl">                      |                   |              | |               |
</span></span></code></pre></td></tr></table>
</div>
</div><p>开始执行代码，压入我们的<code>&lt;main&gt;</code>函数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        [code]        |   [call stack]    | [task queue] | |   [Web APIs]  |
</span></span><span class="line"><span class="cl">  --------------------|-------------------|--------------| |---------------|
</span></span><span class="line"><span class="cl">&gt; setTimeout(() =&gt; {  | &lt;main&gt;            |              | |               |
</span></span><span class="line"><span class="cl">    console.log(&#39;hi&#39;) | setTimeout        |              | |               |
</span></span><span class="line"><span class="cl">  }, 1000)            |                   |              | |               |
</span></span><span class="line"><span class="cl">                      |                   |              | |               |
</span></span></code></pre></td></tr></table>
</div>
</div><p>执行第一行代码，调用函数<code>setTimeout</code>。我们前面说过，每个函数调用都会创建一个新的调用记录压到栈上。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        [code]        |   [call stack]    | [task queue] | |   [Web APIs]  |
</span></span><span class="line"><span class="cl">  --------------------|-------------------|--------------| |---------------|
</span></span><span class="line"><span class="cl">  setTimeout(() =&gt; {  | &lt;main&gt;            |              | | timeout, 1000 |
</span></span><span class="line"><span class="cl">    console.log(&#39;hi&#39;) |                   |              | |               |
</span></span><span class="line"><span class="cl">  }, 1000)            |                   |              | |               |
</span></span><span class="line"><span class="cl">                      |                   |              | |               |
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>setTimeout</code>执行完成，从栈中移除对应调用记录。<code>Web APIs</code>记录超时和回调，超时机制由浏览器实现。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        [code]        |   [call stack]    | [task queue] | |   [Web APIs]  |
</span></span><span class="line"><span class="cl">  --------------------|-------------------|--------------| |---------------|
</span></span><span class="line"><span class="cl">  setTimeout(() =&gt; {  |                   |              | | timeout, 1000 |
</span></span><span class="line"><span class="cl">    console.log(&#39;hi&#39;) |                   |              | |               |
</span></span><span class="line"><span class="cl">  }, 1000)            |                   |              | |               |
</span></span><span class="line"><span class="cl">                      |                   |              | |               |
</span></span></code></pre></td></tr></table>
</div>
</div><p>代码中没有其他逻辑，<code>&lt;main&gt;</code>函数结束，从栈移除调用信息。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        [code]        |   [call stack]    | [task queue] | |   [Web APIs]  |
</span></span><span class="line"><span class="cl">  --------------------|-------------------|--------------| |---------------|
</span></span><span class="line"><span class="cl">  setTimeout(() =&gt; {  |                   | function   &lt;-----timeout, 1000 |
</span></span><span class="line"><span class="cl">    console.log(&#39;hi&#39;) |                   |              | |               |
</span></span><span class="line"><span class="cl">  }, 1000)            |                   |              | |               |
</span></span><span class="line"><span class="cl">                      |                   |              | |               |
</span></span></code></pre></td></tr></table>
</div>
</div><p>超时时间到了，<code>Web APIs</code>将回调放入task queue中。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        [code]        |   [call stack]    | [task queue] | |   [Web APIs]  |
</span></span><span class="line"><span class="cl">  --------------------|-------------------|--------------| |---------------|
</span></span><span class="line"><span class="cl">  setTimeout(() =&gt; {  | function        &lt;---function     | |               |
</span></span><span class="line"><span class="cl">    console.log(&#39;hi&#39;) |                   |              | |               |
</span></span><span class="line"><span class="cl">  }, 1000)            |                   |              | |               |
</span></span><span class="line"><span class="cl">                      |                   |              | |               |
</span></span></code></pre></td></tr></table>
</div>
</div><p>EventLoop检测到Javascript没有任务处理，从task queue中取出任务执行。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        [code]        |   [call stack]    | [task queue] | |   [Web APIs]  |
</span></span><span class="line"><span class="cl">  --------------------|-------------------|--------------| |---------------|
</span></span><span class="line"><span class="cl">  setTimeout(() =&gt; {  | function          |              | |               |
</span></span><span class="line"><span class="cl">&gt;   console.log(&#39;hi&#39;) | console.log       |              | |               |
</span></span><span class="line"><span class="cl">  }, 1000)            |                   |              | |               |
</span></span><span class="line"><span class="cl">                      |                   |              | |               |
</span></span></code></pre></td></tr></table>
</div>
</div><p>执行该回调函数，回调函数中又调用了<code>console.log</code>函数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        [code]        |   [call stack]    | [task queue] | |   [Web APIs]  |
</span></span><span class="line"><span class="cl">  --------------------|-------------------|--------------| |---------------|
</span></span><span class="line"><span class="cl">  setTimeout(() =&gt; {  | function          |              | |               |
</span></span><span class="line"><span class="cl">    console.log(&#39;hi&#39;) |                   |              | |               |
</span></span><span class="line"><span class="cl">  }, 1000)            |                   |              | |               |
</span></span><span class="line"><span class="cl">                      |                   |              | |               |
</span></span><span class="line"><span class="cl">&gt; hi
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>console.log</code>执行完成，输出&quot;hi&quot;。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        [code]        |   [call stack]    | [task queue] | |   [Web APIs]  |
</span></span><span class="line"><span class="cl">  --------------------|-------------------|--------------| |---------------|
</span></span><span class="line"><span class="cl">  setTimeout(() =&gt; {  |                   |              | |               |
</span></span><span class="line"><span class="cl">    console.log(&#39;hi&#39;) |                   |              | |               |
</span></span><span class="line"><span class="cl">  }, 1000)            |                   |              | |               |
</span></span><span class="line"><span class="cl">                      |                   |              | |               |
</span></span><span class="line"><span class="cl">&gt; hi
</span></span></code></pre></td></tr></table>
</div>
</div><p>回调函数执行完成，CallStack再次为空。</p>
<p>上面就是<code>setTimeout</code>的执行过程，从中开始看出EventLoop在幕后做的工作。</p>
<p>下面我们再来看一段代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">console.log(&#34;start&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">setTimeout(() =&gt; {
</span></span><span class="line"><span class="cl">    console.log(&#34;timeout&#34;);
</span></span><span class="line"><span class="cl">}, 0);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Promise.resolve()
</span></span><span class="line"><span class="cl">  .then(() =&gt; {
</span></span><span class="line"><span class="cl">      console.log(&#34;promise1&#34;);
</span></span><span class="line"><span class="cl">  })
</span></span><span class="line"><span class="cl">  .then(() =&gt; {
</span></span><span class="line"><span class="cl">      console.log(&#34;promise2&#34;);
</span></span><span class="line"><span class="cl">  });
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">console.log(&#34;end&#34;);
</span></span></code></pre></td></tr></table>
</div>
</div><p>这段程序的输出是什么？建议大家先思考一下，最好能动笔画一画图😎。</p>
<h2 id="span-idmicrotaskqueue4微任务队列span"><!-- raw HTML omitted -->4.微任务队列<!-- raw HTML omitted --></h2>
<p>接着上一节的代码，<strong>符合标准</strong>（很多旧版本的浏览器实现都是不符合标准的，具体参见参考链接）的输出应该是：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">start
</span></span><span class="line"><span class="cl">end
</span></span><span class="line"><span class="cl">promise1
</span></span><span class="line"><span class="cl">promise2
</span></span><span class="line"><span class="cl">timeout
</span></span></code></pre></td></tr></table>
</div>
</div><p>但是，为？什？么？</p>
<p>实际上，Javascript中有另外一种队列。<code>Promise</code>的回调是被放入这个队列的。这个队列叫做<strong>microtask queue</strong>（微任务队列），ES6标准中叫<a href="http://www.ecma-international.org/ecma-262/6.0/#sec-jobs-and-job-queues">Job Queue</a>。microTask的优先级是比task高的，也就是说microtask队列中的任务要先处理。</p>
<ul>
<li>
<p>EventLoop检测到当前没有任务在执行，首先检查microtask队列中有没有需要处理的任务。如果有那么一个个执行，直到microtask队列为空。</p>
</li>
<li>
<p>microtask队列中没有任务了，执行task队列中的任务。这里需要注意，**每执行一个task队列中的任务，就检查一下microtask队列状态。将microtask队列中所有任务都执行完成之后，再从task队列中取出任务执行。</p>
</li>
</ul>
<p>下面我们看看上面那段代码是怎么一步步执行的：</p>
<p>（<strong>为方便起见我们称<code>setTimeout</code>回调为<code>timeoutcb</code>，称第一个<code>then</code>成功回调为<code>promisecb1</code>，第二个<code>then</code>回调为<code>promisecb2</code></strong>）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        [code]                    |   [call stack]    | [task queue] | | [microtask queue] | |   [Web APIs]  |
</span></span><span class="line"><span class="cl">  --------------------------------|-------------------|--------------| |-------------------| |---------------|
</span></span><span class="line"><span class="cl">  1. console.log(&#34;start&#34;);        |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  2.                              |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  3. setTimeout(() =&gt; {           |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  4.     console.log(&#34;timeout&#34;);  |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  5. }, 0);                       |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  6.                              |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  7. Promise.resolve()            |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  8. .then(() =&gt; {                |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  9.     console.log(&#34;promise1&#34;); |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  10.})                           |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  11..then(() =&gt; {                |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  12.    console.log(&#34;promise2&#34;); |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  13.});                          |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  14.                             |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  15.console.log(&#34;end&#34;);          |                   |              | |                   | |               |
</span></span></code></pre></td></tr></table>
</div>
</div><p>开始时，call stack、task queue、microtask queue都为空。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        [code]                     |   [call stack]    | [task queue] | | [microtask queue] | |   [Web APIs]  |
</span></span><span class="line"><span class="cl">  ---------------------------------|-------------------|--------------| |-------------------| |---------------|
</span></span><span class="line"><span class="cl">&gt; 1. console.log(&#34;start&#34;);         |     &lt;main&gt;        |              | |                   | |               |
</span></span><span class="line"><span class="cl">  2.                               |     console.log   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  3. setTimeout(() =&gt; {            |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  4.     console.log(&#34;timeout&#34;);   |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  5. }, 0);                        |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  6.                               |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  7. Promise.resolve()             |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  8.  .then(() =&gt; {                |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  9.     console.log(&#34;promise1&#34;);  |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  10. })                           |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  11. .then(() =&gt; {                |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  12.    console.log(&#34;promise2&#34;);  |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  13. });                          |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  14.                              |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  15. console.log(&#34;end&#34;);          |                   |              | |                   | |               |
</span></span></code></pre></td></tr></table>
</div>
</div><p>程序开始运行，压入<code>&lt;main&gt;</code>函数。首先执行第一行代码，<code>console.log(&quot;start&quot;)</code>，将<code>console.log</code>压栈。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        [code]                     |   [call stack]    | [task queue] | | [microtask queue] | |   [Web APIs]  |
</span></span><span class="line"><span class="cl">  ---------------------------------|-------------------|--------------| |-------------------| |---------------|
</span></span><span class="line"><span class="cl">&gt; 1. console.log(&#34;start&#34;);         |     &lt;main&gt;        |              | |                   | |               |
</span></span><span class="line"><span class="cl">  2.                               |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  3. setTimeout(() =&gt; {            |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  4.     console.log(&#34;timeout&#34;);   |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  5. }, 0);                        |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  6.                               |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  7. Promise.resolve()             |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  8.  .then(() =&gt; {                |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  9.     console.log(&#34;promise1&#34;);  |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  10. })                           |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  11. .then(() =&gt; {                |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  12.    console.log(&#34;promise2&#34;);  |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  13. });                          |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  14.                              |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  15. console.log(&#34;end&#34;);          |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">&gt; start
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>console.log</code>执行完成，输出&quot;start&quot;。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        [code]                     |   [call stack]    | [task queue] | | [microtask queue] | |   [Web APIs]  |
</span></span><span class="line"><span class="cl">  ---------------------------------|-------------------|--------------| |-------------------| |---------------|
</span></span><span class="line"><span class="cl">  1. console.log(&#34;start&#34;);         |    &lt;main&gt;         |              | |                   | |               |
</span></span><span class="line"><span class="cl">  2.                               |    setTimeout     |              | |                   | |               |
</span></span><span class="line"><span class="cl">&gt; 3. setTimeout(() =&gt; {            |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  4.     console.log(&#34;timeout&#34;);   |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  5. }, 0);                        |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  6.                               |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  7. Promise.resolve()             |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  8.  .then(() =&gt; {                |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  9.     console.log(&#34;promise1&#34;);  |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  10. })                           |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  11. .then(() =&gt; {                |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  12.    console.log(&#34;promise2&#34;);  |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  13. });                          |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  14.                              |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  15. console.log(&#34;end&#34;);          |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">&gt; start
</span></span></code></pre></td></tr></table>
</div>
</div><p>第二行为空跳过，开始执行第三行代码，<code>setTimeout</code>压栈。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        [code]                     |   [call stack]    | [task queue] | | [microtask queue] | |   [Web APIs]  |
</span></span><span class="line"><span class="cl">  ---------------------------------|-------------------|--------------| |-------------------| |---------------|
</span></span><span class="line"><span class="cl">  1. console.log(&#34;start&#34;);         |    &lt;main&gt;         |   timeoutcb &lt;------------------------~~timeoutcb, 0~~|
</span></span><span class="line"><span class="cl">  2.                               |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">&gt; 3. setTimeout(() =&gt; {            |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  4.     console.log(&#34;timeout&#34;);   |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  5. }, 0);                        |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  6.                               |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  7. Promise.resolve()             |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  8.  .then(() =&gt; {                |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  9.     console.log(&#34;promise1&#34;);  |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  10. })                           |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  11. .then(() =&gt; {                |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  12.    console.log(&#34;promise2&#34;);  |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  13. });                          |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  14.                              |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  15. console.log(&#34;end&#34;);          |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">&gt; start
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>setTimeout</code>执行完成，由于超时是0，所以立即回调立即进入task queue中。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        [code]                     |   [call stack]    | [task queue] | | [microtask queue] | |   [Web APIs]  |
</span></span><span class="line"><span class="cl">  ---------------------------------|-------------------|--------------| |-------------------| |---------------|
</span></span><span class="line"><span class="cl">  1. console.log(&#34;start&#34;);         |    &lt;main&gt;         |  timeoutcb   | |     promisecb1    | |               |
</span></span><span class="line"><span class="cl">  2.                               |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  3. setTimeout(() =&gt; {            |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  4.     console.log(&#34;timeout&#34;);   |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  5. }, 0);                        |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  6.                               |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">&gt; 7. Promise.resolve()             |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  8.  .then(() =&gt; {                |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  9.     console.log(&#34;promise1&#34;);  |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  10. })                           |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  11. .then(() =&gt; {                |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  12.    console.log(&#34;promise2&#34;);  |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  13. });                          |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  14.                              |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  15. console.log(&#34;end&#34;);          |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">&gt; start
</span></span></code></pre></td></tr></table>
</div>
</div><p>代码执行到第7行：</p>
<ul>
<li>
<p>首先<code>Promise.resolve</code>压栈，执行完成后返回一个<code>Promise</code>对象。</p>
</li>
<li>
<p>然后调用该对象的<code>then</code>方法，该方法压栈，执行完成后返回一个全新的<code>Promise</code>对象，我们称该对象为<strong>promise1</strong>。由于<code>Promise.resolve</code>返回对象的状态为<code>resolved</code>，所以<code>promise1</code>回调直接<strong>进入microtask队列</strong>。</p>
</li>
<li>
<p>接着又执行新对象的<code>then</code>方法，我们称该对象为<strong>promise2</strong>。</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        [code]                     |   [call stack]    | [task queue] | | [microtask queue] | |   [Web APIs]  |
</span></span><span class="line"><span class="cl">  ---------------------------------|-------------------|--------------| |-------------------| |---------------|
</span></span><span class="line"><span class="cl">  1. console.log(&#34;start&#34;);         |    &lt;main&gt;         |    timeout   | |     promisecb1    | |               |
</span></span><span class="line"><span class="cl">  2.                               |    console.log    |              | |                   | |               |
</span></span><span class="line"><span class="cl">  3. setTimeout(() =&gt; {            |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  4.     console.log(&#34;timeout&#34;);   |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  5. }, 0);                        |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  6.                               |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  7. Promise.resolve()             |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  8.  .then(() =&gt; {                |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  9.     console.log(&#34;promise1&#34;);  |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  10. })                           |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  11. .then(() =&gt; {                |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  12.    console.log(&#34;promise2&#34;);  |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  13. });                          |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  14.                              |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">&gt; 15. console.log(&#34;end&#34;);          |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">&gt; start
</span></span></code></pre></td></tr></table>
</div>
</div><p>代码执行到第15行，<code>console.log</code>压栈。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        [code]                     |   [call stack]    | [task queue] | | [microtask queue] | |   [Web APIs]  |
</span></span><span class="line"><span class="cl">  ---------------------------------|-------------------|--------------| |-------------------| |---------------|
</span></span><span class="line"><span class="cl">  1. console.log(&#34;start&#34;);         |    &lt;main&gt;         |    timeout   | |     promisecb1    | |               |
</span></span><span class="line"><span class="cl">  2.                               |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  3. setTimeout(() =&gt; {            |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  4.     console.log(&#34;timeout&#34;);   |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  5. }, 0);                        |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  6.                               |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  7. Promise.resolve()             |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  8.  .then(() =&gt; {                |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  9.     console.log(&#34;promise1&#34;);  |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  10. })                           |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  11. .then(() =&gt; {                |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  12.    console.log(&#34;promise2&#34;);  |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  13. });                          |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  14.                              |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">&gt; 15. console.log(&#34;end&#34;);          |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">&gt; start
</span></span><span class="line"><span class="cl">&gt; end
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>console.log(&quot;end&quot;)</code>执行完成，输出&quot;end&quot;，出栈。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        [code]                     |   [call stack]    | [task queue] | | [microtask queue] | |   [Web APIs]  |
</span></span><span class="line"><span class="cl">  ---------------------------------|-------------------|--------------| |-------------------| |---------------|
</span></span><span class="line"><span class="cl">  1. console.log(&#34;start&#34;);         |                   |    timeout   | |     promisecb1    | |               |
</span></span><span class="line"><span class="cl">  2.                               |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  3. setTimeout(() =&gt; {            |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  4.     console.log(&#34;timeout&#34;);   |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  5. }, 0);                        |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  6.                               |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  7. Promise.resolve()             |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  8.  .then(() =&gt; {                |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  9.     console.log(&#34;promise1&#34;);  |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  10. })                           |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  11. .then(() =&gt; {                |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  12.    console.log(&#34;promise2&#34;);  |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  13. });                          |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  14.                              |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">&gt; 15. console.log(&#34;end&#34;);          |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">&gt; start
</span></span><span class="line"><span class="cl">&gt; end
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>&lt;main&gt;</code>函数没有逻辑需要执行了，出栈。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        [code]                     |   [call stack]    | [task queue] | | [microtask queue] | |   [Web APIs]  |
</span></span><span class="line"><span class="cl">  ---------------------------------|-------------------|--------------| |-------------------| |---------------|
</span></span><span class="line"><span class="cl">  1. console.log(&#34;start&#34;);         |    promisecb1     |    timeout   | |                   | |               |
</span></span><span class="line"><span class="cl">  2.                               |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  3. setTimeout(() =&gt; {            |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  4.     console.log(&#34;timeout&#34;);   |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  5. }, 0);                        |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  6.                               |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  7. Promise.resolve()             |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  8.  .then(() =&gt; {                |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  9.     console.log(&#34;promise1&#34;);  |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  10. })                           |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  11. .then(() =&gt; {                |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  12.    console.log(&#34;promise2&#34;);  |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  13. });                          |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  14.                              |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">&gt; 15. console.log(&#34;end&#34;);          |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">&gt; start
</span></span><span class="line"><span class="cl">&gt; end
</span></span></code></pre></td></tr></table>
</div>
</div><p>EventLoop检查到microtask队列中有任务需要执行，将<code>promisecb1</code>取出压入call stack。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        [code]                     |   [call stack]    | [task queue] | | [microtask queue] | |   [Web APIs]  |
</span></span><span class="line"><span class="cl">  ---------------------------------|-------------------|--------------| |-------------------| |---------------|
</span></span><span class="line"><span class="cl">  1. console.log(&#34;start&#34;);         |                   |    timeout   | |      promisecb2   | |               |
</span></span><span class="line"><span class="cl">  2.                               |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  3. setTimeout(() =&gt; {            |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  4.     console.log(&#34;timeout&#34;);   |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  5. }, 0);                        |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  6.                               |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  7. Promise.resolve()             |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  8.  .then(() =&gt; {                |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  9.     console.log(&#34;promise1&#34;);  |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  10. })                           |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  11. .then(() =&gt; {                |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  12.    console.log(&#34;promise2&#34;);  |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  13. });                          |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  14.                              |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  15. console.log(&#34;end&#34;);          |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">&gt; start
</span></span><span class="line"><span class="cl">&gt; end
</span></span><span class="line"><span class="cl">&gt; promise1
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>promisecb1</code>执行完成，输出&quot;promise1&quot;，并且返回<code>undefined</code>。（其实在这里还有一个<code>console.log</code>压栈出栈的过程，我就不画了，下同）</p>
<p>在<a href="https://darjun.github.io/2018/11/08/javascript-promise-intro">深入理解Javascript之Promise</a>中看到，如果返回一个值，那么对象立刻变为<code>resolved</code>。<strong>所以第二个<code>then</code>的回调需要安排执行，进入microtask队列</strong>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        [code]                     |   [call stack]    | [task queue] | | [microtask queue] | |   [Web APIs]  |
</span></span><span class="line"><span class="cl">  ---------------------------------|-------------------|--------------| |-------------------| |---------------|
</span></span><span class="line"><span class="cl">  1. console.log(&#34;start&#34;);         |     promisecb2    |    timeout   | |                   | |               |
</span></span><span class="line"><span class="cl">  2.                               |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  3. setTimeout(() =&gt; {            |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  4.     console.log(&#34;timeout&#34;);   |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  5. }, 0);                        |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  6.                               |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  7. Promise.resolve()             |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  8.  .then(() =&gt; {                |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  9.     console.log(&#34;promise1&#34;);  |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  10. })                           |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  11. .then(() =&gt; {                |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  12.    console.log(&#34;promise2&#34;);  |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  13. });                          |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  14.                              |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  15. console.log(&#34;end&#34;);          |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">&gt; start
</span></span><span class="line"><span class="cl">&gt; end
</span></span><span class="line"><span class="cl">&gt; promise1
</span></span></code></pre></td></tr></table>
</div>
</div><p>EventLoop检测到call stack中没有正在执行的任务，同时microtask队列不为空。从microtask队列取出任务压入call stack。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        [code]                     |   [call stack]    | [task queue] | | [microtask queue] | |   [Web APIs]  |
</span></span><span class="line"><span class="cl">  ---------------------------------|-------------------|--------------| |-------------------| |---------------|
</span></span><span class="line"><span class="cl">  1. console.log(&#34;start&#34;);         |                   |    timeout   | |                   | |               |
</span></span><span class="line"><span class="cl">  2.                               |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  3. setTimeout(() =&gt; {            |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  4.     console.log(&#34;timeout&#34;);   |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  5. }, 0);                        |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  6.                               |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  7. Promise.resolve()             |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  8.  .then(() =&gt; {                |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  9.     console.log(&#34;promise1&#34;);  |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  10. })                           |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  11. .then(() =&gt; {                |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  12.    console.log(&#34;promise2&#34;);  |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  13. });                          |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  14.                              |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  15. console.log(&#34;end&#34;);          |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">&gt; start
</span></span><span class="line"><span class="cl">&gt; end
</span></span><span class="line"><span class="cl">&gt; promise1
</span></span><span class="line"><span class="cl">&gt; promise2
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>promisecb2</code>执行完成，输出&quot;promise2&quot;。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        [code]                     |   [call stack]    | [task queue] | | [microtask queue] | |   [Web APIs]  |
</span></span><span class="line"><span class="cl">  ---------------------------------|-------------------|--------------| |-------------------| |---------------|
</span></span><span class="line"><span class="cl">  1. console.log(&#34;start&#34;);         |    timeoutcb      |              | |                   | |               |
</span></span><span class="line"><span class="cl">  2.                               |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  3. setTimeout(() =&gt; {            |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  4.     console.log(&#34;timeout&#34;);   |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  5. }, 0);                        |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  6.                               |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  7. Promise.resolve()             |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  8.  .then(() =&gt; {                |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  9.     console.log(&#34;promise1&#34;);  |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  10. })                           |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  11. .then(() =&gt; {                |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  12.    console.log(&#34;promise2&#34;);  |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  13. });                          |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  14.                              |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  15. console.log(&#34;end&#34;);          |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">&gt; start
</span></span><span class="line"><span class="cl">&gt; end
</span></span><span class="line"><span class="cl">&gt; promise1
</span></span><span class="line"><span class="cl">&gt; promise2
</span></span></code></pre></td></tr></table>
</div>
</div><p>接着,EventLoop检测到call stack和microtask队列都为空，从task队列中取出<code>timeoutcb</code>压入栈。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        [code]                     |   [call stack]    | [task queue] | | [microtask queue] | |   [Web APIs]  |
</span></span><span class="line"><span class="cl">  ---------------------------------|-------------------|--------------| |-------------------| |---------------|
</span></span><span class="line"><span class="cl">  1. console.log(&#34;start&#34;);         |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  2.                               |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  3. setTimeout(() =&gt; {            |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  4.     console.log(&#34;timeout&#34;);   |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  5. }, 0);                        |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  6.                               |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  7. Promise.resolve()             |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  8.  .then(() =&gt; {                |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  9.     console.log(&#34;promise1&#34;);  |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  10. })                           |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  11. .then(() =&gt; {                |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  12.    console.log(&#34;promise2&#34;);  |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  13. });                          |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  14.                              |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">  15. console.log(&#34;end&#34;);          |                   |              | |                   | |               |
</span></span><span class="line"><span class="cl">&gt; start
</span></span><span class="line"><span class="cl">&gt; end
</span></span><span class="line"><span class="cl">&gt; promise1
</span></span><span class="line"><span class="cl">&gt; promise2
</span></span><span class="line"><span class="cl">&gt; timeout
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>timeoutcb</code>执行完成，输出&quot;timeout&quot;。</p>
<h2 id="span-id总结5总结span"><!-- raw HTML omitted -->5.总结<!-- raw HTML omitted --></h2>
<p>通过这篇文章，我们了解到Javascript时如何通过call stack来处理函数的调用与返回的。<code>setTimeout</code>等异步机制其实是宿主提供实现，并在异步操作完成负责将回调放入任务队列，最后由EventLoop在适合的时机取出压入call stack实际执行。</p>
<p>我们还看到了另外一种队列——microtask队列。该队列中存放的一般是优先级较高的任务，例如<code>Promise</code>的回调处理函数。</p>
<p>每当call stack中没有正在执行的任务时，EventLoop会优先从microtask队列中取出任务执行，当该队列为空时才会从task队列取。</p>
<p>在使用一门框架或语言时，对于是否需要了解底层运作机制和原理，往往会有比较大的争论。有人说，我不了解内部原理同样可以写出好程序，那为什么还需要花时间去研究呢？
对此，我觉得了解底层原理还是非常有必要的。有下面几个好处：</p>
<ul>
<li>
<p>可以让我们看到全貌，了解整个系统是如何运作的。</p>
</li>
<li>
<p>底层原理大多是相通的，例如几乎所有语言的函数调用底层都是利用CallStack来实现的。学会了Javascript的CallStack运作机制，在学习其他语言的相关概念时往往能事半功倍。</p>
</li>
<li>
<p>了解底层可以让我们心中有数，明白什么事情能做，什么事情不能做。例如Javascript是单线程的，我们写代码时一定不能让线程阻塞了😀。</p>
</li>
<li>
<p>了解底层可以让我们更好的优化代码。当程序性能出现瓶颈时，可以更快地定位问题。</p>
</li>
</ul>
<h2 id="span-id参考链接6参考链接span"><!-- raw HTML omitted -->6.参考链接<!-- raw HTML omitted --></h2>
<ol>
<li><a href="https://www.youtube.com/watch?v=8aGhZQkoFbQ">Philip Roberts在欧洲JSConf上的演讲（必看）</a></li>
<li><a href="https://gist.github.com/jesstelford/9a35d20a2aa044df8bf241e00d7bc2d0">What is the JS Event Loop and Call Stack? — Jess Telford</a></li>
<li><a href="https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/">Tasks, microtasks, queues and schedules</a></li>
<li><a href="https://medium.freecodecamp.org/understanding-the-javascript-call-stack-861e41ae61d4">Understanding the JavaScript call stack</a></li>
</ol>
<p>关于我：
<a href="https://darjun.github.io">个人主页</a> <a href="https://www.jianshu.com/u/0aca4aa367c8">简书</a> <a href="https://juejin.im/user/5be15200e51d4505466ce2f4">掘金</a></p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">darjun</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
      2018-11-23
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://darjun.github.io/tags/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3javascript/">深入理解JavaScript</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/2018/12/03/javascript-execution-context/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">深入理解Javascript之Execution Context</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/2018/11/07/javascript-promise-intro/">
            <span class="next-text nav-default">深入理解Javascript之Promise</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "darjun/blog-comments"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  

    

  

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:leedarjun@gmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/darjun" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>


<a href="https://darjun.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
  
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2018 -
    2022
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        大俊
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.dee43230127a73d039a734510fa896c89c3c7ce0cf0be0c7a7433f8fd69b76dc.js" integrity="sha256-3uQyMBJ6c9A5pzRRD6iWyJw8fODPC&#43;DHp0M/j9abdtw=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>














</body>
</html>
