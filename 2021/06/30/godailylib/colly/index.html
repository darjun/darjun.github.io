<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Go 每日一库之 colly - 大俊的博客</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="darjun" />
  <meta name="description" content="简介 colly是用 Go 语言编写的功能强大的爬虫框架。它提供简洁的 API，拥有强劲的性能，可以自动处理 cookie&amp;amp;session，还有" />

  <meta name="keywords" content="大俊, 大俊的博客, go, golang, gopher" />






<meta name="generator" content="Hugo 0.83.1" />


<link rel="canonical" href="https://darjun.github.io/2021/06/30/godailylib/colly/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.fa3d941d1d0e0ddc985804227feabffea55c89883eb0af34e0532a7ae9135151.css" integrity="sha256-&#43;j2UHR0ODdyYWAQif&#43;q//qVciYg&#43;sK804FMqeukTUVE=" media="screen" crossorigin="anonymous">




<link rel="stylesheet" href="/css/custom.css">


<meta property="og:title" content="Go 每日一库之 colly" />
<meta property="og:description" content="简介 colly是用 Go 语言编写的功能强大的爬虫框架。它提供简洁的 API，拥有强劲的性能，可以自动处理 cookie&amp;session，还有" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://darjun.github.io/2021/06/30/godailylib/colly/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-07-01T07:09:00&#43;00:00" />
<meta property="article:modified_time" content="2021-07-01T07:09:00&#43;00:00" />

<meta itemprop="name" content="Go 每日一库之 colly">
<meta itemprop="description" content="简介 colly是用 Go 语言编写的功能强大的爬虫框架。它提供简洁的 API，拥有强劲的性能，可以自动处理 cookie&amp;session，还有"><meta itemprop="datePublished" content="2021-07-01T07:09:00&#43;00:00" />
<meta itemprop="dateModified" content="2021-07-01T07:09:00&#43;00:00" />
<meta itemprop="wordCount" content="4695">
<meta itemprop="keywords" content="Go 每日一库," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Go 每日一库之 colly"/>
<meta name="twitter:description" content="简介 colly是用 Go 语言编写的功能强大的爬虫框架。它提供简洁的 API，拥有强劲的性能，可以自动处理 cookie&amp;session，还有"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-42862533-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">大俊</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/">首页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/post/">归档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/about/">关于我</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/darjun" rel="noopener" target="_blank">
              Github
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      大俊
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/">首页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/post/">归档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/about/">关于我</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/darjun" rel="noopener" target="_blank">
              Github
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Go 每日一库之 colly</h1>
      
      <div class="post-meta">
        <time datetime="2021-07-01" class="post-time">
          2021-07-01
        </time>
        <div class="post-category">
            <a href="https://darjun.github.io/categories/go/"> Go </a>
            
          </div>
        <span class="more-meta"> 约 4695 字 </span>
          <span class="more-meta"> 预计阅读 10 分钟 </span>

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#简介">简介</a></li>
    <li><a href="#快速使用">快速使用</a></li>
    <li><a href="#github-treading">GitHub Treading</a></li>
    <li><a href="#百度小说热榜">百度小说热榜</a></li>
    <li><a href="#unsplash">Unsplash</a>
      <ul>
        <li><a href="#异步">异步</a></li>
        <li><a href="#第二版">第二版</a></li>
        <li><a href="#限速">限速</a></li>
        <li><a href="#设置超时">设置超时</a></li>
      </ul>
    </li>
    <li><a href="#扩展">扩展</a></li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#参考">参考</a></li>
    <li><a href="#我">我</a></li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <h2 id="简介">简介</h2>
<p><a href="https://github.com/gocolly/colly"><code>colly</code></a>是用 Go 语言编写的功能强大的爬虫框架。它提供简洁的 API，拥有强劲的性能，可以自动处理 cookie&amp;session，还有提供灵活的扩展机制。</p>
<p>首先，我们介绍<code>colly</code>的基本概念。然后通过几个案例来介绍<code>colly</code>的用法和特性：<strong>拉取 GitHub Treading，拉取百度小说热榜，下载 Unsplash 网站上的图片</strong>。</p>
<h2 id="快速使用">快速使用</h2>
<p>本文代码使用 Go Modules。</p>
<p>创建目录并初始化：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cmd" data-lang="cmd">$ mkdir colly <span class="p">&amp;&amp;</span> <span class="k">cd</span> colly
$ go mod init github.com/darjun/go-daily-lib/colly
</code></pre></td></tr></table>
</div>
</div><p>安装<code>colly</code>库：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cmd" data-lang="cmd">$ go get -u github.com/gocolly/colly/v2
</code></pre></td></tr></table>
</div>
</div><p>使用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
  <span class="s">&#34;fmt&#34;</span>

  <span class="s">&#34;github.com/gocolly/colly/v2&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">c</span> <span class="o">:=</span> <span class="nx">colly</span><span class="p">.</span><span class="nf">NewCollector</span><span class="p">(</span>
    <span class="nx">colly</span><span class="p">.</span><span class="nf">AllowedDomains</span><span class="p">(</span><span class="s">&#34;www.baidu.com&#34;</span> <span class="p">),</span>
  <span class="p">)</span>

  <span class="nx">c</span><span class="p">.</span><span class="nf">OnHTML</span><span class="p">(</span><span class="s">&#34;a[href]&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">colly</span><span class="p">.</span><span class="nx">HTMLElement</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">link</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">Attr</span><span class="p">(</span><span class="s">&#34;href&#34;</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Link found: %q -&gt; %s\n&#34;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Text</span><span class="p">,</span> <span class="nx">link</span><span class="p">)</span>
    <span class="nx">c</span><span class="p">.</span><span class="nf">Visit</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nf">AbsoluteURL</span><span class="p">(</span><span class="nx">link</span><span class="p">))</span>
  <span class="p">})</span>

  <span class="nx">c</span><span class="p">.</span><span class="nf">OnRequest</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">colly</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Visiting&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
  <span class="p">})</span>

  <span class="nx">c</span><span class="p">.</span><span class="nf">OnResponse</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">colly</span><span class="p">.</span><span class="nx">Response</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Response %s: %d bytes\n&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">URL</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Body</span><span class="p">))</span>
  <span class="p">})</span>

  <span class="nx">c</span><span class="p">.</span><span class="nf">OnError</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">colly</span><span class="p">.</span><span class="nx">Response</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Error %s: %v\n&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">URL</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">c</span><span class="p">.</span><span class="nf">Visit</span><span class="p">(</span><span class="s">&#34;http://www.baidu.com/&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>colly</code>的使用比较简单：</p>
<p>首先，调用<code>colly.NewCollector()</code>创建一个类型为<code>*colly.Collector</code>的爬虫对象。由于每个网页都有很多指向其他网页的链接。如果不加限制的话，运行可能永远不会停止。所以上面通过传入一个选项<code>colly.AllowedDomains(&quot;www.baidu.com&quot;)</code>限制只爬取域名为<code>www.baidu.com</code>的网页。</p>
<p>然后我们调用<code>c.OnHTML</code>方法注册<code>HTML</code>回调，对每个有<code>href</code>属性的<code>a</code>元素执行回调函数。这里继续访问<code>href</code>指向的 URL。也就是说解析爬取到的网页，然后继续访问网页中指向其他页面的链接。</p>
<p>调用<code>c.OnRequest()</code>方法注册请求回调，每次发送请求时执行该回调，这里只是简单打印请求的 URL。</p>
<p>调用<code>c.OnResponse()</code>方法注册响应回调，每次收到响应时执行该回调，这里也只是简单的打印 URL 和响应大小。</p>
<p>调用<code>c.OnError()</code>方法注册错误回调，执行请求发生错误时执行该回调，这里简单打印 URL 和错误信息。</p>
<p>最后我们调用<code>c.Visit()</code>开始访问第一个页面。</p>
<p>运行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="err">$</span> <span class="k">go</span> <span class="nx">run</span> <span class="nx">main</span><span class="p">.</span><span class="k">go</span>
<span class="nx">Visiting</span> <span class="nx">http</span><span class="p">:</span><span class="c1">//www.baidu.com/
</span><span class="c1"></span><span class="nx">Response</span> <span class="nx">http</span><span class="p">:</span><span class="c1">//www.baidu.com/: 303317 bytes
</span><span class="c1"></span><span class="nx">Link</span> <span class="nx">found</span><span class="p">:</span> <span class="s">&#34;百度首页&#34;</span> <span class="o">-</span><span class="p">&gt;</span> <span class="o">/</span>
<span class="nx">Link</span> <span class="nx">found</span><span class="p">:</span> <span class="s">&#34;设置&#34;</span> <span class="o">-</span><span class="p">&gt;</span> <span class="nx">javascript</span><span class="p">:;</span>
<span class="nx">Link</span> <span class="nx">found</span><span class="p">:</span> <span class="s">&#34;登录&#34;</span> <span class="o">-</span><span class="p">&gt;</span> <span class="nx">https</span><span class="p">:</span><span class="c1">//passport.baidu.com/v2/?login&amp;tpl=mn&amp;u=http%3A%2F%2Fwww.baidu.com%2F&amp;sms=5
</span><span class="c1"></span><span class="nx">Link</span> <span class="nx">found</span><span class="p">:</span> <span class="s">&#34;新闻&#34;</span> <span class="o">-</span><span class="p">&gt;</span> <span class="nx">http</span><span class="p">:</span><span class="c1">//news.baidu.com
</span><span class="c1"></span><span class="nx">Link</span> <span class="nx">found</span><span class="p">:</span> <span class="s">&#34;hao123&#34;</span> <span class="o">-</span><span class="p">&gt;</span> <span class="nx">https</span><span class="p">:</span><span class="c1">//www.hao123.com
</span><span class="c1"></span><span class="nx">Link</span> <span class="nx">found</span><span class="p">:</span> <span class="s">&#34;地图&#34;</span> <span class="o">-</span><span class="p">&gt;</span> <span class="nx">http</span><span class="p">:</span><span class="c1">//map.baidu.com
</span><span class="c1"></span><span class="nx">Link</span> <span class="nx">found</span><span class="p">:</span> <span class="s">&#34;直播&#34;</span> <span class="o">-</span><span class="p">&gt;</span> <span class="nx">https</span><span class="p">:</span><span class="c1">//live.baidu.com/
</span><span class="c1"></span><span class="nx">Link</span> <span class="nx">found</span><span class="p">:</span> <span class="s">&#34;视频&#34;</span> <span class="o">-</span><span class="p">&gt;</span> <span class="nx">https</span><span class="p">:</span><span class="c1">//haokan.baidu.com/?sfrom=baidu-top
</span><span class="c1"></span><span class="nx">Link</span> <span class="nx">found</span><span class="p">:</span> <span class="s">&#34;贴吧&#34;</span> <span class="o">-</span><span class="p">&gt;</span> <span class="nx">http</span><span class="p">:</span><span class="c1">//tieba.baidu.com
</span><span class="c1"></span><span class="o">...</span>
</code></pre></td></tr></table>
</div>
</div><p><code>colly</code>爬取到页面之后，会使用<a href="https://darjun.github.io/2020/10/11/godailylib/goquery/">goquery</a>解析这个页面。然后查找注册的 HTML 回调对应元素选择器（element-selector），将<code>goquery.Selection</code>封装成一个<code>colly.HTMLElement</code>执行回调。</p>
<p><code>colly.HTMLElement</code>其实就是对<code>goquery.Selection</code>的简单封装：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">type</span> <span class="nx">HTMLElement</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Name</span> <span class="kt">string</span>
  <span class="nx">Text</span> <span class="kt">string</span>
  <span class="nx">Request</span> <span class="o">*</span><span class="nx">Request</span>
  <span class="nx">Response</span> <span class="o">*</span><span class="nx">Response</span>
  <span class="nx">DOM</span> <span class="o">*</span><span class="nx">goquery</span><span class="p">.</span><span class="nx">Selection</span>
  <span class="nx">Index</span> <span class="kt">int</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>并提供了简单易用的方法：</p>
<ul>
<li><code>Attr(k string)</code>：返回当前元素的属性，上面示例中我们使用<code>e.Attr(&quot;href&quot;)</code>获取了<code>href</code>属性；</li>
<li><code>ChildAttr(goquerySelector, attrName string)</code>：返回<code>goquerySelector</code>选择的第一个子元素的<code>attrName</code>属性；</li>
<li><code>ChildAttrs(goquerySelector, attrName string)</code>：返回<code>goquerySelector</code>选择的所有子元素的<code>attrName</code>属性，以<code>[]string</code>返回；</li>
<li><code>ChildText(goquerySelector string)</code>：拼接<code>goquerySelector</code>选择的子元素的文本内容并返回；</li>
<li><code>ChildTexts(goquerySelector string)</code>：返回<code>goquerySelector</code>选择的子元素的文本内容组成的切片，以<code>[]string</code>返回。</li>
<li><code>ForEach(goquerySelector string, callback func(int, *HTMLElement))</code>：对每个<code>goquerySelector</code>选择的子元素执行回调<code>callback</code>；</li>
<li><code>Unmarshal(v interface{})</code>：通过给结构体字段指定 goquerySelector 格式的 tag，可以将一个 HTMLElement 对象 Unmarshal 到一个结构体实例中。</li>
</ul>
<p>这些方法会被频繁地用到。下面我们就通过一些示例来介绍<code>colly</code>的特性和用法。</p>
<h2 id="github-treading">GitHub Treading</h2>
<p>我之前写过一个拉取<a href="https://darjun.github.io/2021/06/16/github-trending-api/">GitHub Treading 的 API</a>，用<code>colly</code>更方便：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">type</span> <span class="nx">Repository</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Author</span>  <span class="kt">string</span>
  <span class="nx">Name</span>    <span class="kt">string</span>
  <span class="nx">Link</span>    <span class="kt">string</span>
  <span class="nx">Desc</span>    <span class="kt">string</span>
  <span class="nx">Lang</span>    <span class="kt">string</span>
  <span class="nx">Stars</span>   <span class="kt">int</span>
  <span class="nx">Forks</span>   <span class="kt">int</span>
  <span class="nx">Add</span>     <span class="kt">int</span>
  <span class="nx">BuiltBy</span> <span class="p">[]</span><span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">c</span> <span class="o">:=</span> <span class="nx">colly</span><span class="p">.</span><span class="nf">NewCollector</span><span class="p">(</span>
    <span class="nx">colly</span><span class="p">.</span><span class="nf">MaxDepth</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
  <span class="p">)</span>


  <span class="nx">repos</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="o">*</span><span class="nx">Repository</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
  <span class="nx">c</span><span class="p">.</span><span class="nf">OnHTML</span><span class="p">(</span><span class="s">&#34;.Box .Box-row&#34;</span><span class="p">,</span> <span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">colly</span><span class="p">.</span><span class="nx">HTMLElement</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">repo</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Repository</span><span class="p">{}</span>

    <span class="c1">// author &amp; repository name
</span><span class="c1"></span>    <span class="nx">authorRepoName</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">ChildText</span><span class="p">(</span><span class="s">&#34;h1.h3 &gt; a&#34;</span><span class="p">)</span>
    <span class="nx">parts</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">authorRepoName</span><span class="p">,</span> <span class="s">&#34;/&#34;</span><span class="p">)</span>
    <span class="nx">repo</span><span class="p">.</span><span class="nx">Author</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="nx">repo</span><span class="p">.</span><span class="nx">Name</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1">// link
</span><span class="c1"></span>    <span class="nx">repo</span><span class="p">.</span><span class="nx">Link</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nf">AbsoluteURL</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nf">ChildAttr</span><span class="p">(</span><span class="s">&#34;h1.h3 &gt;a&#34;</span><span class="p">,</span> <span class="s">&#34;href&#34;</span><span class="p">))</span>

    <span class="c1">// description
</span><span class="c1"></span>    <span class="nx">repo</span><span class="p">.</span><span class="nx">Desc</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">ChildText</span><span class="p">(</span><span class="s">&#34;p.pr-4&#34;</span><span class="p">)</span>

    <span class="c1">// language
</span><span class="c1"></span>    <span class="nx">repo</span><span class="p">.</span><span class="nx">Lang</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nf">ChildText</span><span class="p">(</span><span class="s">&#34;div.mt-2 &gt; span.mr-3 &gt; span[itemprop]&#34;</span><span class="p">))</span>

    <span class="c1">// star &amp; fork
</span><span class="c1"></span>    <span class="nx">starForkStr</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">ChildText</span><span class="p">(</span><span class="s">&#34;div.mt-2 &gt; a.mr-3&#34;</span><span class="p">)</span>
    <span class="nx">starForkStr</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Replace</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="nx">starForkStr</span><span class="p">),</span> <span class="s">&#34;,&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="nx">parts</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">starForkStr</span><span class="p">,</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span>
    <span class="nx">repo</span><span class="p">.</span><span class="nx">Stars</span> <span class="p">,</span> <span class="nx">_</span><span class="p">=</span><span class="nx">strconv</span><span class="p">.</span><span class="nf">Atoi</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="nx">repo</span><span class="p">.</span><span class="nx">Forks</span> <span class="p">,</span> <span class="nx">_</span><span class="p">=</span><span class="nx">strconv</span><span class="p">.</span><span class="nf">Atoi</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">parts</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

    <span class="c1">// add
</span><span class="c1"></span>    <span class="nx">addStr</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">ChildText</span><span class="p">(</span><span class="s">&#34;div.mt-2 &gt; span.float-sm-right&#34;</span><span class="p">)</span>
    <span class="nx">parts</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">addStr</span><span class="p">,</span> <span class="s">&#34; &#34;</span><span class="p">)</span>
    <span class="nx">repo</span><span class="p">.</span><span class="nx">Add</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">Atoi</span><span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1">// built by
</span><span class="c1"></span>    <span class="nx">e</span><span class="p">.</span><span class="nf">ForEach</span><span class="p">(</span><span class="s">&#34;div.mt-2 &gt; span.mr-3  img[src]&#34;</span><span class="p">,</span> <span class="kd">func</span> <span class="p">(</span><span class="nx">index</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">img</span> <span class="o">*</span><span class="nx">colly</span><span class="p">.</span><span class="nx">HTMLElement</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">repo</span><span class="p">.</span><span class="nx">BuiltBy</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">repo</span><span class="p">.</span><span class="nx">BuiltBy</span><span class="p">,</span> <span class="nx">img</span><span class="p">.</span><span class="nf">Attr</span><span class="p">(</span><span class="s">&#34;src&#34;</span><span class="p">))</span>
    <span class="p">})</span>

    <span class="nx">repos</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">repos</span><span class="p">,</span> <span class="nx">repo</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">c</span><span class="p">.</span><span class="nf">Visit</span><span class="p">(</span><span class="s">&#34;https://github.com/trending&#34;</span><span class="p">)</span>
  
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%d repositories\n&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">repos</span><span class="p">))</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;first repository:&#34;</span><span class="p">)</span>
  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">repo</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">repos</span> <span class="p">{</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Author:&#34;</span><span class="p">,</span> <span class="nx">repo</span><span class="p">.</span><span class="nx">Author</span><span class="p">)</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Name:&#34;</span><span class="p">,</span> <span class="nx">repo</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
      <span class="k">break</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>我们用<code>ChildText</code>获取作者、仓库名、语言、星数和 fork 数、今日新增等信息，用<code>ChildAttr</code>获取仓库链接，这个链接是一个相对路径，通过调用<code>e.Request.AbsoluteURL()</code>方法将它转为一个绝对路径。</p>
<p>运行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="err">$</span> <span class="k">go</span> <span class="nx">run</span> <span class="nx">main</span><span class="p">.</span><span class="k">go</span>
<span class="mi">25</span> <span class="nx">repositories</span>
<span class="nx">first</span> <span class="nx">repository</span><span class="p">:</span>
<span class="nx">Author</span><span class="p">:</span> <span class="nx">Shopify</span>
<span class="nx">Name</span><span class="p">:</span> <span class="nx">dawn</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="百度小说热榜">百度小说热榜</h2>
<p>网页结构如下：</p>
<p><img src="/img/in-post/godailylib/colly2.png#center" alt=""></p>
<p>各部分结构如下：</p>
<ul>
<li>每条热榜各自在一个<code>div.category-wrap_iQLoo</code>中；</li>
<li><code>a</code>元素下<code>div.index_1Ew5p</code>是排名；</li>
<li>内容在<code>div.content_1YWBm</code>中；</li>
<li>内容中<code>a.title_dIF3B</code>是标题；</li>
<li>内容中两个<code>div.intro_1l0wp</code>，前一个是作者，后一个是类型；</li>
<li>内容中<code>div.desc_3CTjT</code>是描述。</li>
</ul>
<p>由此我们定义结构：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">type</span> <span class="nx">Hot</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Rank</span>   <span class="kt">string</span> <span class="s">`selector:&#34;a &gt; div.index_1Ew5p&#34;`</span>
  <span class="nx">Name</span>   <span class="kt">string</span> <span class="s">`selector:&#34;div.content_1YWBm &gt; a.title_dIF3B&#34;`</span>
  <span class="nx">Author</span> <span class="kt">string</span> <span class="s">`selector:&#34;div.content_1YWBm &gt; div.intro_1l0wp:nth-child(2)&#34;`</span>
  <span class="nx">Type</span>   <span class="kt">string</span> <span class="s">`selector:&#34;div.content_1YWBm &gt; div.intro_1l0wp:nth-child(3)&#34;`</span>
  <span class="nx">Desc</span>   <span class="kt">string</span> <span class="s">`selector:&#34;div.desc_3CTjT&#34;`</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>tag 中是 CSS 选择器语法，添加这个是为了可以直接调用<code>HTMLElement.Unmarshal()</code>方法填充<code>Hot</code>对象。</p>
<p>然后创建<code>Collector</code>对象：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="nx">c</span> <span class="o">:=</span> <span class="nx">colly</span><span class="p">.</span><span class="nf">NewCollector</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>注册回调：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="nx">c</span><span class="p">.</span><span class="nf">OnHTML</span><span class="p">(</span><span class="s">&#34;div.category-wrap_iQLoo&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">colly</span><span class="p">.</span><span class="nx">HTMLElement</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">hot</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Hot</span><span class="p">{}</span>

  <span class="nx">err</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">hot</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;error:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="k">return</span>
  <span class="p">}</span>

  <span class="nx">hots</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">hots</span><span class="p">,</span> <span class="nx">hot</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">c</span><span class="p">.</span><span class="nf">OnRequest</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">colly</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Requesting:&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">c</span><span class="p">.</span><span class="nf">OnResponse</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">colly</span><span class="p">.</span><span class="nx">Response</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Response:&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Body</span><span class="p">))</span>
<span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><p><code>OnHTML</code>对每个条目执行<code>Unmarshal</code>生成<code>Hot</code>对象。</p>
<p><code>OnRequest/OnResponse</code>只是简单输出调试信息。</p>
<p>然后，调用<code>c.Visit()</code>访问网址：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Visit</span><span class="p">(</span><span class="s">&#34;https://top.baidu.com/board?tab=novel&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Visit error:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
  <span class="k">return</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>最后添加一些调试打印：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%d hots\n&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">hots</span><span class="p">))</span>
<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">hot</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">hots</span> <span class="p">{</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;first hot:&#34;</span><span class="p">)</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Rank:&#34;</span><span class="p">,</span> <span class="nx">hot</span><span class="p">.</span><span class="nx">Rank</span><span class="p">)</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Name:&#34;</span><span class="p">,</span> <span class="nx">hot</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Author:&#34;</span><span class="p">,</span> <span class="nx">hot</span><span class="p">.</span><span class="nx">Author</span><span class="p">)</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Type:&#34;</span><span class="p">,</span> <span class="nx">hot</span><span class="p">.</span><span class="nx">Type</span><span class="p">)</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Desc:&#34;</span><span class="p">,</span> <span class="nx">hot</span><span class="p">.</span><span class="nx">Desc</span><span class="p">)</span>
  <span class="k">break</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>运行输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="nx">Requesting</span><span class="p">:</span> <span class="nx">https</span><span class="p">:</span><span class="c1">//top.baidu.com/board?tab=novel
</span><span class="c1"></span><span class="nx">Response</span><span class="p">:</span> <span class="mi">118083</span>
<span class="mi">30</span> <span class="nx">hots</span>
<span class="nx">first</span> <span class="nx">hot</span><span class="p">:</span>
<span class="nx">Rank</span><span class="p">:</span> <span class="mi">1</span>
<span class="nx">Name</span><span class="p">:</span> <span class="nx">逆天邪神</span>
<span class="nx">Author</span><span class="p">:</span> <span class="nx">作者</span><span class="err">：</span><span class="nx">火星引力</span>
<span class="nx">Type</span><span class="p">:</span> <span class="nx">类型</span><span class="err">：</span><span class="nx">玄幻</span>
<span class="nx">Desc</span><span class="p">:</span> <span class="nx">掌天毒之珠</span><span class="err">，</span><span class="nx">承邪神之血</span><span class="err">，</span><span class="nx">修逆天之力</span><span class="err">，</span><span class="nx">一代邪神</span><span class="err">，</span><span class="nx">君临天下</span><span class="err">！</span>  <span class="nx">查看更多</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="unsplash">Unsplash</h2>
<p>我写公众号文章，背景图片基本都是从 unsplash 这个网站获取。unsplash 提供了大量的、丰富的、免费的图片。这个网站有个问题，就是访问速度比较慢。既然学习爬虫，刚好利用程序自动下载图片。</p>
<p>unsplash 首页如下图所示：</p>
<p><img src="/img/in-post/godailylib/colly3.png#center" alt=""></p>
<p>网页结构如下：</p>
<p><img src="/img/in-post/godailylib/colly4.png#center" alt=""></p>
<p>但是首页上显示的都是尺寸较小的图片，我们点开某张图片的链接：</p>
<p><img src="/img/in-post/godailylib/colly5.png#center" alt=""></p>
<p>网页结构如下：</p>
<p><img src="/img/in-post/godailylib/colly6.png#center" alt=""></p>
<p>由于涉及三层网页结构（<code>img</code>最后还需要访问一次），使用一个<code>colly.Collector</code>对象，<code>OnHTML</code>回调设置需要格外小心，给编码带来比较大的心智负担。<code>colly</code>支持多个<code>Collector</code>，我们采用这种方式来编码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">c1</span> <span class="o">:=</span> <span class="nx">colly</span><span class="p">.</span><span class="nf">NewCollector</span><span class="p">()</span>
  <span class="nx">c2</span> <span class="o">:=</span> <span class="nx">c1</span><span class="p">.</span><span class="nf">Clone</span><span class="p">()</span>
  <span class="nx">c3</span> <span class="o">:=</span> <span class="nx">c1</span><span class="p">.</span><span class="nf">Clone</span><span class="p">()</span>

  <span class="nx">c1</span><span class="p">.</span><span class="nf">OnHTML</span><span class="p">(</span><span class="s">&#34;figure[itemProp] a[itemProp]&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">colly</span><span class="p">.</span><span class="nx">HTMLElement</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">href</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">Attr</span><span class="p">(</span><span class="s">&#34;href&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">href</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
      <span class="k">return</span>
    <span class="p">}</span>

    <span class="nx">c2</span><span class="p">.</span><span class="nf">Visit</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nf">AbsoluteURL</span><span class="p">(</span><span class="nx">href</span><span class="p">))</span>
  <span class="p">})</span>

  <span class="nx">c2</span><span class="p">.</span><span class="nf">OnHTML</span><span class="p">(</span><span class="s">&#34;div._1g5Lu &gt; img[src]&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">colly</span><span class="p">.</span><span class="nx">HTMLElement</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">src</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">Attr</span><span class="p">(</span><span class="s">&#34;src&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">src</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
      <span class="k">return</span>
    <span class="p">}</span>

    <span class="nx">c3</span><span class="p">.</span><span class="nf">Visit</span><span class="p">(</span><span class="nx">src</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">c1</span><span class="p">.</span><span class="nf">OnRequest</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">colly</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Visiting&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">c1</span><span class="p">.</span><span class="nf">OnError</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">colly</span><span class="p">.</span><span class="nx">Response</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Visiting&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">URL</span><span class="p">,</span> <span class="s">&#34;failed:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>我们使用 3 个<code>Collector</code>对象，第一个<code>Collector</code>用于收集首页上对应的图片链接，然后使用第二个<code>Collector</code>去访问这些图片链接，最后让第三个<code>Collector</code>去下载图片。上面我们还为第一个<code>Collector</code>注册了请求和错误回调。</p>
<p>第三个<code>Collector</code>下载到具体的图片内容后，保存到本地：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// ... 省略
</span><span class="c1"></span>  <span class="kd">var</span> <span class="nx">count</span> <span class="kt">uint32</span>
  <span class="nx">c3</span><span class="p">.</span><span class="nf">OnResponse</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">colly</span><span class="p">.</span><span class="nx">Response</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fileName</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;images/img%d.jpg&#34;</span><span class="p">,</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">AddUint32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Save</span><span class="p">(</span><span class="nx">fileName</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;saving %s failed:%v\n&#34;</span><span class="p">,</span> <span class="nx">fileName</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;saving %s success\n&#34;</span><span class="p">,</span> <span class="nx">fileName</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">})</span>

  <span class="nx">c3</span><span class="p">.</span><span class="nf">OnRequest</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">colly</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;visiting&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>上面使用<code>atomic.AddUint32()</code>为图片生成序号。</p>
<p>运行程序，爬取结果：</p>
<p><img src="/img/in-post/godailylib/colly7.png#center" alt=""></p>
<h3 id="异步">异步</h3>
<p>默认情况下，<code>colly</code>爬取网页是同步的，即爬完一个接着爬另一个，上面的 unplash 程序就是如此。这样需要很长时间，<code>colly</code>提供了异步爬取的特性，我们只需要在构造<code>Collector</code>对象时传入选项<code>colly.Async(true)</code>即可开启异步：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="nx">c1</span> <span class="o">:=</span> <span class="nx">colly</span><span class="p">.</span><span class="nf">NewCollector</span><span class="p">(</span>
  <span class="nx">colly</span><span class="p">.</span><span class="nf">Async</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>但是，由于是异步爬取，所以程序最后需要等待<code>Collector</code>处理完成，否则早早地退出<code>main</code>，程序会退出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="nx">c1</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
<span class="nx">c2</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
<span class="nx">c3</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>再次运行，速度快了很多😀。</p>
<h3 id="第二版">第二版</h3>
<p>向下滑动 unsplash 的网页，我们发现后面的图片是异步加载的。滚动页面，通过 chrome 浏览器的 network 页签查看请求：</p>
<p><img src="/img/in-post/godailylib/colly8.png#center" alt=""></p>
<p>请求路径<code>/photos</code>，设置<code>per_page</code>和<code>page</code>参数，返回的是一个 JSON 数组。所以有了另一种方式：</p>
<p>定义每一项的结构体，我们只保留必要的字段：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">type</span> <span class="nx">Item</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Id</span>     <span class="kt">string</span>
  <span class="nx">Width</span>  <span class="kt">int</span>
  <span class="nx">Height</span> <span class="kt">int</span>
  <span class="nx">Links</span>  <span class="nx">Links</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Links</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Download</span> <span class="kt">string</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>然后在<code>OnResponse</code>回调中解析 JSON，对每一项的<code>Download</code>链接调用负责下载图像的<code>Collector</code>的<code>Visit()</code>方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="nx">c</span><span class="p">.</span><span class="nf">OnResponse</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">colly</span><span class="p">.</span><span class="nx">Response</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">items</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Item</span>
  <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Body</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">items</span><span class="p">)</span>
  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">item</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">items</span> <span class="p">{</span>
    <span class="nx">d</span><span class="p">.</span><span class="nf">Visit</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">Links</span><span class="p">.</span><span class="nx">Download</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><p>初始化访问，我们设置拉取 3 页，每页 12 个（和页面请求的个数一致）：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="k">for</span> <span class="nx">page</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">page</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">;</span> <span class="nx">page</span><span class="o">++</span> <span class="p">{</span>
  <span class="nx">c</span><span class="p">.</span><span class="nf">Visit</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;https://unsplash.com/napi/photos?page=%d&amp;per_page=12&#34;</span><span class="p">,</span> <span class="nx">page</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>运行，查看下载的图片：</p>
<p><img src="/img/in-post/godailylib/colly9.png#center" alt=""></p>
<h3 id="限速">限速</h3>
<p>有时候并发请求太多，网站会限制访问。这时就需要使用<code>LimitRule</code>了。说白了，<code>LimitRule</code>就是限制访问速度和并发量的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">type</span> <span class="nx">LimitRule</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">DomainRegexp</span> <span class="kt">string</span>
  <span class="nx">DomainGlob</span> <span class="kt">string</span>
  <span class="nx">Delay</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>
  <span class="nx">RandomDelay</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>
  <span class="nx">Parallelism</span>    <span class="kt">int</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>常用的就<code>Delay/RandomDelay/Parallism</code>这几个，分别表示请求与请求之间的延迟，随机延迟，和并发数。另外<strong>必须</strong>指定对哪些域名施行限制，通过<code>DomainRegexp</code>或<code>DomainGlob</code>设置，如果这两个字段都未设置<code>Limit()</code>方法会返回错误。用在上面的例子中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Limit</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">colly</span><span class="p">.</span><span class="nx">LimitRule</span><span class="p">{</span>
  <span class="nx">DomainRegexp</span><span class="p">:</span> <span class="s">`unsplash\.com`</span><span class="p">,</span>
  <span class="nx">RandomDelay</span><span class="p">:</span>  <span class="mi">500</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">,</span>
  <span class="nx">Parallelism</span><span class="p">:</span>  <span class="mi">12</span><span class="p">,</span>
<span class="p">})</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
  <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>我们设置针对<code>unsplash.com</code>这个域名，请求与请求之间的随机最大延迟 500ms，最多同时并发 12 个请求。</p>
<h3 id="设置超时">设置超时</h3>
<p>有时候网速较慢，<code>colly</code>中使用的<code>http.Client</code>有默认超时机制，我们可以通过<code>colly.WithTransport()</code>选项改写：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="nx">c</span><span class="p">.</span><span class="nf">WithTransport</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Transport</span><span class="p">{</span>
  <span class="nx">Proxy</span><span class="p">:</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ProxyFromEnvironment</span><span class="p">,</span>
  <span class="nx">DialContext</span><span class="p">:</span> <span class="p">(</span><span class="o">&amp;</span><span class="nx">net</span><span class="p">.</span><span class="nx">Dialer</span><span class="p">{</span>
    <span class="nx">Timeout</span><span class="p">:</span>   <span class="mi">30</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
    <span class="nx">KeepAlive</span><span class="p">:</span> <span class="mi">30</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
  <span class="p">}).</span><span class="nx">DialContext</span><span class="p">,</span>
  <span class="nx">MaxIdleConns</span><span class="p">:</span>          <span class="mi">100</span><span class="p">,</span>
  <span class="nx">IdleConnTimeout</span><span class="p">:</span>       <span class="mi">90</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
  <span class="nx">TLSHandshakeTimeout</span><span class="p">:</span>   <span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
  <span class="nx">ExpectContinueTimeout</span><span class="p">:</span> <span class="mi">1</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
<span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="扩展">扩展</h2>
<p><code>colly</code>在子包<code>extension</code>中提供了一些扩展特性，最最常用的就是随机 User-Agent 了。通常网站会通过 User-Agent 识别请求是否是浏览器发出的，爬虫一般会设置这个 Header 把自己伪装成浏览器。使用也比较简单：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kn">import</span> <span class="s">&#34;github.com/gocolly/colly/v2/extensions&#34;</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">c</span> <span class="o">:=</span> <span class="nx">colly</span><span class="p">.</span><span class="nf">NewCollector</span><span class="p">()</span>
  <span class="nx">extensions</span><span class="p">.</span><span class="nf">RandomUserAgent</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>随机 User-Agent 实现也很简单，就是从一些预先定义好的 User-Agent 数组中随机一个设置到 Header 中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">func</span> <span class="nf">RandomUserAgent</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">colly</span><span class="p">.</span><span class="nx">Collector</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">c</span><span class="p">.</span><span class="nf">OnRequest</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">colly</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">Headers</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;User-Agent&#34;</span><span class="p">,</span> <span class="nx">uaGens</span><span class="p">[</span><span class="nx">rand</span><span class="p">.</span><span class="nf">Intn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">uaGens</span><span class="p">))]())</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>实现自己的扩展也不难，例如我们每次请求时需要设置一个特定的 Header，扩展可以这么写：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">func</span> <span class="nf">MyHeader</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">colly</span><span class="p">.</span><span class="nx">Collector</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">c</span><span class="p">.</span><span class="nf">OnRequest</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">colly</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">Headers</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;My-Header&#34;</span><span class="p">,</span> <span class="s">&#34;dj&#34;</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>用<code>Collector</code>对象调用<code>MyHeader()</code>函数即可：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="nf">MyHeader</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="总结">总结</h2>
<p><code>colly</code>是 Go 语言中最流行的爬虫框架，支持丰富的特性。本文对一些常用特性做了介绍，并辅之以实例。限于篇幅，一些高级特性未能涉及，例如队列，存储等。对爬虫感兴趣的可去深入了解。</p>
<p>大家如果发现好玩、好用的 Go 语言库，欢迎到 Go 每日一库 GitHub 上提交 issue😄</p>
<h2 id="参考">参考</h2>
<ol>
<li>Go 每日一库 GitHub：<a href="https://github.com/darjun/go-daily-lib">https://github.com/darjun/go-daily-lib</a></li>
<li>Go 每日一库之 goquery：<a href="https://darjun.github.io/2020/10/11/godailylib/goquery/">https://darjun.github.io/2020/10/11/godailylib/goquery/</a></li>
<li>用 Go 实现一个 GitHub Trending API：<a href="https://darjun.github.io/2021/06/16/github-trending-api/">https://darjun.github.io/2021/06/16/github-trending-api/</a></li>
<li>colly GitHub：<a href="https://github.com/gocolly/colly">https://github.com/gocolly/colly</a></li>
</ol>
<h2 id="我">我</h2>
<p>我的博客：<a href="https://darjun.github.io">https://darjun.github.io</a></p>
<p>欢迎关注我的微信公众号【GoUpUp】，共同学习，一起进步~</p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">darjun</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
      2021-07-01
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/2021/07/13/in-post/godailylib/nethttp/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">Go 每日一库之 net/http（基础和中间件）</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/2021/06/29/godailylib/termtables/">
            <span class="next-text nav-default">Go 每日一库之 termtables</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "darjun/blog-comments"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:leedarjun@gmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/darjun" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>


<a href="https://darjun.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2018 -
    2021
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        大俊
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>












</body>
</html>
