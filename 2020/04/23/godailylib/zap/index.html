<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Go 每日一库之 zap - 大俊的博客</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="darjun" />
  <meta name="description" content="简介 在很早之前的文章中，我们介绍过 Go 标准日志库log和结构化的日志库logrus。在热点函数中记录日志对日志库的执行性能有较高的要求，不能影" />

  <meta name="keywords" content="大俊, 大俊的博客, go, golang, gopher" />






<meta name="generator" content="Hugo 0.83.1" />


<link rel="canonical" href="https://darjun.github.io/2020/04/23/godailylib/zap/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.fa3d941d1d0e0ddc985804227feabffea55c89883eb0af34e0532a7ae9135151.css" integrity="sha256-&#43;j2UHR0ODdyYWAQif&#43;q//qVciYg&#43;sK804FMqeukTUVE=" media="screen" crossorigin="anonymous">




<link rel="stylesheet" href="/css/custom.css">


<meta property="og:title" content="Go 每日一库之 zap" />
<meta property="og:description" content="简介 在很早之前的文章中，我们介绍过 Go 标准日志库log和结构化的日志库logrus。在热点函数中记录日志对日志库的执行性能有较高的要求，不能影" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://darjun.github.io/2020/04/23/godailylib/zap/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-04-23T23:07:23&#43;00:00" />
<meta property="article:modified_time" content="2020-04-23T23:07:23&#43;00:00" />

<meta itemprop="name" content="Go 每日一库之 zap">
<meta itemprop="description" content="简介 在很早之前的文章中，我们介绍过 Go 标准日志库log和结构化的日志库logrus。在热点函数中记录日志对日志库的执行性能有较高的要求，不能影"><meta itemprop="datePublished" content="2020-04-23T23:07:23&#43;00:00" />
<meta itemprop="dateModified" content="2020-04-23T23:07:23&#43;00:00" />
<meta itemprop="wordCount" content="4389">
<meta itemprop="keywords" content="Go 每日一库," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Go 每日一库之 zap"/>
<meta name="twitter:description" content="简介 在很早之前的文章中，我们介绍过 Go 标准日志库log和结构化的日志库logrus。在热点函数中记录日志对日志库的执行性能有较高的要求，不能影"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-42862533-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">大俊</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/">首页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/post/">归档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/about/">关于我</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/darjun" rel="noopener" target="_blank">
              Github
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      大俊
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/">首页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/post/">归档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/about/">关于我</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/darjun" rel="noopener" target="_blank">
              Github
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Go 每日一库之 zap</h1>
      
      <div class="post-meta">
        <time datetime="2020-04-23" class="post-time">
          2020-04-23
        </time>
        <div class="post-category">
            <a href="https://darjun.github.io/categories/go/"> Go </a>
            
          </div>
        <span class="more-meta"> 约 4389 字 </span>
          <span class="more-meta"> 预计阅读 9 分钟 </span>

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#简介">简介</a></li>
    <li><a href="#快速使用">快速使用</a></li>
    <li><a href="#记录层级关系">记录层级关系</a></li>
    <li><a href="#定制logger">定制<code>Logger</code></a></li>
    <li><a href="#选项">选项</a>
      <ul>
        <li><a href="#输出文件名和行号">输出文件名和行号</a></li>
        <li><a href="#输出调用堆栈">输出调用堆栈</a></li>
      </ul>
    </li>
    <li><a href="#全局logger">全局<code>Logger</code></a>
      <ul>
        <li><a href="#预设日志字段">预设日志字段</a></li>
      </ul>
    </li>
    <li><a href="#与标准日志库搭配使用">与标准日志库搭配使用</a></li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#参考">参考</a></li>
    <li><a href="#我">我</a></li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <h2 id="简介">简介</h2>
<p>在很早之前的文章中，我们介绍过 Go 标准日志库<a href="https://darjun.github.io/2020/02/07/godailylib/log/"><code>log</code></a>和结构化的日志库<a href="https://darjun.github.io/2020/02/07/godailylib/logrus/"><code>logrus</code></a>。在热点函数中记录日志对日志库的执行性能有较高的要求，不能影响正常逻辑的执行时间。<code>uber</code>开源的日志库<code>zap</code>，对性能和内存分配做了极致的优化。</p>
<h2 id="快速使用">快速使用</h2>
<p>先安装：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="err">$</span> <span class="k">go</span> <span class="nx">get</span> <span class="k">go</span><span class="p">.</span><span class="nx">uber</span><span class="p">.</span><span class="nx">org</span><span class="o">/</span><span class="nx">zap</span>
</code></pre></td></tr></table>
</div>
</div><p>后使用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
  <span class="s">&#34;time&#34;</span>

  <span class="s">&#34;go.uber.org/zap&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">logger</span> <span class="o">:=</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">NewExample</span><span class="p">()</span>
  <span class="k">defer</span> <span class="nx">logger</span><span class="p">.</span><span class="nf">Sync</span><span class="p">()</span>

  <span class="nx">url</span> <span class="o">:=</span> <span class="s">&#34;http://example.org/api&#34;</span>
  <span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;failed to fetch URL&#34;</span><span class="p">,</span>
    <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;url&#34;</span><span class="p">,</span> <span class="nx">url</span><span class="p">),</span>
    <span class="nx">zap</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="s">&#34;attempt&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="nx">zap</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="s">&#34;backoff&#34;</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">),</span>
  <span class="p">)</span>

  <span class="nx">sugar</span> <span class="o">:=</span> <span class="nx">logger</span><span class="p">.</span><span class="nf">Sugar</span><span class="p">()</span>
  <span class="nx">sugar</span><span class="p">.</span><span class="nf">Infow</span><span class="p">(</span><span class="s">&#34;failed to fetch URL&#34;</span><span class="p">,</span>
    <span class="s">&#34;url&#34;</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span>
    <span class="s">&#34;attempt&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s">&#34;backoff&#34;</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
  <span class="p">)</span>
  <span class="nx">sugar</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Failed to fetch URL: %s&#34;</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>zap</code>库的使用与其他的日志库非常相似。先创建一个<code>logger</code>，然后调用各个级别的方法记录日志（<code>Debug/Info/Error/Warn</code>）。<code>zap</code>提供了几个快速创建<code>logger</code>的方法，<code>zap.NewExample()</code>、<code>zap.NewDevelopment()</code>、<code>zap.NewProduction()</code>，还有高度定制化的创建方法<code>zap.New()</code>。创建前 3 个<code>logger</code>时，<code>zap</code>会使用一些预定义的设置，它们的使用场景也有所不同。<code>Example</code>适合用在测试代码中，<code>Development</code>在开发环境中使用，<code>Production</code>用在生成环境。</p>
<p><code>zap</code>底层 API 可以设置缓存，所以一般使用<code>defer logger.Sync()</code>将缓存同步到文件中。</p>
<p>由于<code>fmt.Printf</code>之类的方法大量使用<code>interface{}</code>和反射，会有不少性能损失，并且增加了内存分配的频次。<code>zap</code>为了提高性能、减少内存分配次数，没有使用反射，而且默认的<code>Logger</code>只支持强类型的、结构化的日志。必须使用<code>zap</code>提供的方法记录字段。<code>zap</code>为 Go 语言中所有的基本类型和其他常见类型都提供了方法。这些方法的名称也比较好记忆，<code>zap.Type</code>（<code>Type</code>为<code>bool/int/uint/float64/complex64/time.Time/time.Duration/error</code>等）就表示该类型的字段，<code>zap.Typep</code>以<code>p</code>结尾表示该类型指针的字段，<code>zap.Types</code>以<code>s</code>结尾表示该类型切片的字段。如：</p>
<ul>
<li><code>zap.Bool(key string, val bool) Field</code>：<code>bool</code>字段</li>
<li><code>zap.Boolp(key string, val *bool) Field</code>：<code>bool</code>指针字段；</li>
<li><code>zap.Bools(key string, val []bool) Field</code>：<code>bool</code>切片字段。</li>
</ul>
<p>当然也有一些特殊类型的字段：</p>
<ul>
<li><code>zap.Any(key string, value interface{}) Field</code>：任意类型的字段；</li>
<li><code>zap.Binary(key string, val []byte) Field</code>：二进制串的字段。</li>
</ul>
<p>当然，每个字段都用方法包一层用起来比较繁琐。<code>zap</code>也提供了便捷的方法<code>SugarLogger</code>，可以使用<code>printf</code>格式符的方式。调用<code>logger.Sugar()</code>即可创建<code>SugaredLogger</code>。<code>SugaredLogger</code>的使用比<code>Logger</code>简单，只是性能比<code>Logger</code>低 50% 左右，可以用在非热点函数中。调用<code>SugarLogger</code>以<code>f</code>结尾的方法与<code>fmt.Printf</code>没什么区别，如例子中的<code>Infof</code>。同时<code>SugarLogger</code>还支持以<code>w</code>结尾的方法，这种方式不需要先创建字段对象，直接将字段名和值依次放在参数中即可，如例子中的<code>Infow</code>。</p>
<p>默认情况下，<code>Example</code>输出的日志为 JSON 格式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="p">{</span><span class="s">&#34;level&#34;</span><span class="p">:</span><span class="s">&#34;info&#34;</span><span class="p">,</span><span class="s">&#34;msg&#34;</span><span class="p">:</span><span class="s">&#34;failed to fetch URL&#34;</span><span class="p">,</span><span class="s">&#34;url&#34;</span><span class="p">:</span><span class="s">&#34;http://example.org/api&#34;</span><span class="p">,</span><span class="s">&#34;attempt&#34;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="s">&#34;backoff&#34;</span><span class="p">:</span><span class="s">&#34;1s&#34;</span><span class="p">}</span>
<span class="p">{</span><span class="s">&#34;level&#34;</span><span class="p">:</span><span class="s">&#34;info&#34;</span><span class="p">,</span><span class="s">&#34;msg&#34;</span><span class="p">:</span><span class="s">&#34;failed to fetch URL&#34;</span><span class="p">,</span><span class="s">&#34;url&#34;</span><span class="p">:</span><span class="s">&#34;http://example.org/api&#34;</span><span class="p">,</span><span class="s">&#34;attempt&#34;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="s">&#34;backoff&#34;</span><span class="p">:</span><span class="s">&#34;1s&#34;</span><span class="p">}</span>
<span class="p">{</span><span class="s">&#34;level&#34;</span><span class="p">:</span><span class="s">&#34;info&#34;</span><span class="p">,</span><span class="s">&#34;msg&#34;</span><span class="p">:</span><span class="s">&#34;Failed to fetch URL: http://example.org/api&#34;</span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="记录层级关系">记录层级关系</h2>
<p>前面我们记录的日志都是一层结构，没有嵌套的层级。我们可以使用<code>zap.Namespace(key string) Field</code>构建一个<strong>命名空间</strong>，后续的<code>Field</code>都记录在此命名空间中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">logger</span> <span class="o">:=</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">NewExample</span><span class="p">()</span>
  <span class="k">defer</span> <span class="nx">logger</span><span class="p">.</span><span class="nf">Sync</span><span class="p">()</span>

  <span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;tracked some metrics&#34;</span><span class="p">,</span>
    <span class="nx">zap</span><span class="p">.</span><span class="nf">Namespace</span><span class="p">(</span><span class="s">&#34;metrics&#34;</span><span class="p">),</span>
    <span class="nx">zap</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="s">&#34;counter&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">)</span>

  <span class="nx">logger2</span> <span class="o">:=</span> <span class="nx">logger</span><span class="p">.</span><span class="nf">With</span><span class="p">(</span>
    <span class="nx">zap</span><span class="p">.</span><span class="nf">Namespace</span><span class="p">(</span><span class="s">&#34;metrics&#34;</span><span class="p">),</span>
    <span class="nx">zap</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="s">&#34;counter&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">)</span>
  <span class="nx">logger2</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;tracked some metrics&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="p">{</span><span class="s">&#34;level&#34;</span><span class="p">:</span><span class="s">&#34;info&#34;</span><span class="p">,</span><span class="s">&#34;msg&#34;</span><span class="p">:</span><span class="s">&#34;tracked some metrics&#34;</span><span class="p">,</span><span class="s">&#34;metrics&#34;</span><span class="p">:{</span><span class="s">&#34;counter&#34;</span><span class="p">:</span><span class="mi">1</span><span class="p">}}</span>
<span class="p">{</span><span class="s">&#34;level&#34;</span><span class="p">:</span><span class="s">&#34;info&#34;</span><span class="p">,</span><span class="s">&#34;msg&#34;</span><span class="p">:</span><span class="s">&#34;tracked some metrices&#34;</span><span class="p">,</span><span class="s">&#34;metrics&#34;</span><span class="p">:{</span><span class="s">&#34;counter&#34;</span><span class="p">:</span><span class="mi">1</span><span class="p">}}</span>
</code></pre></td></tr></table>
</div>
</div><p>上面我们演示了两种<code>Namespace</code>的用法，一种是直接作为字段传入<code>Debug/Info</code>等方法，一种是调用<code>With()</code>创建一个新的<code>Logger</code>，新的<code>Logger</code>记录日志时总是带上预设的字段。<code>With()</code>方法实际上是创建了一个新的<code>Logger</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="c1">// src/go.uber.org/zap/logger.go
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">log</span> <span class="o">*</span><span class="nx">Logger</span><span class="p">)</span> <span class="nf">With</span><span class="p">(</span><span class="nx">fields</span> <span class="o">...</span><span class="nx">Field</span><span class="p">)</span> <span class="o">*</span><span class="nx">Logger</span> <span class="p">{</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">fields</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">log</span>
  <span class="p">}</span>
  <span class="nx">l</span> <span class="o">:=</span> <span class="nx">log</span><span class="p">.</span><span class="nf">clone</span><span class="p">()</span>
  <span class="nx">l</span><span class="p">.</span><span class="nx">core</span> <span class="p">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">core</span><span class="p">.</span><span class="nf">With</span><span class="p">(</span><span class="nx">fields</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">l</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="定制logger">定制<code>Logger</code></h2>
<p>调用<code>NexExample()/NewDevelopment()/NewProduction()</code>这 3 个方法，<code>zap</code>使用默认的配置。我们也可以手动调整，配置结构如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="c1">// src/go.uber.org/zap/config.go
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Config</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Level</span> <span class="nx">AtomicLevel</span> <span class="s">`json:&#34;level&#34; yaml:&#34;level&#34;`</span>
  <span class="nx">Encoding</span> <span class="kt">string</span> <span class="s">`json:&#34;encoding&#34; yaml:&#34;encoding&#34;`</span>
  <span class="nx">EncoderConfig</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nx">EncoderConfig</span> <span class="s">`json:&#34;encoderConfig&#34; yaml:&#34;encoderConfig&#34;`</span>
  <span class="nx">OutputPaths</span> <span class="p">[]</span><span class="kt">string</span> <span class="s">`json:&#34;outputPaths&#34; yaml:&#34;outputPaths&#34;`</span>
  <span class="nx">ErrorOutputPaths</span> <span class="p">[]</span><span class="kt">string</span> <span class="s">`json:&#34;errorOutputPaths&#34; yaml:&#34;errorOutputPaths&#34;`</span>
  <span class="nx">InitialFields</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span> <span class="s">`json:&#34;initialFields&#34; yaml:&#34;initialFields&#34;`</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><code>Level</code>：日志级别；</li>
<li><code>Encoding</code>：输出的日志格式，默认为 JSON；</li>
<li><code>OutputPaths</code>：可以配置多个输出路径，路径可以是文件路径和<code>stdout</code>（标准输出）；</li>
<li><code>ErrorOutputPaths</code>：错误输出路径，也可以是多个；</li>
<li><code>InitialFields</code>：每条日志中都会输出这些值。</li>
</ul>
<p>其中<code>EncoderConfig</code>为编码配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="c1">// src/go.uber.org/zap/zapcore/encoder.go
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">EncoderConfig</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">MessageKey</span>    <span class="kt">string</span> <span class="s">`json:&#34;messageKey&#34; yaml:&#34;messageKey&#34;`</span>
  <span class="nx">LevelKey</span>      <span class="kt">string</span> <span class="s">`json:&#34;levelKey&#34; yaml:&#34;levelKey&#34;`</span>
  <span class="nx">TimeKey</span>       <span class="kt">string</span> <span class="s">`json:&#34;timeKey&#34; yaml:&#34;timeKey&#34;`</span>
  <span class="nx">NameKey</span>       <span class="kt">string</span> <span class="s">`json:&#34;nameKey&#34; yaml:&#34;nameKey&#34;`</span>
  <span class="nx">CallerKey</span>     <span class="kt">string</span> <span class="s">`json:&#34;callerKey&#34; yaml:&#34;callerKey&#34;`</span>
  <span class="nx">StacktraceKey</span> <span class="kt">string</span> <span class="s">`json:&#34;stacktraceKey&#34; yaml:&#34;stacktraceKey&#34;`</span>
  <span class="nx">LineEnding</span>    <span class="kt">string</span> <span class="s">`json:&#34;lineEnding&#34; yaml:&#34;lineEnding&#34;`</span>
  <span class="nx">EncodeLevel</span>    <span class="nx">LevelEncoder</span>    <span class="s">`json:&#34;levelEncoder&#34; yaml:&#34;levelEncoder&#34;`</span>
  <span class="nx">EncodeTime</span>     <span class="nx">TimeEncoder</span>     <span class="s">`json:&#34;timeEncoder&#34; yaml:&#34;timeEncoder&#34;`</span>
  <span class="nx">EncodeDuration</span> <span class="nx">DurationEncoder</span> <span class="s">`json:&#34;durationEncoder&#34; yaml:&#34;durationEncoder&#34;`</span>
  <span class="nx">EncodeCaller</span>   <span class="nx">CallerEncoder</span>   <span class="s">`json:&#34;callerEncoder&#34; yaml:&#34;callerEncoder&#34;`</span>
  <span class="nx">EncodeName</span> <span class="nx">NameEncoder</span> <span class="s">`json:&#34;nameEncoder&#34; yaml:&#34;nameEncoder&#34;`</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><code>MessageKey</code>：日志中信息的键名，默认为<code>msg</code>；</li>
<li><code>LevelKey</code>：日志中级别的键名，默认为<code>level</code>；</li>
<li><code>EncodeLevel</code>：日志中级别的格式，默认为小写，如<code>debug/info</code>。</li>
</ul>
<p>调用<code>zap.Config</code>的<code>Build()</code>方法即可使用该配置对象创建一个<code>Logger</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">rawJSON</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{
</span><span class="s">    &#34;level&#34;:&#34;debug&#34;,
</span><span class="s">    &#34;encoding&#34;:&#34;json&#34;,
</span><span class="s">    &#34;outputPaths&#34;: [&#34;stdout&#34;, &#34;server.log&#34;],
</span><span class="s">    &#34;errorOutputPaths&#34;: [&#34;stderr&#34;],
</span><span class="s">    &#34;initialFields&#34;:{&#34;name&#34;:&#34;dj&#34;},
</span><span class="s">    &#34;encoderConfig&#34;: {
</span><span class="s">      &#34;messageKey&#34;: &#34;message&#34;,
</span><span class="s">      &#34;levelKey&#34;: &#34;level&#34;,
</span><span class="s">      &#34;levelEncoder&#34;: &#34;lowercase&#34;
</span><span class="s">    }
</span><span class="s">  }`</span><span class="p">)</span>

  <span class="kd">var</span> <span class="nx">cfg</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">Config</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">rawJSON</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">cfg</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="nx">logger</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cfg</span><span class="p">.</span><span class="nf">Build</span><span class="p">()</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">defer</span> <span class="nx">logger</span><span class="p">.</span><span class="nf">Sync</span><span class="p">()</span>

  <span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;server start work successfully!&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>上面创建一个输出到标准输出<code>stdout</code>和文件<code>server.log</code>的<code>Logger</code>。观察输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="p">{</span><span class="s">&#34;level&#34;</span><span class="p">:</span><span class="s">&#34;info&#34;</span><span class="p">,</span><span class="s">&#34;message&#34;</span><span class="p">:</span><span class="s">&#34;server start work successfully!&#34;</span><span class="p">,</span><span class="s">&#34;name&#34;</span><span class="p">:</span><span class="s">&#34;dj&#34;</span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>使用<code>NewDevelopment()</code>创建的<code>Logger</code>使用的是如下的配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="c1">// src/go.uber.org/zap/config.go
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewDevelopmentConfig</span><span class="p">()</span> <span class="nx">Config</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">Config</span><span class="p">{</span>
    <span class="nx">Level</span><span class="p">:</span>            <span class="nf">NewAtomicLevelAt</span><span class="p">(</span><span class="nx">DebugLevel</span><span class="p">),</span>
    <span class="nx">Development</span><span class="p">:</span>      <span class="kc">true</span><span class="p">,</span>
    <span class="nx">Encoding</span><span class="p">:</span>         <span class="s">&#34;console&#34;</span><span class="p">,</span>
    <span class="nx">EncoderConfig</span><span class="p">:</span>    <span class="nf">NewDevelopmentEncoderConfig</span><span class="p">(),</span>
    <span class="nx">OutputPaths</span><span class="p">:</span>      <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;stderr&#34;</span><span class="p">},</span>
    <span class="nx">ErrorOutputPaths</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;stderr&#34;</span><span class="p">},</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewDevelopmentEncoderConfig</span><span class="p">()</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nx">EncoderConfig</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nx">EncoderConfig</span><span class="p">{</span>
    <span class="c1">// Keys can be anything except the empty string.
</span><span class="c1"></span>    <span class="nx">TimeKey</span><span class="p">:</span>        <span class="s">&#34;T&#34;</span><span class="p">,</span>
    <span class="nx">LevelKey</span><span class="p">:</span>       <span class="s">&#34;L&#34;</span><span class="p">,</span>
    <span class="nx">NameKey</span><span class="p">:</span>        <span class="s">&#34;N&#34;</span><span class="p">,</span>
    <span class="nx">CallerKey</span><span class="p">:</span>      <span class="s">&#34;C&#34;</span><span class="p">,</span>
    <span class="nx">MessageKey</span><span class="p">:</span>     <span class="s">&#34;M&#34;</span><span class="p">,</span>
    <span class="nx">StacktraceKey</span><span class="p">:</span>  <span class="s">&#34;S&#34;</span><span class="p">,</span>
    <span class="nx">LineEnding</span><span class="p">:</span>     <span class="nx">zapcore</span><span class="p">.</span><span class="nx">DefaultLineEnding</span><span class="p">,</span>
    <span class="nx">EncodeLevel</span><span class="p">:</span>    <span class="nx">zapcore</span><span class="p">.</span><span class="nx">CapitalLevelEncoder</span><span class="p">,</span>
    <span class="nx">EncodeTime</span><span class="p">:</span>     <span class="nx">zapcore</span><span class="p">.</span><span class="nx">ISO8601TimeEncoder</span><span class="p">,</span>
    <span class="nx">EncodeDuration</span><span class="p">:</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nx">StringDurationEncoder</span><span class="p">,</span>
    <span class="nx">EncodeCaller</span><span class="p">:</span>   <span class="nx">zapcore</span><span class="p">.</span><span class="nx">ShortCallerEncoder</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>NewProduction()</code>的配置可自行查看。</p>
<h2 id="选项">选项</h2>
<p><code>NewExample()/NewDevelopment()/NewProduction()</code>这 3 个函数可以传入若干类型为<code>zap.Option</code>的选项，从而定制<code>Logger</code>的行为。又一次见到了<strong>选项模式</strong>！！</p>
<p><code>zap</code>提供了丰富的选项供我们选择。</p>
<h3 id="输出文件名和行号">输出文件名和行号</h3>
<p>调用<code>zap.AddCaller()</code>返回的选项设置输出文件名和行号。但是有一个前提，必须设置配置对象<code>Config</code>中的<code>CallerKey</code>字段。也因此<code>NewExample()</code>不能输出这个信息（它的<code>Config</code>没有设置<code>CallerKey</code>）。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">logger</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">NewProduction</span><span class="p">(</span><span class="nx">zap</span><span class="p">.</span><span class="nf">AddCaller</span><span class="p">())</span>
  <span class="k">defer</span> <span class="nx">logger</span><span class="p">.</span><span class="nf">Sync</span><span class="p">()</span>

  <span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;hello world&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="p">{</span><span class="s">&#34;level&#34;</span><span class="p">:</span><span class="s">&#34;info&#34;</span><span class="p">,</span><span class="s">&#34;ts&#34;</span><span class="p">:</span><span class="mf">1587740198.9508286</span><span class="p">,</span><span class="s">&#34;caller&#34;</span><span class="p">:</span><span class="s">&#34;caller/main.go:9&#34;</span><span class="p">,</span><span class="s">&#34;msg&#34;</span><span class="p">:</span><span class="s">&#34;hello world&#34;</span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>Info()</code>方法在<code>main.go</code>的第 9 行被调用。<code>AddCaller()</code>与<code>zap.WithCaller(true)</code>等价。</p>
<p>有时我们稍微封装了一下记录日志的方法，但是我们希望输出的文件名和行号是调用封装函数的位置。这时可以使用<code>zap.AddCallerSkip(skip int)</code>向上跳 1 层：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">func</span> <span class="nf">Output</span><span class="p">(</span><span class="nx">msg</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">fields</span> <span class="o">...</span><span class="nx">zap</span><span class="p">.</span><span class="nx">Field</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">zap</span><span class="p">.</span><span class="nf">L</span><span class="p">().</span><span class="nf">Info</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">fields</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">logger</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">NewProduction</span><span class="p">(</span><span class="nx">zap</span><span class="p">.</span><span class="nf">AddCaller</span><span class="p">(),</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">AddCallerSkip</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
  <span class="k">defer</span> <span class="nx">logger</span><span class="p">.</span><span class="nf">Sync</span><span class="p">()</span>

  <span class="nx">zap</span><span class="p">.</span><span class="nf">ReplaceGlobals</span><span class="p">(</span><span class="nx">logger</span><span class="p">)</span>

  <span class="nf">Output</span><span class="p">(</span><span class="s">&#34;hello world&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="p">{</span><span class="s">&#34;level&#34;</span><span class="p">:</span><span class="s">&#34;info&#34;</span><span class="p">,</span><span class="s">&#34;ts&#34;</span><span class="p">:</span><span class="mf">1587740501.5592482</span><span class="p">,</span><span class="s">&#34;caller&#34;</span><span class="p">:</span><span class="s">&#34;skip/main.go:15&#34;</span><span class="p">,</span><span class="s">&#34;msg&#34;</span><span class="p">:</span><span class="s">&#34;hello world&#34;</span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>输出在<code>main</code>函数中调用<code>Output()</code>的位置。如果不指定<code>zap.AddCallerSkip(1)</code>，将输出<code>&quot;caller&quot;:&quot;skip/main.go:6&quot;</code>，这是在<code>Output()</code>函数中调用<code>zap.Info()</code>的位置。因为这个<code>Output()</code>函数可能在很多地方被调用，所以这个位置参考意义并不大。试试看！</p>
<h3 id="输出调用堆栈">输出调用堆栈</h3>
<p>有时候在某个函数处理中遇到了异常情况，因为这个函数可能在很多地方被调用。如果我们能输出此次调用的堆栈，那么分析起来就会很方便。我们可以使用<code>zap.AddStackTrace(lvl zapcore.LevelEnabler)</code>达成这个目的。该函数指定<code>lvl</code>和之上的级别都需要输出调用堆栈：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">func</span> <span class="nf">f1</span><span class="p">()</span> <span class="p">{</span>
  <span class="nf">f2</span><span class="p">(</span><span class="s">&#34;hello world&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">f2</span><span class="p">(</span><span class="nx">msg</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">fields</span> <span class="o">...</span><span class="nx">zap</span><span class="p">.</span><span class="nx">Field</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">zap</span><span class="p">.</span><span class="nf">L</span><span class="p">().</span><span class="nf">Warn</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">fields</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">logger</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">NewProduction</span><span class="p">(</span><span class="nx">zap</span><span class="p">.</span><span class="nf">AddStacktrace</span><span class="p">(</span><span class="nx">zapcore</span><span class="p">.</span><span class="nx">WarnLevel</span><span class="p">))</span>
  <span class="k">defer</span> <span class="nx">logger</span><span class="p">.</span><span class="nf">Sync</span><span class="p">()</span>

  <span class="nx">zap</span><span class="p">.</span><span class="nf">ReplaceGlobals</span><span class="p">(</span><span class="nx">logger</span><span class="p">)</span>

  <span class="nf">f1</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>将<code>zapcore.WarnLevel</code>传入<code>AddStacktrace()</code>，之后<code>Warn()/Error()</code>等级别的日志会输出堆栈，<code>Debug()/Info()</code>这些级别不会。运行结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="p">{</span><span class="s">&#34;level&#34;</span><span class="p">:</span><span class="s">&#34;warn&#34;</span><span class="p">,</span><span class="s">&#34;ts&#34;</span><span class="p">:</span><span class="mf">1587740883.4965692</span><span class="p">,</span><span class="s">&#34;caller&#34;</span><span class="p">:</span><span class="s">&#34;stacktrace/main.go:13&#34;</span><span class="p">,</span><span class="s">&#34;msg&#34;</span><span class="p">:</span><span class="s">&#34;hello world&#34;</span><span class="p">,</span><span class="s">&#34;stacktrace&#34;</span><span class="p">:</span><span class="s">&#34;main.f2\n\td:/code/golang/src/github.com/darjun/go-daily-lib/zap/option/stacktrace/main.go:13\nmain.f1\n\td:/code/golang/src/github.com/darjun/go-daily-lib/zap/option/stacktrace/main.go:9\nmain.main\n\td:/code/golang/src/github.com/darjun/go-daily-lib/zap/option/stacktrace/main.go:22\nruntime.main\n\tC:/Go/src/runtime/proc.go:203&#34;</span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>把<code>stacktrace</code>单独拉出来：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="nx">main</span><span class="p">.</span><span class="nx">f2</span>
<span class="nx">d</span><span class="p">:</span><span class="o">/</span><span class="nx">code</span><span class="o">/</span><span class="nx">golang</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">darjun</span><span class="o">/</span><span class="k">go</span><span class="o">-</span><span class="nx">daily</span><span class="o">-</span><span class="nx">lib</span><span class="o">/</span><span class="nx">zap</span><span class="o">/</span><span class="nx">option</span><span class="o">/</span><span class="nx">stacktrace</span><span class="o">/</span><span class="nx">main</span><span class="p">.</span><span class="k">go</span><span class="p">:</span><span class="mi">13</span>
  <span class="nx">main</span><span class="p">.</span><span class="nx">f1</span>
  <span class="nx">d</span><span class="p">:</span><span class="o">/</span><span class="nx">code</span><span class="o">/</span><span class="nx">golang</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">darjun</span><span class="o">/</span><span class="k">go</span><span class="o">-</span><span class="nx">daily</span><span class="o">-</span><span class="nx">lib</span><span class="o">/</span><span class="nx">zap</span><span class="o">/</span><span class="nx">option</span><span class="o">/</span><span class="nx">stacktrace</span><span class="o">/</span><span class="nx">main</span><span class="p">.</span><span class="k">go</span><span class="p">:</span><span class="mi">9</span>
    <span class="nx">main</span><span class="p">.</span><span class="nx">main</span>
    <span class="nx">d</span><span class="p">:</span><span class="o">/</span><span class="nx">code</span><span class="o">/</span><span class="nx">golang</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">darjun</span><span class="o">/</span><span class="k">go</span><span class="o">-</span><span class="nx">daily</span><span class="o">-</span><span class="nx">lib</span><span class="o">/</span><span class="nx">zap</span><span class="o">/</span><span class="nx">option</span><span class="o">/</span><span class="nx">stacktrace</span><span class="o">/</span><span class="nx">main</span><span class="p">.</span><span class="k">go</span><span class="p">:</span><span class="mi">22</span>
      <span class="nx">runtime</span><span class="p">.</span><span class="nx">main</span>
      <span class="nx">C</span><span class="p">:</span><span class="o">/</span><span class="nx">Go</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">runtime</span><span class="o">/</span><span class="nx">proc</span><span class="p">.</span><span class="k">go</span><span class="p">:</span><span class="mi">203</span>
</code></pre></td></tr></table>
</div>
</div><p>很清楚地看到调用路径。</p>
<h2 id="全局logger">全局<code>Logger</code></h2>
<p>为了方便使用，<code>zap</code>提供了两个全局的<code>Logger</code>，一个是<code>*zap.Logger</code>，可调用<code>zap.L()</code>获得；另一个是<code>*zap.SugaredLogger</code>，可调用<code>zap.S()</code>获得。需要注意的是，全局的<code>Logger</code>默认并不会记录日志！它是一个无实际效果的<code>Logger</code>。看源码:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="c1">// go.uber.org/zap/global.go
</span><span class="c1"></span><span class="kd">var</span> <span class="p">(</span>
  <span class="nx">_globalMu</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
  <span class="nx">_globalL</span>  <span class="p">=</span> <span class="nf">NewNop</span><span class="p">()</span>
  <span class="nx">_globalS</span>  <span class="p">=</span> <span class="nx">_globalL</span><span class="p">.</span><span class="nf">Sugar</span><span class="p">()</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>我们可以使用<code>ReplaceGlobals(logger *Logger) func()</code>将<code>logger</code>设置为全局的<code>Logger</code>，该函数返回一个无参函数，用于恢复全局<code>Logger</code>设置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">zap</span><span class="p">.</span><span class="nf">L</span><span class="p">().</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;global Logger before&#34;</span><span class="p">)</span>
  <span class="nx">zap</span><span class="p">.</span><span class="nf">S</span><span class="p">().</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;global SugaredLogger before&#34;</span><span class="p">)</span>

  <span class="nx">logger</span> <span class="o">:=</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">NewExample</span><span class="p">()</span>
  <span class="k">defer</span> <span class="nx">logger</span><span class="p">.</span><span class="nf">Sync</span><span class="p">()</span>

  <span class="nx">zap</span><span class="p">.</span><span class="nf">ReplaceGlobals</span><span class="p">(</span><span class="nx">logger</span><span class="p">)</span>
  <span class="nx">zap</span><span class="p">.</span><span class="nf">L</span><span class="p">().</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;global Logger after&#34;</span><span class="p">)</span>
  <span class="nx">zap</span><span class="p">.</span><span class="nf">S</span><span class="p">().</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;global SugaredLogger after&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="p">{</span><span class="s">&#34;level&#34;</span><span class="p">:</span><span class="s">&#34;info&#34;</span><span class="p">,</span><span class="s">&#34;msg&#34;</span><span class="p">:</span><span class="s">&#34;global Logger after&#34;</span><span class="p">}</span>
<span class="p">{</span><span class="s">&#34;level&#34;</span><span class="p">:</span><span class="s">&#34;info&#34;</span><span class="p">,</span><span class="s">&#34;msg&#34;</span><span class="p">:</span><span class="s">&#34;global SugaredLogger after&#34;</span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到在调用<code>ReplaceGlobals</code>之前记录的日志并没有输出。</p>
<h3 id="预设日志字段">预设日志字段</h3>
<p>如果每条日志都要记录一些共用的字段，那么使用<code>zap.Fields(fs ...Field)</code>创建的选项。例如在服务器日志中记录可能都需要记录<code>serverId</code>和<code>serverName</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">logger</span> <span class="o">:=</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">NewExample</span><span class="p">(</span><span class="nx">zap</span><span class="p">.</span><span class="nf">Fields</span><span class="p">(</span>
    <span class="nx">zap</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="s">&#34;serverId&#34;</span><span class="p">,</span> <span class="mi">90</span><span class="p">),</span>
    <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;serverName&#34;</span><span class="p">,</span> <span class="s">&#34;awesome web&#34;</span><span class="p">),</span>
  <span class="p">))</span>

  <span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;hello world&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="p">{</span><span class="s">&#34;level&#34;</span><span class="p">:</span><span class="s">&#34;info&#34;</span><span class="p">,</span><span class="s">&#34;msg&#34;</span><span class="p">:</span><span class="s">&#34;hello world&#34;</span><span class="p">,</span><span class="s">&#34;serverId&#34;</span><span class="p">:</span><span class="mi">90</span><span class="p">,</span><span class="s">&#34;serverName&#34;</span><span class="p">:</span><span class="s">&#34;awesome web&#34;</span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="与标准日志库搭配使用">与标准日志库搭配使用</h2>
<p>如果项目一开始使用的是标准日志库<code>log</code>，后面想转为<code>zap</code>。这时不必修改每一个文件。我们可以调用<code>zap.NewStdLog(l *Logger) *log.Logger</code>返回一个标准的<code>log.Logger</code>，内部实际上写入的还是我们之前创建的<code>zap.Logger</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">logger</span> <span class="o">:=</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">NewExample</span><span class="p">()</span>
  <span class="k">defer</span> <span class="nx">logger</span><span class="p">.</span><span class="nf">Sync</span><span class="p">()</span>

  <span class="nx">std</span> <span class="o">:=</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">NewStdLog</span><span class="p">(</span><span class="nx">logger</span><span class="p">)</span>
  <span class="nx">std</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="s">&#34;standard logger wrapper&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="p">{</span><span class="s">&#34;level&#34;</span><span class="p">:</span><span class="s">&#34;info&#34;</span><span class="p">,</span><span class="s">&#34;msg&#34;</span><span class="p">:</span><span class="s">&#34;standard logger wrapper&#34;</span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>很方便不是吗？我们还可以使用<code>NewStdLogAt(l *logger, level zapcore.Level) (*log.Logger, error)</code>让标准接口以<code>level</code>级别写入内部的<code>*zap.Logger</code>。</p>
<p>如果我们只是想在一段代码内使用标准日志库<code>log</code>，其它地方还是使用<code>zap.Logger</code>。可以调用<code>RedirectStdLog(l *Logger) func()</code>。它会返回一个无参函数恢复设置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">logger</span> <span class="o">:=</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">NewExample</span><span class="p">()</span>
  <span class="k">defer</span> <span class="nx">logger</span><span class="p">.</span><span class="nf">Sync</span><span class="p">()</span>

  <span class="nx">undo</span> <span class="o">:=</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">RedirectStdLog</span><span class="p">(</span><span class="nx">logger</span><span class="p">)</span>
  <span class="nx">log</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="s">&#34;redirected standard library&#34;</span><span class="p">)</span>
  <span class="nf">undo</span><span class="p">()</span>

  <span class="nx">log</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="s">&#34;restored standard library&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>看前后输出变化：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="p">{</span><span class="s">&#34;level&#34;</span><span class="p">:</span><span class="s">&#34;info&#34;</span><span class="p">,</span><span class="s">&#34;msg&#34;</span><span class="p">:</span><span class="s">&#34;redirected standard library&#34;</span><span class="p">}</span>
<span class="mi">2020</span><span class="o">/</span><span class="mo">04</span><span class="o">/</span><span class="mi">24</span> <span class="mi">22</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mi">58</span> <span class="nx">restored</span> <span class="nx">standard</span> <span class="nx">library</span>
</code></pre></td></tr></table>
</div>
</div><p>当然<code>RedirectStdLog</code>也有一个对应的<code>RedirectStdLogAt</code>以特定的级别调用内部的<code>*zap.Logger</code>方法。</p>
<h2 id="总结">总结</h2>
<p><code>zap</code>用在日志性能和内存分配比较关键的地方。本文仅介绍了<code>zap</code>库的基本使用，子包<code>zapcore</code>中有更底层的接口，可以定制丰富多样的<code>Logger</code>。</p>
<p>大家如果发现好玩、好用的 Go 语言库，欢迎到 Go 每日一库 GitHub 上提交 issue😄</p>
<h2 id="参考">参考</h2>
<ol>
<li>zap GitHub：<a href="https://github.com/jordan-wright/zap">https://github.com/jordan-wright/zap</a></li>
<li>Go 每日一库 GitHub：<a href="https://github.com/darjun/go-daily-lib">https://github.com/darjun/go-daily-lib</a></li>
</ol>
<h2 id="我">我</h2>
<p>我的博客：<a href="https://darjun.github.io">https://darjun.github.io</a></p>
<p>欢迎关注我的微信公众号【GoUpUp】，共同学习，一起进步~</p>
<p><img src="/img/wxgzh8.jpg#center" alt=""></p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">darjun</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
      2020-04-23
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/2020/04/24/godailylib/zerolog/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">Go 每日一库之 zerolog</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/2020/04/22/godailylib/go-app/">
            <span class="next-text nav-default">Go 每日一库之 go-app</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "darjun/blog-comments"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:leedarjun@gmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/darjun" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>


<a href="https://darjun.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2018 -
    2022
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        大俊
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>












</body>
</html>
