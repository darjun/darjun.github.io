<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Go 每日一库之 govaluate - 大俊的博客</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="darjun" />
  <meta name="description" content="简介 今天我们介绍一个比较好玩的库govaluate。govaluate与 JavaScript 中的eval功能类似，用于计算任意表达式的值。此类功能函数在 JavaScript/Python 等动" />

  <meta name="keywords" content="大俊, 大俊的博客, go, golang, gopher" />






<meta name="generator" content="Hugo 0.60.0-DEV" />


<link rel="canonical" href="https://darjun.github.io/2020/04/01/godailylib/govaluate/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.0995afa14b62cd93e93cfc066b646c4c17a3eddca0e9d52a1d9dcf5d90aaacd3.css" integrity="sha256-CZWvoUtizZPpPPwGa2RsTBej7dyg6dUqHZ3PXZCqrNM=" media="screen" crossorigin="anonymous">




<link rel="stylesheet" href="/css/custom.css">


<meta property="og:title" content="Go 每日一库之 govaluate" />
<meta property="og:description" content="简介 今天我们介绍一个比较好玩的库govaluate。govaluate与 JavaScript 中的eval功能类似，用于计算任意表达式的值。此类功能函数在 JavaScript/Python 等动" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://darjun.github.io/2020/04/01/godailylib/govaluate/" />
<meta property="article:published_time" content="2020-04-01T14:06:23+00:00" />
<meta property="article:modified_time" content="2020-04-01T14:06:23+00:00" />
<meta itemprop="name" content="Go 每日一库之 govaluate">
<meta itemprop="description" content="简介 今天我们介绍一个比较好玩的库govaluate。govaluate与 JavaScript 中的eval功能类似，用于计算任意表达式的值。此类功能函数在 JavaScript/Python 等动">


<meta itemprop="datePublished" content="2020-04-01T14:06:23&#43;00:00" />
<meta itemprop="dateModified" content="2020-04-01T14:06:23&#43;00:00" />
<meta itemprop="wordCount" content="3636">



<meta itemprop="keywords" content="Go 每日一库," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Go 每日一库之 govaluate"/>
<meta name="twitter:description" content="简介 今天我们介绍一个比较好玩的库govaluate。govaluate与 JavaScript 中的eval功能类似，用于计算任意表达式的值。此类功能函数在 JavaScript/Python 等动"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-42862533-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">大俊</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/">首页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/post/">归档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/about/">关于我</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/darjun" rel="noopener" target="_blank">
              Github
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      大俊
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/">首页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/post/">归档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/about/">关于我</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/darjun" rel="noopener" target="_blank">
              Github
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Go 每日一库之 govaluate</h1>
      
      <div class="post-meta">
        <time datetime="2020-04-01" class="post-time">
          2020-04-01
        </time>
        <div class="post-category">
            <a href="https://darjun.github.io/categories/go/"> Go </a>
            
          </div>
        <span class="more-meta"> 约 3636 字 </span>
          <span class="more-meta"> 预计阅读 8 分钟 </span>

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#简介">简介</a></li>
<li><a href="#快速使用">快速使用</a></li>
<li><a href="#参数">参数</a></li>
<li><a href="#命名">命名</a></li>
<li><a href="#一次-编译-多次运行">一次“编译”多次运行</a></li>
<li><a href="#函数">函数</a></li>
<li><a href="#访问器">访问器</a></li>
<li><a href="#支持的操作和类型">支持的操作和类型</a></li>
<li><a href="#错误处理">错误处理</a></li>
<li><a href="#总结">总结</a></li>
<li><a href="#参考">参考</a></li>
<li><a href="#我">我</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      

<h2 id="简介">简介</h2>

<p>今天我们介绍一个比较好玩的库<a href="https://github.com/Knetic/govaluate"><code>govaluate</code></a>。<code>govaluate</code>与 JavaScript 中的<code>eval</code>功能类似，用于计算任意表达式的值。此类功能函数在 JavaScript/Python 等动态语言中比较常见。<code>govaluate</code>让 Go 这个编译型语言也有了这个能力！</p>

<h2 id="快速使用">快速使用</h2>

<p>先安装：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="err">$</span> <span class="k">go</span> <span class="nx">get</span> <span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">Knetic</span><span class="o">/</span><span class="nx">govaluate</span></code></pre></td></tr></table>
</div>
</div>
<p>后使用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
  <span class="s">&#34;fmt&#34;</span>
  <span class="s">&#34;log&#34;</span>

  <span class="s">&#34;github.com/Knetic/govaluate&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">expr</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">govaluate</span><span class="p">.</span><span class="nf">NewEvaluableExpression</span><span class="p">(</span><span class="s">&#34;10 &gt; 0&#34;</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;syntax error:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">expr</span><span class="p">.</span><span class="nf">Evaluate</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;evaluate error:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>使用<code>govaluate</code>计算表达式只需要两步：</p>

<ul>
<li>调用<code>NewEvaluableExpression()</code>将表达式转为一个<strong>表达式对象</strong>；</li>
<li>调用表达式对象的<code>Evaluate</code>方法，传入参数，返回表达式的值。</li>
</ul>

<p>上面演示了一个很简单的例子，我们使用<code>govaluate</code>计算<code>10 &gt; 0</code>的值，该表达式不需要参数，故传给<code>Evaluate()</code>方法<code>nil</code>值。当然，这个例子并不实用，显然我们直接在代码中计算<code>10 &gt; 0</code>更简单。但问题是，有些时候我们并不知道需要计算的表达式的所有信息，甚至我们都不知道表达式的结构。这时<code>govaluate</code>的作用就体现出来了。</p>

<h2 id="参数">参数</h2>

<p><code>govaluate</code>支持在表达式中使用参数，调用表达式对象的<code>Evaluate()</code>方法时通过<code>map[string]interface{}</code>类型将参数传入计算。其中<code>map</code>的键为参数名，值为参数值。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">expr</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">govaluate</span><span class="p">.</span><span class="nf">NewEvaluableExpression</span><span class="p">(</span><span class="s">&#34;foo &gt; 0&#34;</span><span class="p">)</span>
  <span class="nx">parameters</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{})</span>
  <span class="nx">parameters</span><span class="p">[</span><span class="s">&#34;foo&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span>
  <span class="nx">result</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">expr</span><span class="p">.</span><span class="nf">Evaluate</span><span class="p">(</span><span class="nx">parameters</span><span class="p">)</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>

  <span class="nx">expr</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">govaluate</span><span class="p">.</span><span class="nf">NewEvaluableExpression</span><span class="p">(</span><span class="s">&#34;(requests_made * requests_succeeded / 100) &gt;= 90&#34;</span><span class="p">)</span>
  <span class="nx">parameters</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{})</span>
  <span class="nx">parameters</span><span class="p">[</span><span class="s">&#34;requests_made&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="mi">100</span>
  <span class="nx">parameters</span><span class="p">[</span><span class="s">&#34;requests_succeeded&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="mi">80</span>
  <span class="nx">result</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">expr</span><span class="p">.</span><span class="nf">Evaluate</span><span class="p">(</span><span class="nx">parameters</span><span class="p">)</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>

  <span class="nx">expr</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">govaluate</span><span class="p">.</span><span class="nf">NewEvaluableExpression</span><span class="p">(</span><span class="s">&#34;(mem_used / total_mem) * 100&#34;</span><span class="p">)</span>
  <span class="nx">parameters</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{})</span>
  <span class="nx">parameters</span><span class="p">[</span><span class="s">&#34;total_mem&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="mi">1024</span>
  <span class="nx">parameters</span><span class="p">[</span><span class="s">&#34;mem_used&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="mi">512</span>
  <span class="nx">result</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">expr</span><span class="p">.</span><span class="nf">Evaluate</span><span class="p">(</span><span class="nx">parameters</span><span class="p">)</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>第一个表达式中，我们想要计算<code>foo &gt; 0</code>的结果，在传入参数中将<code>foo</code>设置为 -1，最终输出<code>false</code>。</p>

<p>第二个表达式中，我们想要计算<code>(requests_made * requests_succeeded / 100) &gt;= 90</code>的值，在参数中设置<code>requests_made</code>为 100，<code>requests_succeeded</code>为 80，结果为<code>true</code>。</p>

<p>上面两个表达式都返回<code>bool</code>结果，第三个表达式返回一个浮点数。<code>(mem_used / total_mem) * 100</code>根据传入的总内存<code>total_mem</code>和当前使用内存<code>mem_used</code>，返回内存占用百分比，结果为 50。</p>

<h2 id="命名">命名</h2>

<p>使用<code>govaluate</code>与直接编写 Go 代码不同，在 Go 代码中标识符中不能出现<code>-</code>、<code>+</code>、<code>$</code>等符号。<code>govaluate</code>可以通过转义使用这些符号。有两种转义方式：</p>

<ul>
<li>将名称用<code>[</code>和<code>]</code>包裹起来，例如<code>[response-time]</code>；</li>
<li>使用<code>\</code>将紧接着<strong>下一个</strong>的字符转义。</li>
</ul>

<p>例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">expr</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">govaluate</span><span class="p">.</span><span class="nf">NewEvaluableExpression</span><span class="p">(</span><span class="s">&#34;[response-time] &lt; 100&#34;</span><span class="p">)</span>
  <span class="nx">parameters</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{})</span>
  <span class="nx">parameters</span><span class="p">[</span><span class="s">&#34;response-time&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="mi">80</span>
  <span class="nx">result</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">expr</span><span class="p">.</span><span class="nf">Evaluate</span><span class="p">(</span><span class="nx">parameters</span><span class="p">)</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>

  <span class="nx">expr</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">govaluate</span><span class="p">.</span><span class="nf">NewEvaluableExpression</span><span class="p">(</span><span class="s">&#34;response\\-time &lt; 100&#34;</span><span class="p">)</span>
  <span class="nx">parameters</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{})</span>
  <span class="nx">parameters</span><span class="p">[</span><span class="s">&#34;response-time&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="mi">80</span>
  <span class="nx">result</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">expr</span><span class="p">.</span><span class="nf">Evaluate</span><span class="p">(</span><span class="nx">parameters</span><span class="p">)</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>注意一点，因为在字符串中<code>\</code>本身就是需要转义的，所以在第二个表达式中要使用<code>\\</code>。或者可以使用</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="s">`response\-time`</span> <span class="p">&lt;</span> <span class="mi">100</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="一次-编译-多次运行">一次“编译”多次运行</h2>

<p>使用带参数的表达式，我们可以实现一个表达式的一次“编译”，多次运行。只需要使用编译返回的表达式对象即可，可多次调用其<code>Evaluate()</code>方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">expr</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">govaluate</span><span class="p">.</span><span class="nf">NewEvaluableExpression</span><span class="p">(</span><span class="s">&#34;a + b&#34;</span><span class="p">)</span>
  <span class="nx">parameters</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{})</span>
  <span class="nx">parameters</span><span class="p">[</span><span class="s">&#34;a&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="mi">1</span>
  <span class="nx">parameters</span><span class="p">[</span><span class="s">&#34;b&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="mi">2</span>
  <span class="nx">result</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">expr</span><span class="p">.</span><span class="nf">Evaluate</span><span class="p">(</span><span class="nx">parameters</span><span class="p">)</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>

  <span class="nx">parameters</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{})</span>
  <span class="nx">parameters</span><span class="p">[</span><span class="s">&#34;a&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="mi">10</span>
  <span class="nx">parameters</span><span class="p">[</span><span class="s">&#34;b&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="mi">20</span>
  <span class="nx">result</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">expr</span><span class="p">.</span><span class="nf">Evaluate</span><span class="p">(</span><span class="nx">parameters</span><span class="p">)</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>第一次运行，传入参数<code>a = 1, b = 2</code>得到结果 3；第二次运行，传入参数<code>a = 10, b = 20</code>得到结果 30。</p>

<h2 id="函数">函数</h2>

<p>如果仅仅能进行常规的算数和逻辑运算，<code>govaluate</code>的功能会大打折扣。<code>govaluate</code>提供了自定义函数的功能。所有自定义函数需要先定义好，存入一个<code>map[string]govaluate.ExpressionFunction</code>变量中，然后调用<code>govaluate.NewEvaluableExpressionWithFunctions()</code>生成表达式，此表达式中就可以使用这些函数了。自定义函数类型为<code>func (args ...interface{}) (interface{}, error)</code>，如果函数返回错误，则这个表达式求值返回错误。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">functions</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">govaluate</span><span class="p">.</span><span class="nx">ExpressionFunction</span><span class="p">{</span>
    <span class="s">&#34;strlen&#34;</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">args</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">length</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].(</span><span class="kt">string</span><span class="p">))</span>
      <span class="k">return</span> <span class="nx">length</span><span class="p">,</span> <span class="kc">nil</span>
    <span class="p">},</span>
  <span class="p">}</span>

  <span class="nx">exprString</span> <span class="o">:=</span> <span class="s">&#34;strlen(&#39;teststring&#39;)&#34;</span>
  <span class="nx">expr</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">govaluate</span><span class="p">.</span><span class="nf">NewEvaluableExpressionWithFunctions</span><span class="p">(</span><span class="nx">exprString</span><span class="p">,</span> <span class="nx">functions</span><span class="p">)</span>
  <span class="nx">result</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">expr</span><span class="p">.</span><span class="nf">Evaluate</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>上面例子中，我们定义一个函数<code>strlen</code>计算第一个参数的字符串长度。表达式<code>strlen('teststring')</code>调用<code>strlen</code>函数返回字符串<code>teststring</code>的长度。</p>

<p>函数可以接受任意数量的参数，而且可以处理嵌套函数调用的问题。所以可以写出类似下面这种复杂的表达式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="nf">sqrt</span><span class="p">(</span><span class="nx">x1</span> <span class="o">**</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span> <span class="o">**</span> <span class="nx">y2</span><span class="p">)</span>

<span class="nf">max</span><span class="p">(</span><span class="nx">someValue</span><span class="p">,</span> <span class="nf">abs</span><span class="p">(</span><span class="nx">anotherValue</span><span class="p">),</span> <span class="mi">10</span> <span class="o">*</span> <span class="nx">lastValue</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="访问器">访问器</h2>

<p>在 Go 语言中，访问器（<code>Accessors</code>）就是通过<code>.</code>操作访问结构中的字段。如果传入的参数中有结构体类型，<code>govaluate</code>也支持使用<code>.</code>访问其内部字段或调用它们的方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">type</span> <span class="nx">User</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">FirstName</span> <span class="kt">string</span>
  <span class="nx">LastName</span>  <span class="kt">string</span>
  <span class="nx">Age</span>       <span class="kt">int</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">u</span> <span class="nx">User</span><span class="p">)</span> <span class="nf">Fullname</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">u</span><span class="p">.</span><span class="nx">FirstName</span> <span class="o">+</span> <span class="s">&#34; &#34;</span> <span class="o">+</span> <span class="nx">u</span><span class="p">.</span><span class="nx">LastName</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">u</span> <span class="o">:=</span> <span class="nx">User</span><span class="p">{</span><span class="nx">FirstName</span><span class="p">:</span> <span class="s">&#34;li&#34;</span><span class="p">,</span> <span class="nx">LastName</span><span class="p">:</span> <span class="s">&#34;dajun&#34;</span><span class="p">,</span> <span class="nx">Age</span><span class="p">:</span> <span class="mi">18</span><span class="p">}</span>
  <span class="nx">parameters</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{})</span>
  <span class="nx">parameters</span><span class="p">[</span><span class="s">&#34;u&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">u</span>

  <span class="nx">expr</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">govaluate</span><span class="p">.</span><span class="nf">NewEvaluableExpression</span><span class="p">(</span><span class="s">&#34;u.Fullname()&#34;</span><span class="p">)</span>
  <span class="nx">result</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">expr</span><span class="p">.</span><span class="nf">Evaluate</span><span class="p">(</span><span class="nx">parameters</span><span class="p">)</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;user&#34;</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span>

  <span class="nx">expr</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">govaluate</span><span class="p">.</span><span class="nf">NewEvaluableExpression</span><span class="p">(</span><span class="s">&#34;u.Age &gt; 18&#34;</span><span class="p">)</span>
  <span class="nx">result</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">expr</span><span class="p">.</span><span class="nf">Evaluate</span><span class="p">(</span><span class="nx">parameters</span><span class="p">)</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;age &gt; 18?&#34;</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>在上面代码中，我们定义了一个<code>User</code>结构，并为它编写了一个<code>Fullname()</code>方法。第一个表达式中，我们调用<code>u.Fullname()</code>返回全名，第二个表达式比较年龄是否大于 18。</p>

<p>需要注意的一点是，我们不能使用<code>foo.SomeMap['key']</code>的方式访问<code>map</code>的值。由于访问器涉及到很多反射，所以它一般比直接使用参数慢 4 倍左右。如果能使用参数的形式，尽量使用参数。在上面的例子中，我们可以直接调用<code>u.Fullname()</code>，将结果作为参数传给表达式求值。涉及到复杂的计算可以通过自定义函数来解决。我们还可以实现<code>govaluate.Parameter</code>接口，对于表达式中使用的未知参数，<code>govaluate</code>会自动调用其<code>Get()</code>方法获取：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="c1">// src/github.com/Knetic/govaluate/parameters.go
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Parameters</span> <span class="kd">interface</span> <span class="p">{</span>
  <span class="nf">Get</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>例如，我们可以让<code>User</code>实现<code>Parameter</code>接口：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">type</span> <span class="nx">User</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">FirstName</span> <span class="kt">string</span>
  <span class="nx">LastName</span>  <span class="kt">string</span>
  <span class="nx">Age</span>       <span class="kt">int</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">u</span> <span class="nx">User</span><span class="p">)</span> <span class="nf">Get</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="nx">name</span> <span class="o">==</span> <span class="s">&#34;FullName&#34;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">u</span><span class="p">.</span><span class="nx">FirstName</span> <span class="o">+</span> <span class="s">&#34; &#34;</span> <span class="o">+</span> <span class="nx">u</span><span class="p">.</span><span class="nx">LastName</span><span class="p">,</span> <span class="kc">nil</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;unsupported field &#34;</span> <span class="o">+</span> <span class="nx">name</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">u</span> <span class="o">:=</span> <span class="nx">User</span><span class="p">{</span><span class="nx">FirstName</span><span class="p">:</span> <span class="s">&#34;li&#34;</span><span class="p">,</span> <span class="nx">LastName</span><span class="p">:</span> <span class="s">&#34;dajun&#34;</span><span class="p">,</span> <span class="nx">Age</span><span class="p">:</span> <span class="mi">18</span><span class="p">}</span>
  <span class="nx">expr</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">govaluate</span><span class="p">.</span><span class="nf">NewEvaluableExpression</span><span class="p">(</span><span class="s">&#34;FullName&#34;</span><span class="p">)</span>
  <span class="nx">result</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">expr</span><span class="p">.</span><span class="nf">Eval</span><span class="p">(</span><span class="nx">u</span><span class="p">)</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;user&#34;</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>表达式对象实际上有两个方法，一个是我们前面用的<code>Evaluate()</code>，这个方法接受一个<code>map[string]interface{}</code>参数。另一个就是我们在这个例子中使用的<code>Eval()</code>方法，该方法接受一个<code>Parameter</code>接口。实际上，在<code>Evaluate()</code>实现内部也是调用的<code>Eval()</code>方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="c1">// src/github.com/Knetic/govaluate/EvaluableExpression.go
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">this</span> <span class="nx">EvaluableExpression</span><span class="p">)</span> <span class="nf">Evaluate</span><span class="p">(</span><span class="nx">parameters</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="nx">parameters</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">this</span><span class="p">.</span><span class="nf">Eval</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">this</span><span class="p">.</span><span class="nf">Eval</span><span class="p">(</span><span class="nf">MapParameters</span><span class="p">(</span><span class="nx">parameters</span><span class="p">))</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>在表达式计算时，未知的参数都需要调用<code>Parameter</code>的<code>Get()</code>方法获取。上面的例子中我们直接使用<code>FullName</code>就可以调用<code>u.Get()</code>方法返回全名。</p>

<h2 id="支持的操作和类型">支持的操作和类型</h2>

<p><code>govaluate</code>支持的操作和类型与 Go 语言有些不同。一方面<code>govaluate</code>中的类型和操作不如 Go 丰富，另一方面<code>govaluate</code>也对一些操作进行了扩展。</p>

<p>算数、比较和逻辑运算：</p>

<ul>
<li><code>+</code> <code>-</code> <code>/</code> <code>*</code> <code>&amp;</code> <code>|</code> <code>^</code> <code>**</code> <code>%</code> <code>&gt;&gt;</code> <code>&lt;&lt;</code>：加减乘除，按位与，按位或，异或，乘方，取模，左移和右移；</li>
<li><code>&gt;</code> <code>&gt;=</code> <code>&lt;</code> <code>&lt;=</code> <code>==</code> <code>!=</code> <code>=~</code> <code>!~</code>：<code>=~</code>为正则匹配，<code>!~</code>为正则不匹配；</li>
<li><code>||</code> <code>&amp;&amp;</code>：逻辑或和逻辑与。</li>
</ul>

<p>常量：</p>

<ul>
<li>数字常量，<code>govaluate</code>中将数字都作为 64 位浮点数处理；</li>
<li>字符串常量，注意在<code>govaluate</code>中，字符串用单引号<code>'</code>；</li>
<li>日期时间常量，格式与字符串相同，<strong><code>govaluate</code>会尝试自动解析字符串是否是日期</strong>，只支持 RFC3339、ISO8601等有限的格式；</li>
<li>布尔常量：<code>true</code>、<code>false</code>。</li>
</ul>

<p>其他：</p>

<ul>
<li>圆括号可以改变计算优先级；</li>
<li>数组定义在<code>()</code>中，每个元素之间用<code>,</code>分隔，可以支持任意的元素类型，如<code>(1, 2, 'foo')</code>。实际上在<code>govaluate</code>中数组是用<code>[]interface{}</code>来表示的；</li>
<li>三目运算符：<code>? :</code>。</li>
</ul>

<p>在下面代码中，<code>govaluate</code>会先将<code>2014-01-02</code>和<code>2014-01-01 23:59:59</code>转为<code>time.Time</code>类型，然后再比较大小：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">expr</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">govaluate</span><span class="p">.</span><span class="nf">NewEvaluableExpression</span><span class="p">(</span><span class="s">&#34;&#39;2014-01-02&#39; &gt; &#39;2014-01-01 23:59:59&#39;&#34;</span><span class="p">)</span>
  <span class="nx">result</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">expr</span><span class="p">.</span><span class="nf">Evaluate</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="错误处理">错误处理</h2>

<p>在上面的例子中，我们刻意忽略了错误处理。实际上，<code>govaluate</code>在创建表达式对象和表达式求值这两个操作中都可能产生错误。在生成表达式对象时，如果表达式有语法错误，则返回错误。表达式求值，如果传入的参数不合法，或者某些参数缺失，或者访问结构体中不存在的字段都会报错。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">exprString</span> <span class="o">:=</span> <span class="s">`&gt;&gt;&gt;`</span>
  <span class="nx">expr</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">govaluate</span><span class="p">.</span><span class="nf">NewEvaluableExpression</span><span class="p">(</span><span class="nx">exprString</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;syntax error:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">expr</span><span class="p">.</span><span class="nf">Evaluate</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;evaluate error:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>我们可以依次修改表达式字符串，验证各种错误，首先是<code>&gt;&gt;&gt;</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="mi">2020</span><span class="o">/</span><span class="mo">04</span><span class="o">/</span><span class="mo">01</span> <span class="mi">22</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">59</span> <span class="nx">syntax</span> <span class="kt">error</span><span class="p">:</span><span class="nx">Invalid</span> <span class="nx">token</span><span class="p">:</span> <span class="err">&#39;</span><span class="o">&gt;&gt;</span><span class="p">&gt;</span><span class="err">&#39;</span></code></pre></td></tr></table>
</div>
</div>
<p>然后我们将其修改为<code>foo &gt; 0</code>，但是我们没有传入参数<code>foo</code>，执行失败：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="mi">2020</span><span class="o">/</span><span class="mo">04</span><span class="o">/</span><span class="mo">01</span> <span class="mi">22</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mo">07</span> <span class="nx">evaluate</span> <span class="kt">error</span><span class="p">:</span><span class="nx">No</span> <span class="nx">parameter</span> <span class="err">&#39;</span><span class="nx">foo</span><span class="err">&#39;</span> <span class="nx">found</span><span class="p">.</span></code></pre></td></tr></table>
</div>
</div>
<p>其他错误可以自行验证。</p>

<h2 id="总结">总结</h2>

<p><code>govaluate</code>虽然支持的操作和类型有限，也能实现比较有意思的功能。例如，可以写一个 Web 服务，由用户自己编写表达式，设置参数，服务器算出结果。</p>

<p>大家如果发现好玩、好用的 Go 语言库，欢迎到 Go 每日一库 GitHub 上提交 issue😄</p>

<h2 id="参考">参考</h2>

<ol>
<li>govaluate GitHub：<a href="https://github.com/Knetic/govaluate">https://github.com/Knetic/govaluate</a></li>
<li>Go 每日一库 GitHub：<a href="https://github.com/darjun/go-daily-lib">https://github.com/darjun/go-daily-lib</a></li>
</ol>

<h2 id="我">我</h2>

<p>我的博客：<a href="https://darjun.github.io">https://darjun.github.io</a></p>

<p>欢迎关注我的微信公众号【GoUpUp】，共同学习，一起进步~</p>

<p><img src="/img/wxgzh8.jpg#center" alt="" /></p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">darjun</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
      2020-04-01
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          
        </div>

      
      <nav class="post-nav">
        
        
          <a class="next" href="/2020/03/25/godailylib/jj/">
            <span class="next-text nav-default">Go 每日一库之 jj</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "darjun/blog-comments"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  <div class="disqus-comment">
  <div class="disqus-button" id="load_disqus" onclick="load_disqus()">
    显示 Disqus 评论
  </div>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
      this.page.url = "https://darjun.github.io/2020/04/01/godailylib/govaluate/";
    };
    function load_disqus() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'https-maiyang-me';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);

      $('#load_disqus').remove();
    };
  </script>
  <noscript>Please enable JavaScript to view the
    <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
  </noscript>
  
  </div>

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:leedarjun@gmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/darjun" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>


<a href="https://darjun.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2018 -
    2020
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        大俊
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.dee43230127a73d039a734510fa896c89c3c7ce0cf0be0c7a7433f8fd69b76dc.js" integrity="sha256-3uQyMBJ6c9A5pzRRD6iWyJw8fODPC&#43;DHp0M/j9abdtw=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>












</body>
</html>
