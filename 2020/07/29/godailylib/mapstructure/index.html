<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Go 每日一库之 mapstructure - 大俊的博客</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="darjun" />
  <meta name="description" content="简介 mapstructure用于将通用的map[string]interface{}解码到对应的 Go 结构体中，或者执行相反的操作。很多时候，解" />

  <meta name="keywords" content="大俊, 大俊的博客, go, golang, gopher" />






<meta name="generator" content="Hugo 0.60.0-DEV" />


<link rel="canonical" href="https://darjun.github.io/2020/07/29/godailylib/mapstructure/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.0995afa14b62cd93e93cfc066b646c4c17a3eddca0e9d52a1d9dcf5d90aaacd3.css" integrity="sha256-CZWvoUtizZPpPPwGa2RsTBej7dyg6dUqHZ3PXZCqrNM=" media="screen" crossorigin="anonymous">




<link rel="stylesheet" href="/css/custom.css">


<meta property="og:title" content="Go 每日一库之 mapstructure" />
<meta property="og:description" content="简介 mapstructure用于将通用的map[string]interface{}解码到对应的 Go 结构体中，或者执行相反的操作。很多时候，解" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://darjun.github.io/2020/07/29/godailylib/mapstructure/" />
<meta property="article:published_time" content="2020-07-29T05:40:24+00:00" />
<meta property="article:modified_time" content="2020-07-29T05:40:24+00:00" />
<meta itemprop="name" content="Go 每日一库之 mapstructure">
<meta itemprop="description" content="简介 mapstructure用于将通用的map[string]interface{}解码到对应的 Go 结构体中，或者执行相反的操作。很多时候，解">


<meta itemprop="datePublished" content="2020-07-29T05:40:24&#43;00:00" />
<meta itemprop="dateModified" content="2020-07-29T05:40:24&#43;00:00" />
<meta itemprop="wordCount" content="4589">



<meta itemprop="keywords" content="Go 每日一库," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Go 每日一库之 mapstructure"/>
<meta name="twitter:description" content="简介 mapstructure用于将通用的map[string]interface{}解码到对应的 Go 结构体中，或者执行相反的操作。很多时候，解"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-42862533-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">大俊</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/">首页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/post/">归档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/about/">关于我</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/darjun" rel="noopener" target="_blank">
              Github
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      大俊
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/">首页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/post/">归档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://darjun.github.io/about/">关于我</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/darjun" rel="noopener" target="_blank">
              Github
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Go 每日一库之 mapstructure</h1>
      
      <div class="post-meta">
        <time datetime="2020-07-29" class="post-time">
          2020-07-29
        </time>
        <div class="post-category">
            <a href="https://darjun.github.io/categories/go/"> Go </a>
            
          </div>
        <span class="more-meta"> 约 4589 字 </span>
          <span class="more-meta"> 预计阅读 10 分钟 </span>

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#简介">简介</a></li>
<li><a href="#快速使用">快速使用</a></li>
<li><a href="#字段标签">字段标签</a></li>
<li><a href="#内嵌结构">内嵌结构</a></li>
<li><a href="#未映射的值">未映射的值</a></li>
<li><a href="#逆向转换">逆向转换</a></li>
<li><a href="#metadata"><code>Metadata</code></a></li>
<li><a href="#错误处理">错误处理</a>
<ul>
<li><a href="#弱类型输入">弱类型输入</a></li>
</ul></li>
<li><a href="#解码器">解码器</a></li>
<li><a href="#总结">总结</a></li>
<li><a href="#参考">参考</a></li>
<li><a href="#我">我</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      

<h2 id="简介">简介</h2>

<p><a href="https://github.com/mitchellh/mapstructure"><code>mapstructure</code></a>用于将通用的<code>map[string]interface{}</code>解码到对应的 Go 结构体中，或者执行相反的操作。很多时候，解析来自多种源头的数据流时，我们一般事先并不知道他们对应的具体类型。只有读取到一些字段之后才能做出判断。这时，我们可以先使用标准的<code>encoding/json</code>库将数据解码为<code>map[string]interface{}</code>类型，然后根据标识字段利用<code>mapstructure</code>库转为相应的 Go 结构体以便使用。</p>

<h2 id="快速使用">快速使用</h2>

<p>本文代码采用 Go Modules。</p>

<p>首先创建目录并初始化：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-cmd" data-lang="cmd"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cmd" data-lang="cmd">$ mkdir mapstructure <span class="p">&amp;&amp;</span> <span class="k">cd</span> mapstructure

$ go mod init github.com/darjun/go-daily-lib/mapstructure</code></pre></td></tr></table>
</div>
</div>
<p>下载<code>mapstructure</code>库：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-cmd" data-lang="cmd"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cmd" data-lang="cmd">$ go get github.com/mitchellh/mapstructure</code></pre></td></tr></table>
</div>
</div>
<p>使用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
  <span class="s">&#34;encoding/json&#34;</span>
  <span class="s">&#34;fmt&#34;</span>
  <span class="s">&#34;log&#34;</span>

  <span class="s">&#34;github.com/mitchellh/mapstructure&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">Person</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Name</span> <span class="kt">string</span>
  <span class="nx">Age</span>  <span class="kt">int</span>
  <span class="nx">Job</span>  <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Cat</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Name</span>  <span class="kt">string</span>
  <span class="nx">Age</span>   <span class="kt">int</span>
  <span class="nx">Breed</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">datas</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">`
</span><span class="s">    { 
</span><span class="s">      &#34;type&#34;: &#34;person&#34;,
</span><span class="s">      &#34;name&#34;:&#34;dj&#34;,
</span><span class="s">      &#34;age&#34;:18,
</span><span class="s">      &#34;job&#34;: &#34;programmer&#34;
</span><span class="s">    }
</span><span class="s">  `</span><span class="p">,</span>
    <span class="s">`
</span><span class="s">    {
</span><span class="s">      &#34;type&#34;: &#34;cat&#34;,
</span><span class="s">      &#34;name&#34;: &#34;kitty&#34;,
</span><span class="s">      &#34;age&#34;: 1,
</span><span class="s">      &#34;breed&#34;: &#34;Ragdoll&#34;
</span><span class="s">    }
</span><span class="s">  `</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">data</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">datas</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">m</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">data</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">m</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">switch</span> <span class="nx">m</span><span class="p">[</span><span class="s">&#34;type&#34;</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s">&#34;person&#34;</span><span class="p">:</span>
      <span class="kd">var</span> <span class="nx">p</span> <span class="nx">Person</span>
      <span class="nx">mapstructure</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">p</span><span class="p">)</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;person&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>

    <span class="k">case</span> <span class="s">&#34;cat&#34;</span><span class="p">:</span>
      <span class="kd">var</span> <span class="nx">cat</span> <span class="nx">Cat</span>
      <span class="nx">mapstructure</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">cat</span><span class="p">)</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;cat&#34;</span><span class="p">,</span> <span class="nx">cat</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>运行结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-cmd" data-lang="cmd"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cmd" data-lang="cmd">$ go run main.go
person {dj 18 programmer}
cat {kitty 1 Ragdoll}</code></pre></td></tr></table>
</div>
</div>
<p>我们定义了两个结构体<code>Person</code>和<code>Cat</code>，他们的字段有些许不同。现在，我们约定通信的 JSON 串中有一个<code>type</code>字段。当<code>type</code>的值为<code>person</code>时，该 JSON 串表示的是<code>Person</code>类型的数据。当<code>type</code>的值为<code>cat</code>时，该 JSON 串表示的是<code>Cat</code>类型的数据。</p>

<p>上面代码中，我们先用<code>json.Unmarshal</code>将字节流解码为<code>map[string]interface{}</code>类型。然后读取里面的<code>type</code>字段。根据<code>type</code>字段的值，再使用<code>mapstructure.Decode</code>将该 JSON 串分别解码为<code>Person</code>和<code>Cat</code>类型的值，并输出。</p>

<p>实际上，Google Protobuf 通常也使用这种方式。在协议中添加消息 ID 或<strong>全限定消息名</strong>。接收方收到数据后，先读取协议 ID 或<strong>全限定消息名</strong>。然后调用 Protobuf 的解码方法将其解码为对应的<code>Message</code>结构。从这个角度来看，<code>mapstructure</code>也可以用于网络消息解码，<strong>如果你不考虑性能的话</strong>😄。</p>

<h2 id="字段标签">字段标签</h2>

<p>默认情况下，<code>mapstructure</code>使用结构体中字段的名称做这个映射，例如我们的结构体有一个<code>Name</code>字段，<code>mapstructure</code>解码时会在<code>map[string]interface{}</code>中查找键名<code>name</code>。注意，这里的<code>name</code>是大小写不敏感的！</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">type</span> <span class="nx">Person</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Name</span> <span class="kt">string</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>当然，我们也可以指定映射的字段名。为了做到这一点，我们需要为字段设置<code>mapstructure</code>标签。例如下面使用<code>username</code>代替上例中的<code>name</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">type</span> <span class="nx">Person</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Name</span> <span class="kt">string</span> <span class="s">`mapstructure:&#34;username&#34;`</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>看示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">type</span> <span class="nx">Person</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Name</span> <span class="kt">string</span> <span class="s">`mapstructure:&#34;username&#34;`</span>
  <span class="nx">Age</span>  <span class="kt">int</span>
  <span class="nx">Job</span>  <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Cat</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Name</span>  <span class="kt">string</span>
  <span class="nx">Age</span>   <span class="kt">int</span>
  <span class="nx">Breed</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">datas</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">`
</span><span class="s">    { 
</span><span class="s">      &#34;type&#34;: &#34;person&#34;,
</span><span class="s">      &#34;username&#34;:&#34;dj&#34;,
</span><span class="s">      &#34;age&#34;:18,
</span><span class="s">      &#34;job&#34;: &#34;programmer&#34;
</span><span class="s">    }
</span><span class="s">  `</span><span class="p">,</span>
    <span class="s">`
</span><span class="s">    {
</span><span class="s">      &#34;type&#34;: &#34;cat&#34;,
</span><span class="s">      &#34;name&#34;: &#34;kitty&#34;,
</span><span class="s">      &#34;Age&#34;: 1,
</span><span class="s">      &#34;breed&#34;: &#34;Ragdoll&#34;
</span><span class="s">    }
</span><span class="s">  `</span><span class="p">,</span>
    <span class="s">`
</span><span class="s">    {
</span><span class="s">      &#34;type&#34;: &#34;cat&#34;,
</span><span class="s">      &#34;Name&#34;: &#34;rooooose&#34;,
</span><span class="s">      &#34;age&#34;: 2,
</span><span class="s">      &#34;breed&#34;: &#34;shorthair&#34;
</span><span class="s">    }
</span><span class="s">  `</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">data</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">datas</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">m</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">data</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">m</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">switch</span> <span class="nx">m</span><span class="p">[</span><span class="s">&#34;type&#34;</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s">&#34;person&#34;</span><span class="p">:</span>
      <span class="kd">var</span> <span class="nx">p</span> <span class="nx">Person</span>
      <span class="nx">mapstructure</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">p</span><span class="p">)</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;person&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>

    <span class="k">case</span> <span class="s">&#34;cat&#34;</span><span class="p">:</span>
      <span class="kd">var</span> <span class="nx">cat</span> <span class="nx">Cat</span>
      <span class="nx">mapstructure</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">cat</span><span class="p">)</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;cat&#34;</span><span class="p">,</span> <span class="nx">cat</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>上面代码中，我们使用标签<code>mapstructure:&quot;username&quot;</code>将<code>Person</code>的<code>Name</code>字段映射为<code>username</code>，在 JSON 串中我们需要设置<code>username</code>才能正确解析。另外，注意到，我们将第二个 JSON 串中的<code>Age</code>和第三个 JSON 串中的<code>Name</code>首字母大写了，但是并没有影响解码结果。<code>mapstructure</code>处理字段映射是大小写不敏感的。</p>

<h2 id="内嵌结构">内嵌结构</h2>

<p>结构体可以任意嵌套，嵌套的结构被认为是拥有该结构体名字的另一个字段。例如，下面两种<code>Friend</code>的定义方式对于<code>mapstructure</code>是一样的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">type</span> <span class="nx">Person</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Name</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="c1">// 方式一
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Friend</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Person</span>
<span class="p">}</span>

<span class="c1">// 方式二
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Friend</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Person</span> <span class="nx">Person</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>为了正确解码，<code>Person</code>结构的数据要在<code>person</code>键下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span> <span class="p">{</span>
  <span class="s">&#34;person&#34;</span><span class="p">:</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span><span class="s">&#34;name&#34;</span><span class="p">:</span> <span class="s">&#34;dj&#34;</span><span class="p">},</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>我们也可以设置<code>mapstructure:&quot;,squash&quot;</code>将该结构体的字段提到父结构中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">type</span> <span class="nx">Friend</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Person</span> <span class="s">`mapstructure:&#34;,squash&#34;`</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这样只需要这样的 JSON 串，无效嵌套<code>person</code>键：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span>
  <span class="s">&#34;name&#34;</span><span class="p">:</span> <span class="s">&#34;dj&#34;</span><span class="p">,</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>看示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">type</span> <span class="nx">Person</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Name</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Friend1</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Person</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Friend2</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Person</span> <span class="s">`mapstructure:&#34;,squash&#34;`</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">datas</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">`
</span><span class="s">    { 
</span><span class="s">      &#34;type&#34;: &#34;friend1&#34;,
</span><span class="s">      &#34;person&#34;: {
</span><span class="s">        &#34;name&#34;:&#34;dj&#34;
</span><span class="s">      }
</span><span class="s">    }
</span><span class="s">  `</span><span class="p">,</span>
    <span class="s">`
</span><span class="s">    {
</span><span class="s">      &#34;type&#34;: &#34;friend2&#34;,
</span><span class="s">      &#34;name&#34;: &#34;dj2&#34;
</span><span class="s">    }
</span><span class="s">  `</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">data</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">datas</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">m</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">data</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">m</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">switch</span> <span class="nx">m</span><span class="p">[</span><span class="s">&#34;type&#34;</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s">&#34;friend1&#34;</span><span class="p">:</span>
      <span class="kd">var</span> <span class="nx">f1</span> <span class="nx">Friend1</span>
      <span class="nx">mapstructure</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">f1</span><span class="p">)</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;friend1&#34;</span><span class="p">,</span> <span class="nx">f1</span><span class="p">)</span>

    <span class="k">case</span> <span class="s">&#34;friend2&#34;</span><span class="p">:</span>
      <span class="kd">var</span> <span class="nx">f2</span> <span class="nx">Friend2</span>
      <span class="nx">mapstructure</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">f2</span><span class="p">)</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;friend2&#34;</span><span class="p">,</span> <span class="nx">f2</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>注意对比<code>Friend1</code>和<code>Friend2</code>使用的 JSON 串的不同。</p>

<p>另外需要注意一点，如果父结构体中有同名的字段，那么<code>mapstructure</code>会将JSON 中对应的值<strong>同时设置到这两个字段中</strong>，即这两个字段有相同的值。</p>

<h2 id="未映射的值">未映射的值</h2>

<p>如果源数据中有未映射的值（即结构体中无对应的字段），<code>mapstructure</code>默认会忽略它。</p>

<p>我们可以在结构体中定义一个字段，为其设置<code>mapstructure:&quot;,remain&quot;</code>标签。这样未映射的值就会添加到这个字段中。注意，这个字段的类型只能为<code>map[string]interface{}</code>或<code>map[interface{}]interface{}</code>。</p>

<p>看示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">type</span> <span class="nx">Person</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Name</span>  <span class="kt">string</span>
  <span class="nx">Age</span>   <span class="kt">int</span>
  <span class="nx">Job</span>   <span class="kt">string</span>
  <span class="nx">Other</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span> <span class="s">`mapstructure:&#34;,remain&#34;`</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">data</span> <span class="o">:=</span> <span class="s">`
</span><span class="s">    { 
</span><span class="s">      &#34;name&#34;: &#34;dj&#34;,
</span><span class="s">      &#34;age&#34;:18,
</span><span class="s">      &#34;job&#34;:&#34;programmer&#34;,
</span><span class="s">      &#34;height&#34;:&#34;1.8m&#34;,
</span><span class="s">      &#34;handsome&#34;: true
</span><span class="s">    }
</span><span class="s">  `</span>

  <span class="kd">var</span> <span class="nx">m</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span>
  <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">data</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">m</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">p</span> <span class="nx">Person</span>
  <span class="nx">mapstructure</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">p</span><span class="p">)</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;other&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Other</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>上面代码中，我们为结构体定义了一个<code>Other</code>字段，用于保存未映射的键值。输出结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="nx">other</span> <span class="kd">map</span><span class="p">[</span><span class="nx">handsome</span><span class="p">:</span><span class="kc">true</span> <span class="nx">height</span><span class="p">:</span><span class="mf">1.8</span><span class="nx">m</span><span class="p">]</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="逆向转换">逆向转换</h2>

<p>前面我们都是将<code>map[string]interface{}</code>解码到 Go 结构体中。<code>mapstructure</code>当然也可以将 Go 结构体反向解码为<code>map[string]interface{}</code>。在反向解码时，我们可以为某些字段设置<code>mapstructure:&quot;,omitempty&quot;</code>。这样当这些字段为默认值时，就不会出现在结构的<code>map[string]interface{}</code>中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">type</span> <span class="nx">Person</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Name</span> <span class="kt">string</span>
  <span class="nx">Age</span>  <span class="kt">int</span>
  <span class="nx">Job</span>  <span class="kt">string</span> <span class="s">`mapstructure:&#34;,omitempty&#34;`</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">p</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Person</span><span class="p">{</span>
    <span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;dj&#34;</span><span class="p">,</span>
    <span class="nx">Age</span><span class="p">:</span>  <span class="mi">18</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">m</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span>
  <span class="nx">mapstructure</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">m</span><span class="p">)</span>

  <span class="nx">data</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>上面代码中，我们为<code>Job</code>字段设置了<code>mapstructure:&quot;,omitempty&quot;</code>，且对象<code>p</code>的<code>Job</code>字段未设置。运行结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-cmd" data-lang="cmd"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cmd" data-lang="cmd">$ go run main.go 
{<span class="s2">&#34;Age&#34;</span>:18,<span class="s2">&#34;Name&#34;</span>:<span class="s2">&#34;dj&#34;</span>}</code></pre></td></tr></table>
</div>
</div>
<h2 id="metadata"><code>Metadata</code></h2>

<p>解码时会产生一些有用的信息，<code>mapstructure</code>可以使用<code>Metadata</code>收集这些信息。<code>Metadata</code>结构如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="c1">// mapstructure.go
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Metadata</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Keys</span>   <span class="p">[]</span><span class="kt">string</span>
  <span class="nx">Unused</span> <span class="p">[]</span><span class="kt">string</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p><code>Metadata</code>只有两个导出字段：</p>

<ul>
<li><code>Keys</code>：解码成功的键名；</li>
<li><code>Unused</code>：在源数据中存在，但是目标结构中不存在的键名。</li>
</ul>

<p>为了收集这些数据，我们需要使用<code>DecodeMetadata</code>来代替<code>Decode</code>方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">type</span> <span class="nx">Person</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Name</span> <span class="kt">string</span>
  <span class="nx">Age</span>  <span class="kt">int</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">m</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span>
    <span class="s">&#34;name&#34;</span><span class="p">:</span> <span class="s">&#34;dj&#34;</span><span class="p">,</span>
    <span class="s">&#34;age&#34;</span><span class="p">:</span>  <span class="mi">18</span><span class="p">,</span>
    <span class="s">&#34;job&#34;</span><span class="p">:</span>  <span class="s">&#34;programmer&#34;</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">p</span> <span class="nx">Person</span>
  <span class="kd">var</span> <span class="nx">metadata</span> <span class="nx">mapstructure</span><span class="p">.</span><span class="nx">Metadata</span>
  <span class="nx">mapstructure</span><span class="p">.</span><span class="nf">DecodeMetadata</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">metadata</span><span class="p">)</span>

  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;keys:%#v unused:%#v\n&#34;</span><span class="p">,</span> <span class="nx">metadata</span><span class="p">.</span><span class="nx">Keys</span><span class="p">,</span> <span class="nx">metadata</span><span class="p">.</span><span class="nx">Unused</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>先定义一个<code>Metadata</code>结构，传入<code>DecodeMetadata</code>收集解码的信息。运行结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-cmd" data-lang="cmd"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cmd" data-lang="cmd">$ go run main.go 
<span class="k">keys</span>:[]string{<span class="s2">&#34;Name&#34;</span>, <span class="s2">&#34;Age&#34;</span>} unused:[]string{<span class="s2">&#34;job&#34;</span>}</code></pre></td></tr></table>
</div>
</div>
<h2 id="错误处理">错误处理</h2>

<p><code>mapstructure</code>执行转换的过程中不可避免地会产生错误，例如 JSON 中某个键的类型与对应 Go 结构体中的字段类型不一致。<code>Decode/DecodeMetadata</code>会返回这些错误：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">type</span> <span class="nx">Person</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Name</span>   <span class="kt">string</span>
  <span class="nx">Age</span>    <span class="kt">int</span>
  <span class="nx">Emails</span> <span class="p">[]</span><span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">m</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span>
    <span class="s">&#34;name&#34;</span><span class="p">:</span>   <span class="mi">123</span><span class="p">,</span>
    <span class="s">&#34;age&#34;</span><span class="p">:</span>    <span class="s">&#34;bad value&#34;</span><span class="p">,</span>
    <span class="s">&#34;emails&#34;</span><span class="p">:</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">p</span> <span class="nx">Person</span>
  <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mapstructure</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">p</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>上面代码中，结构体中<code>Person</code>中字段<code>Name</code>为<code>string</code>类型，但输入中<code>name</code>为<code>int</code>类型；字段<code>Age</code>为<code>int</code>类型，但输入中<code>age</code>为<code>string</code>类型；字段<code>Emails</code>为<code>[]string</code>类型，但输入中<code>emails</code>为<code>[]int</code>类型。故<code>Decode</code>返回错误。运行结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-cmd" data-lang="cmd"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cmd" data-lang="cmd">$ go run main.go 
5 error(s) decoding:

* &#39;Age&#39; expected type &#39;int&#39;, got unconvertible type &#39;string&#39;
* &#39;Emails[0]&#39; expected type &#39;string&#39;, got unconvertible type &#39;int&#39;
* &#39;Emails[1]&#39; expected type &#39;string&#39;, got unconvertible type &#39;int&#39;
* &#39;Emails[2]&#39; expected type &#39;string&#39;, got unconvertible type &#39;int&#39;
* &#39;Name&#39; expected type &#39;string&#39;, got unconvertible type &#39;int&#39;</code></pre></td></tr></table>
</div>
</div>
<p>从错误信息中很容易看出哪里出错了。</p>

<h3 id="弱类型输入">弱类型输入</h3>

<p>有时候，我们并不想对结构体字段类型和<code>map[string]interface{}</code>的对应键值做强类型一致的校验。这时可以使用<code>WeakDecode/WeakDecodeMetadata</code>方法，它们会尝试做类型转换：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">type</span> <span class="nx">Person</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Name</span>   <span class="kt">string</span>
  <span class="nx">Age</span>    <span class="kt">int</span>
  <span class="nx">Emails</span> <span class="p">[]</span><span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">m</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span>
    <span class="s">&#34;name&#34;</span><span class="p">:</span>   <span class="mi">123</span><span class="p">,</span>
    <span class="s">&#34;age&#34;</span><span class="p">:</span>    <span class="s">&#34;18&#34;</span><span class="p">,</span>
    <span class="s">&#34;emails&#34;</span><span class="p">:</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">p</span> <span class="nx">Person</span>
  <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mapstructure</span><span class="p">.</span><span class="nf">WeakDecode</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">p</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;person:&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>虽然键<code>name</code>对应的值<code>123</code>是<code>int</code>类型，但是在<code>WeakDecode</code>中会将其转换为<code>string</code>类型以匹配<code>Person.Name</code>字段的类型。同样的，<code>age</code>的值<code>&quot;18&quot;</code>是<code>string</code>类型，在<code>WeakDecode</code>中会将其转换为<code>int</code>类型以匹配<code>Person.Age</code>字段的类型。
需要注意一点，如果类型转换失败了，<code>WeakDecode</code>同样会返回错误。例如将上例中的<code>age</code>设置为<code>&quot;bad value&quot;</code>，它就不能转为<code>int</code>类型，故而返回错误。</p>

<h2 id="解码器">解码器</h2>

<p>除了上面介绍的方法外，<code>mapstructure</code>还提供了更灵活的解码器（<code>Decoder</code>）。可以通过配置<code>DecoderConfig</code>实现上面介绍的任何功能：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="c1">// mapstructure.go
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">DecoderConfig</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">ErrorUnused</span>       <span class="kt">bool</span>
	<span class="nx">ZeroFields</span>        <span class="kt">bool</span>
	<span class="nx">WeaklyTypedInput</span>  <span class="kt">bool</span>
	<span class="nx">Metadata</span>          <span class="o">*</span><span class="nx">Metadata</span>
	<span class="nx">Result</span>            <span class="kd">interface</span><span class="p">{}</span>
	<span class="nx">TagName</span>           <span class="kt">string</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>各个字段含义如下：</p>

<ul>
<li><code>ErrorUnused</code>：为<code>true</code>时，如果输入中的键值没有与之对应的字段就返回错误；</li>
<li><code>ZeroFields</code>：为<code>true</code>时，在<code>Decode</code>前清空目标<code>map</code>。为<code>false</code>时，则执行的是<code>map</code>的合并。用在<code>struct</code>到<code>map</code>的转换中；</li>
<li><code>WeaklyTypedInput</code>：实现<code>WeakDecode/WeakDecodeMetadata</code>的功能；</li>
<li><code>Metadata</code>：不为<code>nil</code>时，收集<code>Metadata</code>数据；</li>
<li><code>Result</code>：为结果对象，在<code>map</code>到<code>struct</code>的转换中，<code>Result</code>为<code>struct</code>类型。在<code>struct</code>到<code>map</code>的转换中，<code>Result</code>为<code>map</code>类型；</li>
<li><code>TagName</code>：默认使用<code>mapstructure</code>作为结构体的标签名，可以通过该字段设置。</li>
</ul>

<p>看示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">type</span> <span class="nx">Person</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Name</span> <span class="kt">string</span>
  <span class="nx">Age</span>  <span class="kt">int</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">m</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span>
    <span class="s">&#34;name&#34;</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span>
    <span class="s">&#34;age&#34;</span><span class="p">:</span>  <span class="s">&#34;18&#34;</span><span class="p">,</span>
    <span class="s">&#34;job&#34;</span><span class="p">:</span>  <span class="s">&#34;programmer&#34;</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">p</span> <span class="nx">Person</span>
  <span class="kd">var</span> <span class="nx">metadata</span> <span class="nx">mapstructure</span><span class="p">.</span><span class="nx">Metadata</span>

  <span class="nx">decoder</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mapstructure</span><span class="p">.</span><span class="nf">NewDecoder</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">mapstructure</span><span class="p">.</span><span class="nx">DecoderConfig</span><span class="p">{</span>
    <span class="nx">WeaklyTypedInput</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nx">Result</span><span class="p">:</span>           <span class="o">&amp;</span><span class="nx">p</span><span class="p">,</span>
    <span class="nx">Metadata</span><span class="p">:</span>         <span class="o">&amp;</span><span class="nx">metadata</span><span class="p">,</span>
  <span class="p">})</span>

  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">err</span> <span class="p">=</span> <span class="nx">decoder</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;person:&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;keys:%#v, unused:%#v\n&#34;</span><span class="p">,</span> <span class="nx">metadata</span><span class="p">.</span><span class="nx">Keys</span><span class="p">,</span> <span class="nx">metadata</span><span class="p">.</span><span class="nx">Unused</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这里用<code>Decoder</code>的方式实现了前面弱类型输入小节中的示例代码。实际上<code>WeakDecode</code>内部就是通过这种方式实现的，下面是<code>WeakDecode</code>的源码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-golang" data-lang="golang"><span class="c1">// mapstructure.go
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">WeakDecode</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">output</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="nx">config</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">DecoderConfig</span><span class="p">{</span>
    <span class="nx">Metadata</span><span class="p">:</span>         <span class="kc">nil</span><span class="p">,</span>
    <span class="nx">Result</span><span class="p">:</span>           <span class="nx">output</span><span class="p">,</span>
    <span class="nx">WeaklyTypedInput</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="nx">decoder</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewDecoder</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">err</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">decoder</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>再实际上，<code>Decode/DecodeMetadata/WeakDecodeMetadata</code>内部都是先设置<code>DecoderConfig</code>的对应字段，然后创建<code>Decoder</code>对象，最后调用其<code>Decode</code>方法实现的。</p>

<h2 id="总结">总结</h2>

<p><code>mapstructure</code>实现优雅，功能丰富，代码结构清晰，非常推荐一看！</p>

<p>大家如果发现好玩、好用的 Go 语言库，欢迎到 Go 每日一库 GitHub 上提交 issue😄</p>

<h2 id="参考">参考</h2>

<ol>
<li>mapstructure GitHub：<a href="https://github.com/mitchellh/mapstructure">https://github.com/mitchellh/mapstructure</a></li>
<li>Go 每日一库 GitHub：<a href="https://github.com/darjun/go-daily-lib">https://github.com/darjun/go-daily-lib</a></li>
</ol>

<h2 id="我">我</h2>

<p>我的博客：<a href="https://darjun.github.io">https://darjun.github.io</a></p>

<p>欢迎关注我的微信公众号【GoUpUp】，共同学习，一起进步~</p>

<p><img src="/img/wxgzh8.jpg#center" alt="" /></p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">darjun</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
      2020-07-29
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          
        </div>

      
      <nav class="post-nav">
        
        
          <a class="next" href="/2020/06/25/godailylib/cron/">
            <span class="next-text nav-default">Go 每日一库之 cron</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "darjun/blog-comments"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:leedarjun@gmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/darjun" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>


<a href="https://darjun.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2018 -
    2020
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        大俊
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.dee43230127a73d039a734510fa896c89c3c7ce0cf0be0c7a7433f8fd69b76dc.js" integrity="sha256-3uQyMBJ6c9A5pzRRD6iWyJw8fODPC&#43;DHp0M/j9abdtw=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>












</body>
</html>
